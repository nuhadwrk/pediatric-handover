<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Pediatric Handover System</title>
  <meta name="viewport" content="width=960, user-scalable=yes">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="180x180" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2a9d8f">

  <!-- Firebase - Required immediately for app to function -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- FileSaver - Small utility, keep loaded -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

  <!-- LAZY LOADED LIBRARIES - Loaded on-demand to improve initial load time:
       - Chart.js: Loaded when opening Labs tab
       - PDF-lib: Loaded when printing
       - docxtemplater/PizZip: Loaded when opening Discharge Center
       - browser-image-compression: Loaded when uploading images
  -->

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
      --bg: #f4f7fb; --primary: #0066cc; --primary-dark: #004a99; --accent: #2a9d8f; --text: #1d3557;
      --card-bg: #ffffff; --shadow: 0 3.8px 11.4px rgba(0,0,0,0.08); --border: #aaa;
      --editable-border: #ccc; --editable-focus: #888;
      --PW: #d1e7ff; --GW: #fde2e4; --SW: #e2f0cb; --PVT: #fff3cd; --ICU: #d4edda; --NICU: #f8d7da; --ER: #f5f5f5; --Discharge: #e2e3e5;
      --new-btn: #f6a623; --discharge-btn: #28a745;
      --panel-width: 437px; --panel-height: 342px;
    }
    [data-theme="dark"] {
      --bg: #1a202c; --primary: #4299e1; --primary-dark: #2b6cb0; --accent: #38b2ac; --text: #e2e8f0;
      --card-bg: #2d3748; --shadow: 0 3.8px 11.4px rgba(0,0,0,0.3); --border: #4a5568;
      --editable-border: #718096; --editable-focus: #a0aec0;
      --PW: #2c5282; --GW: #9b2c2c; --SW: #5a7f3f; --PVT: #b7791f; --ICU: #276749; --NICU: #9b2c2c; --ER: #4a5568; --Discharge: #3f3f46;
      --new-btn: #f6a623; --discharge-btn: #28a745;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; padding: 22.8px; background: var(--bg); color: var(--text); -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    h1 { margin: 0 0 22.8px; text-align: center; font-weight: 700; font-size: 28.5px; }
    
    .top-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 7.6px; margin-bottom: 15.2px; align-items: stretch; }
    .top-buttons button, .dropdown-btn, .theme-toggle { 
        padding: 9.5px 19px; font-weight: 600; border: none; border-radius: 7.6px; 
        cursor: pointer; transition: background 0.2s, transform 0.2s; font-size: 15.2px; 
        display: inline-flex; align-items: center; justify-content: center; 
        height: 42px; box-sizing: border-box; vertical-align: middle;
    }
    .top-buttons button:hover, .dropdown:hover .dropdown-btn { transform: translateY(-1.9px); }
    .add { background: var(--primary); color: #fff; }
    .btn-green { background: #28a745; color: #fff; }
    .btn-teal { background: #17a2b8; color: #fff; }
    .btn-teal:hover { background: #138496; }

    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { background: var(--accent); color: #fff; }
    .dropdown-content { display: none; position: absolute; background-color: var(--card-bg); min-width: 160px; box-shadow: var(--shadow); z-index: 100; border-radius: 7.6px; overflow: hidden; border: 1px solid var(--border); }
    .dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; cursor: pointer; }
    .dropdown-content a:hover { background-color: var(--bg); }
    .dropdown:hover .dropdown-content { display: block; }
    .theme-toggle { background: #6b7280; color: #fff; font-size: 17.1px; width: 42px; padding: 0; }
    .theme-toggle::before { content: '‚òÄ'; }
    [data-theme="dark"] .theme-toggle::before { content: 'üåô'; }
    
    .top-panel { display: flex; gap: 15.2px; align-items: stretch; justify-content: center; margin: 0 auto 22.8px; max-width: 100%; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 3.8px; }
    .panel-card { background: var(--card-bg); padding: 17.1px; border-radius: 11.4px; box-shadow: var(--shadow); width: var(--panel-width); height: var(--panel-height); flex: 0 0 var(--panel-width); }
    #handoverHeader table { margin: 15.2px 0 0 0; border-collapse: collapse; width: 100%; }
    #handoverHeader th, #handoverHeader td { border: none; padding: 5.7px; font-size: 14.3px; vertical-align: top; }
    #handoverHeader th { background: var(--bg); }
    #handoverHeader input { width: 57px; padding: 3.8px; border: 0.95px solid var(--border); border-radius: 3.8px; text-align: center; background: var(--card-bg); color: var(--text); font-size: 14.3px; }
    #notesText { width: 100%; min-height: 171px; padding: 9.5px; border-radius: 7.6px; border: 0.95px solid var(--border); background: var(--bg); color: var(--text); resize: vertical; font-size: 14.3px; }
    
    .form-section { display: none; background: var(--card-bg); padding: 22.8px; border-radius: 11.4px; max-width: 494px; margin: 0 auto 30.4px; box-shadow: var(--shadow); }
    .form-section input, .form-section select, .form-section textarea { width: 100%; margin: 5.7px 0 11.4px; padding: 9.5px; border: none; border-radius: 7.6px; font-size: 14.3px; background: var(--bg); color: var(--text); }
    .form-section textarea { min-height: 95px; resize: vertical; }
    .form-section button { width: 100%; padding: 11.4px; background: var(--primary); color: #fff; border: none; border-radius: 7.6px; font-weight: 600; font-size: 14.3px; }
    
    #form-age-toggle { display: block !important; margin-bottom: 10px; }
    .age-toggle { background: var(--card-bg); padding: 7.6px; border-radius: 3.8px; margin-top: 3.8px; border: 0.95px solid var(--border); display: none; text-align: left; font-size: 15px; }
    .age-toggle label { font-size: 12.4px; margin: 0 7.6px 0 0; gap: 3.8px; display: inline-flex; align-items: center; }
    .age-toggle input[type="radio"] { width: auto; margin: 0 4px 0 0; }
    .auto-age-inputs { display: flex; gap: 7.6px; margin-top: 3.8px; }
    .auto-age-inputs input { padding: 5.7px; border: 0.95px solid var(--editable-border); border-radius: 3.8px; background: var(--bg); color: var(--text); width: 100%; font-size: 14.3px; margin: 0; }
    .new-checkbox { margin-top: 7.6px; text-align: left; }
    .new-checkbox label { display: inline-flex; align-items: center; font-size: 15px; }
    .new-checkbox input { width: auto; margin-right: 5px; }
    
    .ward-header { text-align: center; font-size: 19px; font-weight: 600; margin: 30.4px 0 7.6px; padding: 7.6px; border-radius: 7.6px; }
    .ward-header.discharge-header { cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .ward-header.discharge-header::before { content: '‚ñ∫'; margin-right: 7.6px; font-size: 15.2px; }
    .ward-header.discharge-header.expanded::before { content: '‚ñº'; }
    
    .card-grid { display: flex; flex-wrap: wrap; gap: 15.2px; justify-content: flex-start; }
    #ward-Discharge.card-grid { display: none; }
    #ward-Discharge.card-grid.expanded { display: flex; }
    
    /* WIDTH RESTORED FOR 3-COLUMN LAYOUT */
    .patient-card { background: var(--card-bg); padding: 17.1px; border-radius: 11.4px; box-shadow: var(--shadow); position: relative; transition: transform 0.18s; padding-top: 50px; font-size: 15px; width: 285px; }
    .patient-card:hover { transform: scale(1.015); }
    .patient-card p { margin: 3.8px 0; font-size: 15px; }
    .patient-card p strong { font-weight: 700; font-size: 15px; }
    
    .card-ctrl { position: absolute; top: 10px; height: 26px; border-radius: 3.8px; display: flex; align-items: center; justify-content: center; font-size: 12.4px; z-index: 10; font-weight: 600; }
    .delete-btn { right: 9.5px; border: none; cursor: pointer; opacity: 0.7; background: #e63946; color: #fff; padding: 0 8px; min-width: 26px; }
    .new-badge { right: 42px; background: var(--new-btn); color: #fff; padding: 0 8px; display: none; opacity: 0.7; }
    .new-badge.new-active { display: flex; }
    .discharge-badge { left: 45px; background: var(--discharge-btn); color: #fff; padding: 0 8px; display: none; opacity: 0.9; }
    .discharge-badge.discharge-active { display: flex !important; }
    .expand-btn { left: 9.5px; background: var(--accent); color: #fff; border: none; width: 28px; cursor: pointer; font-size: 16px; opacity: 0.5; transition: opacity 0.2s; }
    .expand-btn:hover { opacity: 1; }
    
    .editable { border: none; background: transparent; border-bottom: 0.95px dashed var(--editable-border); padding: 0 3.8px; min-width: 19px; white-space: pre-wrap; font-size: 15px; display: inline; }
    .editable:focus { outline: none; border-bottom: 0.95px solid var(--editable-focus); }
    
    .patient-card p .editable[id^="new-plan-"] {
        display: block; 
        width: 100%; 
        min-height: 20px;
    }

    /* ARROW & EXPANSION STYLES */
    .hopi-toggle { cursor: pointer; color: var(--text); font-weight: 600; margin: 3.8px 0; font-size: 15px; display: inline-flex; align-items: center; }
    .hopi-toggle::after { content: '‚ñ∫'; margin-left: 5px; font-size: 12px; transition: transform 0.2s; display: inline-block; }
    .hopi-toggle.expanded::after { transform: rotate(90deg); }

    .hopi-content { display: none; color: var(--text); font-size: 15px; }
    .hopi-content.expanded { display: block; }
    
    .inline-fields { display: flex; gap: 7.6px; align-items: baseline; }
    .inline-fields strong { flex-shrink: 0; font-size: 15px; }
    
    /* LOGGING & HISTORY STYLES */
    .log-btn { padding: 5.7px 11.4px; border: none; border-radius: 3.8px; cursor: pointer; color: #fff; margin: 7.6px 0; font-size: 15px; transition: background-color 0.2s; }
    .log-btn:disabled { cursor: not-allowed; background: #6c757d !important; color: #eee; opacity: 0.6; }
    .log-btn:not(:disabled) { background: #28a745; }
    
    .current-plan-label { font-weight: 600; margin-top: 7.6px; display: block; font-size: 15px; }

    /* HISTORY LIST STYLES */
    .patient-card .history-list { margin: 5px 0; padding: 0 0 0 4px; list-style: none; }
    
    .patient-card .history-item { 
        padding-left: 12px; margin-bottom: 8px; border-left: 2px solid var(--border); 
        position: relative; 
    }
    .patient-card .history-item::before { 
        content: ''; position: absolute; left: -4px; top: 6px; 
        width: 6px; height: 6px; border-radius: 50%; background: var(--primary); 
    }
    .patient-card .history-date { font-size: 11px; opacity: 0.8; font-weight: 700; color: var(--primary); }
    .patient-card .history-text { font-size: 15px; line-height: 1.4; white-space: pre-wrap; }
    
    .recent-logs-container { margin: 8px 0; max-height: 200px; overflow-y: auto; padding-left: 4px; transition: opacity 0.2s; }
    
    /* SCROLLBAR HIDING */
    .recent-logs-container::-webkit-scrollbar, .hopi-content::-webkit-scrollbar { width: 6px; background: transparent; }
    .recent-logs-container::-webkit-scrollbar-thumb, .hopi-content::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 3px; visibility: hidden; }
    .recent-logs-container:hover::-webkit-scrollbar-thumb, .hopi-content:hover::-webkit-scrollbar-thumb { visibility: visible; }

    /* EDIT & DELETE STYLES FOR LOGS */
    .edit-history-link { font-size: 12px; color: var(--primary); cursor: pointer; margin-left: auto; margin-right: 10px; font-weight: 600; }
    .edit-history-link:hover { text-decoration: underline; }

    .history-text[contenteditable="true"]:hover,
    .history-text[contenteditable="true"]:focus {
        background-color: rgba(0, 0, 0, 0.03);
        outline: none;
        border-radius: 4px;
    }
    
    .log-delete-btn {
        position: absolute; right: 0; top: 0; color: #e63946; font-weight: bold; cursor: pointer;
        font-size: 16px; padding: 2px 8px; opacity: 0.4; transition: opacity 0.2s; z-index: 10;
        display: none;
    }
    .history-list.editing-mode .log-delete-btn { display: block; }
    .log-delete-btn:hover { opacity: 1; background-color: rgba(230, 57, 70, 0.1); border-radius: 4px; }
    .history-item.editable-item { padding-right: 25px; }

    /* MODAL STYLES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--card-bg); width: 95%; max-width: 1000px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); border-radius: 12px 12px 0 0; flex-shrink: 0; flex-wrap: wrap; gap: 10px; }
    .modal-header h2 { margin: 0; font-size: 20px; }
    .close-modal { background: none; border: none; font-size: 32px; color: var(--text); cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--card-bg); padding: 0 20px; overflow-x: auto; flex-shrink: 0; }
    .tab-btn { padding: 12px 20px; background: none; border: none; font-weight: 600; color: var(--text); opacity: 0.6; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; font-size: 14px; }
    .tab-btn.active { opacity: 1; border-bottom-color: var(--primary); color: var(--primary); }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .sleek-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 10px; }
    .sleek-row { margin-bottom: 15px; }
    .sleek-label { font-size: 12px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .sleek-input { font-size: 14px; color: var(--text); background: transparent; border-bottom: none; width: 100%; display: block; padding-bottom: 2px; min-height: 20px; outline: none; word-wrap: break-word; line-height: 1.5; }
    .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .lab-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .lab-table th, .lab-table td { border: 1px solid var(--border); padding: 8px; text-align: center; min-width: 80px; }
    .lab-table th { background: var(--bg); font-weight: 600; }
    .lab-table input { width: 100%; border: none; background: transparent; text-align: center; color: var(--text); font-family: 'Inter', sans-serif; }
    .chart-container { height: 300px; margin-top: 20px; border: 1px solid var(--border); padding: 10px; border-radius: 8px; }
    .img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .img-card { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; border: 1px solid var(--border); background: #000; }
    .img-card img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
    .img-card img:hover { transform: scale(1.05); }
    .img-caption { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 11px; text-align: center; }
    .img-delete { position: absolute; top: 5px; right: 5px; background: #e63946; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .lightbox { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
    .lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 90vh; }
    .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
    .history-list { list-style: none; padding: 0; margin: 15px 0; }
    .history-item { border-left: 2px solid var(--border); padding-left: 15px; margin-bottom: 20px; position: relative; }
    .history-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: var(--primary); }
    .history-date { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .history-text { white-space: pre-wrap; font-size: 14px; }
    .btn-sm { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; background: var(--primary); color: white; font-size: 12px; font-weight: 600; white-space: nowrap; }
    .form-control { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }

    /* ADMISSION SYSTEM STYLES */
    #admission-system { position: fixed; inset: 0; background: #eaeff5; z-index: 5000; display: none; flex-direction: column; }
    #adm-header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; height: 50px; }
    #adm-body { flex: 1; display: flex; overflow: hidden; position: relative; }
    .adm-sidebar { width: 250px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 15px; transition: transform 0.3s; z-index: 5500; }
    .adm-sidebar-toggle { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary); margin-right: 15px; }
    .mode-card { border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; background: #f8f9fa; }
    .mode-card.active { background: var(--primary); color: white; border-color: var(--primary); }
    .adm-viewport { flex: 1; position: relative; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; }
    
    /* Shared style for both Detail boxes */
    #adm-std-details, #adm-newborn-details { width: 100%; max-width: 800px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e0e0e0; }
    
    /* Use common form group styles within them */
    #adm-std-details .form-group, #adm-newborn-details .form-group { margin-bottom: 8px; }
    #adm-std-details label, #adm-newborn-details label { font-size: 10px; margin-bottom: 2px; }
    #adm-std-details input, #adm-std-details select, #adm-newborn-details input, #adm-newborn-details select { padding: 4px; height: auto; font-size: 13px; }

    #view-form { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; margin-bottom: 50px; overflow: visible; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 3px; text-transform: uppercase; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .form-group textarea { min-height: 60px; resize: vertical; }
    #view-pdf { width: 100%; display: none; flex-direction: column; align-items: center; }
    #pdf-stage { margin-bottom: 80px; position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }

    #view-newborn-visual { width: 100%; display: none; flex-direction: column; align-items: center; }
    #nb-visual-stage { margin-bottom: 80px; width: 100%; display: flex; flex-direction: column; align-items: center; overflow: hidden; }

    /* PDF BOXES */
    /* Make sure the stage is centered */
    #pdf-stage {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: flex-start !important;
      width: 100% !important;
      padding: 20px 10px !important;
      box-sizing: border-box !important;
      overflow: hidden;
    }

    /* Each page wrapper ‚Äî ensure centering */
    .pdf-page {
      margin: 20px auto !important;
      display: block !important;
      box-sizing: border-box !important;
      transform-origin: top center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      background-color: white;
    }

    .pdf-box { position: absolute; background: rgba(60, 130, 246, 0.05); border: 1px dashed rgba(60, 130, 246, 0.3); font-family: Helvetica, sans-serif; overflow: hidden; color: #000; line-height: 1.3; padding: 2px; text-rendering: geometricPrecision; -webkit-font-smoothing: antialiased; transform: translateZ(0); }
    .pdf-box:focus { background: rgba(255, 255, 255, 0.9); border: 2px solid var(--primary); outline: none; z-index: 10; }

    /* Optional: prevent any left shift from flex or float */
    .adm-viewport {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      padding: 20px !important;
    }

    /* Newborn Visual Mode Controls */
    .nb-pdf-select, .nb-pdf-datetime, .nb-pdf-number, .nb-pdf-text, .nb-pdf-datalist { position: absolute; font-family: Helvetica, sans-serif; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(60, 130, 246, 0.4); color: #000; padding: 2px; box-sizing: border-box; }
    .nb-pdf-select:focus, .nb-pdf-datetime:focus, .nb-pdf-number:focus, .nb-pdf-text:focus, .nb-pdf-datalist:focus { background: rgba(255, 255, 255, 1); border: 2px solid var(--primary); outline: none; z-index: 10; }
    .nb-pdf-checkbox { position: absolute; background: rgba(255, 255, 200, 0.3); border: 1px solid rgba(255, 200, 0, 0.4); font-family: Helvetica, sans-serif; color: #000; }

    .warning-text { color: #d32f2f; font-size: 12px; margin-top: 4px; display: none; font-weight: bold; }

    #adm-toolbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 8px 20px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center; z-index: 6000; border: 1px solid #ddd; }
    .tool-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: 600; font-size: 13px; }
    .tool-btn.primary { background: var(--primary); color: white; border: none; }
    
    body.is-mobile .adm-sidebar { position: absolute; top: 0; left: 0; bottom: 0; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
    body.is-mobile .adm-sidebar.show { transform: translateX(0); }
    body.is-mobile .adm-sidebar-toggle { display: block; }

    /* CSS FIX: Show dropdown arrow on inputs with list */
    input::-webkit-calendar-picker-indicator { opacity: 100; }

/* NEW: NEWBORN LAYOUT - MATCHING PATIENT ID WIDTH */
    .nb-two-column {
       display: grid;
       grid-template-columns: 1fr 1fr; /* Split: 50% Left, 50% Right */
       gap: 15px;
       align-items: start;
       width: 100%;
       max-width: 800px; /* Matches the 'Patient Details' box width */
       margin: 0 auto;   /* Centers the whole block */
    }

    /* Helper classes for the internal columns */
    .nb-col {
        display: flex;
        flex-direction: column;
        gap: 15px; /* Space between vertical boxes */
    }

    /* Bottom section spans full width */
    .nb-bottom-span {
        grid-column: 1 / -1; 
        width: 100%;
    }

    /* Mobile: Stack everything vertically */
    @media (max-width: 768px) {
       .nb-two-column { grid-template-columns: 1fr !important; } 
    }

    /* DISCHARGE CENTER STYLES */
    #discharge-system { position: fixed; inset: 0; background: #eaeff5; z-index: 5000; display: none; flex-direction: column; }
    #dc-header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; min-height: 60px; flex-wrap: wrap; }
    .dc-selector { font-size: 16px; padding: 5px; min-width: 300px; }
    .dc-header-content { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex: 1; }
    .dc-selects { display: flex; gap: 10px; flex-wrap: wrap; }
    .dc-buttons { display: flex; gap: 5px; }
    .dc-close-btn { display: flex; gap: 10px; }

    #dc-body { flex: 1; display: flex; overflow: hidden; position: relative; }
    .dc-split-view { display: flex; width: 100%; height: 100%; }

    /* Left Pane: The Form */
    .dc-form-pane { flex: 6; overflow-y: auto; padding: 20px; background: #fff; border-right: 2px solid #ccc; }
    .dc-paper { background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 850px; margin: 0 auto; }

    /* Right Pane: History */
    .dc-history-pane { flex: 4; overflow-y: auto; padding: 20px; background: #f4f7fb; }
    
    /* REUSED CLASSES FROM MODAL for consistency */
    .dc-history-item { 
        padding-left: 15px; margin-bottom: 20px; border-left: 2px solid var(--border); 
        position: relative; 
    }
    .dc-history-item::before { 
        content: ''; position: absolute; left: -5px; top: 0; 
        width: 8px; height: 8px; border-radius: 50%; background: var(--primary); 
    }
    .dc-history-date { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .dc-history-text { white-space: pre-wrap; font-size: 14px; }

    /* SCOPED STYLES FOR DC TEMPLATE */
    #dc-form-container * { margin: 0; padding: 0; text-indent: 0; }
    #dc-form-container .label-text { font-family: "Times New Roman", serif; font-size: 11pt; font-weight: normal; color: black; }
    #dc-form-container .s5 { font-family: Cambria, serif; font-size: 11pt; color: black; }
    #dc-form-container .s6 { font-family: "Times New Roman", serif; font-weight: bold; font-size: 11pt; color: black; }
    #dc-form-container h1.dc-title { font-family: "Times New Roman", serif; font-weight: bold; text-decoration: underline; font-size: 14pt; text-align: center; margin: 10px 0; color: black; }
    
    #dc-form-container table { width: 100%; border-collapse: collapse; font-family: "Times New Roman", serif; table-layout: fixed; }
    #dc-form-container td { border: 1px solid black !important; padding: 2px; vertical-align: top; }
    #dc-form-container textarea { width: 100%; border: none; font-family: "Times New Roman", serif; font-size: 11pt; resize: both; overflow: hidden; min-height: 25px; background: transparent; padding: 0; display: block; vertical-align: top; }
    
    /* SLEEK BUTTON STYLE for DC Download & Reset */
    .btn-sleek { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #17a2b8; color: white; border: none; cursor: pointer; transition: transform 0.1s; }
    .btn-sleek:hover { transform: scale(1.05); }

    /* Orange Reset Button Variant */
    .btn-sleek.btn-warn { background: #f0ad4e; color: white; }
    .btn-sleek.btn-warn:hover { background: #ec971f; }

    @media (max-width: 900px) {
       .modal-header { display: flex; flex-wrap: wrap; }
       .modal-header h2 { width: 100%; margin-bottom: 10px; }
       .modal-header button.btn-sm { margin-left: 0 !important; }
       .nb-two-column { grid-template-columns: 1fr; }
    }

    /* MEDIA QUERY FOR ADM SIDEBAR ON ALL MOBILE SIZES */
    @media (max-width: 768px) {
        .adm-sidebar { position: absolute; top: 0; left: 0; bottom: 0; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 5500; background: white; }
        .adm-sidebar.show { transform: translateX(0); }
        .adm-sidebar-toggle { display: block; }
    }

    /* Mobile/touch device detection - works even with fixed 960px viewport */
    @media (hover: none) and (pointer: coarse) {
        /* Detail modal - increase font sizes for mobile readability */
        .sleek-input { font-size: 18px; }
        .lab-table { font-size: 16px; }
        .history-text { font-size: 18px; }
        .sleek-label { font-size: 14px; }
        .history-date { font-size: 14px; }
        .modal-header h2 { font-size: 22px; }

        /* Larger, easier to tap close button */
        .close-modal {
            font-size: 32px;
            padding: 10px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Discharge center mobile layout */
        #dc-header { flex-direction: column; align-items: stretch; padding: 10px; position: relative; }
        .dc-header-content { flex-direction: column; align-items: stretch; gap: 10px; padding-right: 50px; }
        #dc-header h2 { font-size: 16px; text-align: center; margin-right: 0; }
        .dc-close-btn { position: absolute; top: 10px; right: 10px; z-index: 10; }
        .dc-selects { flex-direction: column; width: 100%; }
        .dc-selector { min-width: auto; width: 100%; font-size: 14px; }
        .dc-buttons { width: 100%; justify-content: flex-end; }
        .btn-sleek { font-size: 12px; padding: 8px 16px; flex: 1; max-width: 48%; }
        .btn-sleek.btn-warn { margin-left: 0; }
    }

    /* --- Modern Lab Table Styles (Fixed Sizing) --- */
    .lab-action-cell {
        width: 45px;
        min-width: 45px;
        padding: 4px !important;
        vertical-align: middle;
    }

    .lab-toolbar {
        display: flex;
        align-items: center;
        justify-content: center; /* Center the group */
        gap: 2px; /* Consistent spacing */
        background: #f8f9fa;
        border-radius: 6px;
        padding: 2px;
        border: 1px solid #ddd;
        width: fit-content;
        margin: 0 auto; /* Center horizontally in cell */
    }

    .icon-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 12px; /* Smaller font for crisp icons */
        padding: 0;      /* Remove padding to let flex center it */
        border-radius: 4px;
        color: #6c757d;
        transition: all 0.2s;
        
        /* Strict Square Sizing */
        width: 22px !important; 
        height: 22px !important;
        min-width: 22px;
        min-height: 22px;
        
        /* Perfect Centering */
        display: flex; 
        align-items: center; 
        justify-content: center;
        line-height: 1;
    }

    .icon-btn:hover { background-color: #e2e6ea; color: #333; transform: scale(1.1); }

    /* Specific Colors */
    .btn-del-row:hover { background-color: #ffe6e6; color: #dc3545; }
    .btn-add-row:hover { background-color: #e6ffea; color: #28a745; }
    .btn-up:hover, .btn-dn:hover { background-color: #dbeafe; color: #0056b3; }

    /* Column Header Styling */
    .col-header-wrapper {
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: center;
        width: 100%;
    }

    .col-header-wrapper input {
        text-align: center; 
        font-weight: bold; 
        border-bottom: 2px solid var(--primary); 
        padding: 4px;
        width: 100%;
        background: transparent;
        border: none;
        border-bottom: 2px solid var(--primary);
    }

    .btn-del-col {
        font-size: 9px;
        text-transform: uppercase;
        color: #dc3545;
        background: white;
        border: 1px solid #f5c6cb;
        border-radius: 3px;
        cursor: pointer;
        padding: 2px 6px;
        line-height: 1;
        transition: all 0.2s;
    }
    .btn-del-col:hover { background: #dc3545; color: white; border-color: #dc3545; }
  </style>

  <script>
    // === LAZY LOADING UTILITIES ===
    // Track loaded libraries to avoid loading twice
    const loadedLibraries = {};

    // Generic script loader
    function loadScript(url, globalCheck) {
      if (loadedLibraries[url] || (globalCheck && window[globalCheck])) {
        return Promise.resolve();
      }

      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => {
          loadedLibraries[url] = true;
          resolve();
        };
        script.onerror = () => reject(new Error(`Failed to load ${url}`));
        document.head.appendChild(script);
      });
    }

    // Load Chart.js (for labs)
    async function ensureChartJS() {
      if (window.Chart) return;
      await loadScript('https://cdn.jsdelivr.net/npm/chart.js', 'Chart');
    }

    // Load PDF-lib (for printing)
    async function ensurePDFLib() {
      if (window.PDFLib) return;
      await loadScript('https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js', 'PDFLib');
    }

    // Load docx libraries (for discharge center)
    async function ensureDocxLibs() {
      if (window.Docxtemplater && window.PizZip) return;
      await Promise.all([
        loadScript('https://unpkg.com/pizzip@3.1.4/dist/pizzip.js', 'PizZip'),
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js', 'Docxtemplater')
      ]);
    }

    // Load image compression (for image upload)
    async function ensureImageCompression() {
      if (window.imageCompression) return;
      await loadScript('https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js', 'imageCompression');
    }
  </script>
</head>
<body>
  <h1>Pediatric Handover</h1>
  
  <div class="top-buttons">
    <button class="add" onclick="toggleForm()">Add Patient</button>
    <button class="btn-green" onclick="launchAdmissionSystem(true)">Admission</button>
    <button class="btn-teal" onclick="launchDischargeSystem()">DC</button>
    <div class="dropdown">
  <button class="dropdown-btn" onclick="togglePrintDropdown()">Print ‚ñº</button>
  <div class="dropdown-content" id="printDropdown">
    <a onclick="printAll()">Print All</a>
    <a onclick="printNICU()">Print NICU</a>
    <a onclick="printWard()">Print Ward</a>
    <a onclick="printNew()">Print New</a>
  </div>
</div>
    <button class="theme-toggle" onclick="toggleDarkMode()" aria-label="Toggle theme"></button>
  </div>

  <div class="top-panel">
    <div id="handoverHeader" class="panel-card">
      <strong>Date:</strong> <span id="handoverDate">2025-09-15</span>
      <table>
        <tbody>
          <tr><th></th><th>Morning</th><th>Evening</th><th>Night</th></tr>
          <tr><td>Admissions</td><td><input type="number" id="adM" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="adE" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="adN" value="0" min="0" oninput="recalcSummary()"></td></tr>
          <tr><td>Discharges</td><td><input type="number" id="disM" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="disE" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="disN" value="0" min="0" oninput="recalcSummary()"></td></tr>
          <tr><td>Total Admissions</td><td colspan="3" id="totalAd">0</td></tr>
          <tr><td>Total Discharges</td><td colspan="3" id="totalDis">0</td></tr>
          <tr><td>Total Patients</td><td colspan="3" id="totalCount">0</td></tr>
          <tr><td>By ward</td><td colspan="3" id="wardBreakdown">PW (0), GW (0), SW (0), PVT (0), ICU (0), NICU (0), ER (0)</td></tr>
        </tbody>
      </table>
    </div>
    <div id="notesCard" class="panel-card">
      <strong>Notes/Pending work</strong>
      <textarea id="notesText" placeholder="Pending tasks, notes..." oninput="saveNotes(this.value)"></textarea>
    </div>
  </div>

  <div class="form-section" id="formSection">
    <input type="text" id="name" placeholder="Name" required>
    <div style="display:flex; gap:10px;">
        <input type="text" id="hno" placeholder="HNo." required style="flex:1;">
        <input type="text" id="nid" placeholder="NID" style="flex:1;">
    </div>
    <input type="text" id="doa" placeholder="Date of Admission (YYYY-MM-DD)" required>
    <input type="text" id="age" placeholder="Age" required>
    <div class="age-toggle" id="form-age-toggle">
      <label><input type="radio" id="form-radio-manual" name="formAgeMode" value="manual" checked onchange="toggleAutoInputsForm()"> Manual</label>
      <label><input type="radio" id="form-radio-auto" name="formAgeMode" value="auto" onchange="toggleAutoInputsForm()"> Auto (HOL/DOL)</label>
      <div class="auto-age-inputs" id="form-auto-age-inputs" style="display: none">
        <input type="date" id="dob" placeholder="Date of Birth (YYYY-MM-DD)">
        <input type="time" id="dot" placeholder="Time of Birth (HH:MM)">
      </div>
    </div>
    <select id="shift" required><option value="Morning">Morning Shift</option><option value="Evening">Evening Shift</option><option value="Night">Night Shift</option></select>
    <input type="text" id="bed" placeholder="Bed" required>
    <select id="sex"><option value="Male">Male</option><option value="Female">Female</option></select>
    <input type="text" id="weight" placeholder="Weight" required>
    <input type="text" id="diagnosis" placeholder="Diagnosis">
    <textarea id="medications" placeholder="Medications"></textarea>
    <input type="text" id="issues" placeholder="Issues">
    <textarea id="hopi" placeholder="HOPI"></textarea>
    <select id="ward"><option value="PW">PW</option><option value="GW">GW</option><option value="SW">SW</option><option value="PVT">PVT</option><option value="ICU">ICU</option><option value="NICU">NICU</option><option value="ER">ER</option></select>
    <textarea id="plan" placeholder="Plan"></textarea>
    <div class="new-checkbox"><label><input type="checkbox" id="isNew" checked> New</label></div>
    <button onclick="addPatient()">Submit</button>
  </div>

  <div id="wardsContainer"></div>

  <div id="detailModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Patient Details</h2>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
    <button class="btn-sm" onclick="printPatientDetails()" style="background:#607d8b; display:flex; align-items:center; gap:4px;" title="Print details">
        <span>üñ®Ô∏è</span>
    </button>
    
    <button class="btn-sm" onclick="openAdmissionForPatient()" style="background:var(--accent);">Reprint/Edit Admission folder</button>
    <button class="btn-sm" onclick="dischargeFromModal()" style="background:var(--discharge-btn);">Discharge Summary</button>
</div>
        <button class="close-modal" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active" onclick="switchTab('details')">Details</button>
        <button class="tab-btn" onclick="switchTab('labs')">Labs</button>
        <button class="tab-btn" onclick="switchTab('imaging')">X-Rays</button>
        <button class="tab-btn" onclick="switchTab('history')">Plan History</button>
      </div>
      <div class="modal-body">
        <div id="tab-details" class="tab-pane active">
          <div class="sleek-grid">
             <div>
                <div class="sleek-row"><span class="sleek-label">Name</span><div contenteditable="true" id="det-name" class="sleek-input" data-field="name" onblur="updateFromDetail('name', this.innerText)"></div></div>
                <div class="sleek-grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                   <div><span class="sleek-label">Hosp. No.</span><div contenteditable="true" id="det-hosp" class="sleek-input" onblur="updateIdFromDetail()"></div></div>
                   <div><span class="sleek-label">NID No.</span><div contenteditable="true" id="det-nid" class="sleek-input" onblur="updateIdFromDetail()"></div></div>
                </div>
             </div>
             <div>
                <div class="compact-grid">
                   <div><span class="sleek-label">Ward</span><div contenteditable="true" id="det-ward" class="sleek-input" data-field="ward" onblur="updateFromDetail('ward', this.innerText)"></div></div>
                   <div><span class="sleek-label">Bed</span><div contenteditable="true" id="det-bed" class="sleek-input" data-field="bed" onblur="updateFromDetail('bed', this.innerText)"></div></div>
                   <div><span class="sleek-label">Age</span><div contenteditable="true" id="det-age" class="sleek-input" data-field="age" onblur="updateFromDetail('age', this.innerText)"></div></div>
                   <div><span class="sleek-label">Sex</span><div contenteditable="true" id="det-sex" class="sleek-input" data-field="sex" onblur="updateFromDetail('sex', this.innerText)"></div></div>
                   <div><span class="sleek-label">Wt</span><div contenteditable="true" id="det-weight" class="sleek-input" data-field="weight" onblur="updateFromDetail('weight', this.innerText)"></div></div>
                </div>
             </div>
          </div>
          <div class="sleek-row"><span class="sleek-label">Diagnosis</span><div contenteditable="true" id="det-diagnosis" class="sleek-input" data-field="diagnosis" onblur="updateFromDetail('diagnosis', this.innerText)"></div></div>
          <div class="sleek-grid" style="grid-template-columns: 1fr 1fr;">
             <div class="sleek-row"><span class="sleek-label">Medications</span><div contenteditable="true" id="det-medications" class="sleek-input" data-field="medications" style="min-height: 60px;" onblur="updateFromDetail('medications', this.innerText)"></div></div>
             <div class="sleek-row"><span class="sleek-label">Issues</span><div contenteditable="true" id="det-issues" class="sleek-input" data-field="issues" style="min-height: 60px;" onblur="updateFromDetail('issues', this.innerText)"></div></div>
          </div>
          <div class="sleek-row"><span class="sleek-label">HOPI</span><div contenteditable="true" id="det-hopi" class="sleek-input" data-field="hopi" style="min-height: 100px; white-space: pre-wrap;" onblur="updateFromDetail('hopi', this.innerText)"></div></div>
        </div>
        <div id="tab-labs" class="tab-pane">
          <div style="overflow-x: auto;"><table class="lab-table" id="labMatrix"></table></div>
          <div class="chart-container"><canvas id="labsChart"></canvas></div>
        </div>
        <div id="tab-imaging" class="tab-pane">
          <div style="background: var(--card-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">Add Image</h3>
            <div style="display: flex; gap: 10px;">
              <input type="file" id="img-file" accept="image/*" class="form-control">
              <input type="text" id="img-cap" class="form-control" placeholder="Caption" style="width: 150px;">
              <button class="btn-sm" id="upload-btn" onclick="addImage()">Upload</button>
            </div>
          </div>
          <div class="img-grid" id="img-grid"></div>
        </div>
        <div id="tab-history" class="tab-pane">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
             <h3 style="margin:0;">Plan Log</h3>
             <div style="display:flex; gap:15px; align-items:center;">
               <button id="history-sort-btn" onclick="toggleHistorySort()" style="padding:4px 10px; font-size:11px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">
                 Newest ‚¨á
               </button>
               <span class="edit-history-link" id="modal-edit-link" onclick="toggleEditHistory(null, 'modal')">Edit</span>
             </div>
           </div>
           <ul class="history-list" id="history-list"></ul>
        </div>
      </div>
    </div>
  </div>
<div id="lightbox" class="lightbox"><span class="lightbox-close" onclick="closeLightbox()">&times;</span><img class="lightbox-content" id="lightbox-img"></div>

  <!-- Patient Action Modal (Discharge/Delete) -->
  <div id="patientActionModal" class="modal-overlay">
    <div class="modal-content" style="width: 420px; height: auto; max-width: 90%;">
      <div class="modal-header">
        <h2>Select Action</h2>
        <button class="close-modal" onclick="closePatientActionModal()">√ó</button>
      </div>
      <div class="modal-body" style="padding: 25px; display: flex; gap: 10px;">
        <button class="btn-sleek" style="flex: 1; background: var(--discharge-btn);" onclick="handleDischargeAction()">Discharge</button>
        <button class="btn-sleek" style="flex: 1; background: #e63946;" onclick="handleDeleteAction()">Delete</button>
      </div>
    </div>
  </div>

  <div id="admission-system">
    <div id="adm-header">
      <div style="display:flex; align-items:center;">
          <button class="adm-sidebar-toggle" onclick="toggleAdmSidebar()">‚ò∞</button>
          <h2 style="margin:0; font-size:18px;">Admission Center</h2>
      </div>
      <button onclick="closeAdmissionSystem()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
    </div>
    <div id="adm-body">
      <div class="adm-sidebar" id="admSidebar">
        <div class="mode-card active" id="btn-mode-form" onclick="setMode('form')">
          <div style="font-weight:bold;">üìù Form Mode</div>
          <div style="font-size:11px; opacity:0.8;">Fill form. Auto-prints & saves.</div>
        </div>
        <div class="mode-card" id="btn-mode-pdf" onclick="setMode('pdf')">
          <div style="font-weight:bold;">üìÑ Visual Mode</div>
          <div style="font-size:11px; opacity:0.8;">Edit directly on PDF.</div>
        </div>
        <div class="mode-card" id="btn-mode-newborn" onclick="setMode('newborn')">
          <div style="font-weight:bold;">üë∂ Newborn Mode</div>
          <div style="font-size:11px; opacity:0.8;">Newborn Sheet PDF</div>
        </div>
        <div style="margin-top:auto;">
          <small>Templates (PDF)</small>
          <div id="template-list" style="max-height:150px; overflow-y:auto; border-top:1px solid #eee; margin-top:5px;"></div>
          <button onclick="saveTemplate()" style="width:100%; margin-top:5px; padding:5px; font-size:11px;">Save Template</button>
        </div>
      </div>

      <div class="adm-viewport" onclick="if(document.body.classList.contains('is-mobile') && document.getElementById('admSidebar').classList.contains('show')) toggleAdmSidebar()">
        <div id="adm-std-details">
           <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:5px;">
             <h3 style="margin:0; color:var(--primary);">1. Patient Details</h3>
             <button onclick="printRequestOnly()" class="btn-sm" style="background:#6c757d;">Print Admission Request</button>
           </div>
           <div class="form-grid">
              <div class="form-group"><label>Name</label><input type="text" id="f-name" oninput="updateVisualField('name', this.value)"></div>
              
              <div class="form-group"><label>Hosp. No.</label><input type="text" id="f-hosp-no" oninput="updateVisualField('hid', this.value)"></div>
              <div class="form-group"><label>NID No.</label><input type="text" id="f-nid-no"></div>
              
              <div class="form-group"><label>DOA</label><input type="text" id="f-doa" oninput="updateVisualField('doa', this.value)"></div>
              <div class="form-group"><label>Shift</label><select id="f-shift"><option>Morning</option><option>Evening</option><option>Night</option></select></div>
              <div class="form-group"><label>Ward</label><select id="f-ward" onchange="updateVisualField('ward', this.value)"><option>PW</option><option>GW</option><option>SW</option><option>PVT</option><option>ICU</option><option>NICU</option><option>ER</option></select></div>
              <div class="form-group"><label>Bed</label><input type="text" id="f-bed" oninput="updateVisualField('bed', this.value)"></div>
              
              <div class="form-group"><label>Age</label>
                  <input type="text" id="f-age" placeholder="Enter age or select Auto" oninput="updateVisualField('age', this.value)">
                  <div class="age-toggle" id="adm-age-toggle" style="display:flex; gap:10px; align-items:center; margin-top:5px; border:none; padding:0; background:transparent;">
                    <label style="margin:0; font-weight:normal; text-transform:none;"><input type="radio" id="adm-radio-manual" name="admAgeMode" value="manual" checked onchange="toggleAdmAutoInputs()"> Manual</label>
                    <label style="margin:0; font-weight:normal; text-transform:none;"><input type="radio" id="adm-radio-auto" name="admAgeMode" value="auto" onchange="toggleAdmAutoInputs()"> Auto</label>
                    <div class="auto-age-inputs" id="adm-auto-age-inputs" style="display: none; margin-left:10px;">
                      <input type="date" id="f-dob" placeholder="DOB" style="padding:4px; font-size:12px;">
                      <input type="time" id="f-dot" placeholder="Time" style="padding:4px; font-size:12px;">
                    </div>
                  </div>
              </div>
              <div class="form-group"><label>Sex</label><select id="f-sex" onchange="updateVisualField('sex', this.value)"><option>Male</option><option>Female</option></select></div>
              <div class="form-group"><label>Weight</label><input type="text" id="f-weight"></div>
              
              <div class="form-group"><label>Diagnosis</label><input type="text" id="f-adm-dx" oninput="syncDx(this.value)"></div>
           </div>
        </div>

        <div id="adm-newborn-details" style="display:none;">
           <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:5px;">
             <h3 style="margin:0; color:var(--primary);">1. Patient Details (Newborn)</h3>
             <button onclick="printRequestOnly()" class="btn-sm" style="background:#6c757d;">Print Admission Request</button>
           </div>
           <div class="form-grid">
              <div class="form-group">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                      <label>Name</label>
                      <label style="font-weight:normal; font-size:10px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                          <input type="checkbox" id="nb-auto-name" onchange="toggleAutoName()" checked> Auto
                      </label>
                  </div>
                  <input type="text" id="nb-f-name">
              </div>

              <div class="form-group"><label>Hosp. No.</label><input type="text" id="nb-f-hosp-no" oninput="updateNbField('Text29', this.value); syncNbVisualField('Text29', this.value);"></div>
              <div class="form-group"><label>NID No.</label><input type="text" id="nb-f-nid-no" oninput="updateNbField('Text42', this.value); syncNbVisualField('Text42', this.value);"></div>
              
              <div class="form-group"><label>DOA</label><input type="text" id="nb-f-doa"></div>
              <div class="form-group"><label>Shift</label><select id="nb-f-shift"><option>Morning</option><option>Evening</option><option>Night</option></select></div>
              <div class="form-group"><label>Ward</label><select id="nb-f-ward"><option>NICU</option><option>PW</option><option selected>GW</option><option>SW</option><option>PVT</option><option>ICU</option><option>ER</option></select></div>
              <div class="form-group"><label>Bed</label><input type="text" id="nb-f-bed"></div>
              
              <div class="form-group">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>Diagnosis</label>
                    <span style="font-size:10px; color:var(--primary); font-weight:bold;">(Auto)</span>
                  </div>
                  <input type="text" id="nb-f-adm-dx" oninput="updateNbField('Text69', this.value); document.getElementById('nb-generated-dx').value = this.value; syncNbVisualField('Text69', this.value);">
              </div>
           </div>
        </div>

        <div id="view-form">
          <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">2. History</h3>
          <div class="form-group"><label>Presenting Complaints</label><textarea id="f-complaints" oninput="checkOverflow('f-complaints')"></textarea></div>
          <div class="form-group"><label>History of Present Illness (HOPI)</label><textarea id="f-hopi" style="min-height:150px;" oninput="checkOverflow('f-hopi')"></textarea><div id="warn-f-hopi" class="warning-text">‚ö†Ô∏è Text Limit Exceeded</div></div>
          <div class="form-group"><label>Past History</label><textarea id="f-past" oninput="checkOverflow('f-past')"></textarea><div id="warn-f-past" class="warning-text">‚ö†Ô∏è Text Limit Exceeded</div></div>
          <div class="form-group"><label>Personal History</label><textarea id="f-personal" oninput="checkOverflow('f-personal')"></textarea></div>
          <div class="form-group"><label>Family History</label><textarea id="f-family" oninput="checkOverflow('f-family')"></textarea></div>
          <div class="form-grid">
            <div class="form-group"><label>Treatment History</label><textarea id="f-treatment" oninput="checkOverflow('f-treatment')"></textarea></div>
            <div class="form-group"><label>Obstetric/Gynae History</label><textarea id="f-obs" oninput="checkOverflow('f-obs')"></textarea></div>
          </div>
          <h3 style="margin-top:15px; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">3. Examination</h3>
          <div class="form-group"><label>General Examination</label><textarea id="f-ge" oninput="checkOverflow('f-ge')"></textarea></div>
          <div class="form-grid">
             <div class="form-group"><label>CVS</label><textarea id="f-cvs" oninput="checkOverflow('f-cvs')"></textarea></div>
             <div class="form-group"><label>RS</label><textarea id="f-rs" oninput="checkOverflow('f-rs')"></textarea></div>
             <div class="form-group"><label>Abdomen</label><textarea id="f-abd" oninput="checkOverflow('f-abd')"></textarea></div>
             <div class="form-group"><label>Pelvis</label><textarea id="f-pelvis" oninput="checkOverflow('f-pelvis')"></textarea></div>
          </div>
          <div class="form-grid">
             <div class="form-group"><label>CNS</label><textarea id="f-cns" oninput="checkOverflow('f-cns')"></textarea></div>
             <div class="form-group"><label>Local Exam</label><textarea id="f-le" oninput="checkOverflow('f-le')"></textarea></div>
          </div>
          <h3 style="margin-top:15px; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">4. Assessment & Plan</h3>
          <div class="form-group"><label>Diagnosis</label><input type="text" id="f-finaldx" oninput="syncDx(this.value, true)"></div>
          <div class="form-group"><label>Plan</label><textarea id="f-plan" style="min-height:100px;" oninput="checkOverflow('f-plan')"></textarea></div>
        </div>

<div id="view-newborn" style="display:none;" class="nb-two-column">
      <div class="nb-col">
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
         <h4 style="margin:0 0 15px; color:#555; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #ddd; padding-bottom:5px;">Mother's Identity</h4>
         <div class="form-grid">
            <div class="form-group"><label>Name</label><input type="text" id="nb-m-name" oninput="updateNbField('Text1', this.value); syncBabyName(); syncNbVisualField('Text1', this.value);"></div>
            <div class="form-group"><label>Age</label><input type="text" id="nb-m-age" value="years" oninput="updateNbField('Text2', this.value)"></div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Mothers Hosp. No.</label><input type="text" id="nb-m-mrd" oninput="updateNbField('Text3', this.value)"></div>
            <div class="form-group">
                <label>Consanguinity</label>
                <input list="lst-consang" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text4', this.value)">
                <datalist id="lst-consang"><option value="Non-consanguineous"><option value="Consanguineous"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group">
                <label>Booking Status</label>
                <input list="lst-booking" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text5', this.value)">
                <datalist id="lst-booking"><option value="Booked"><option value="Unbooked"></datalist>
            </div>
            <div class="form-group">
                <label>Immunization</label>
                <input list="lst-imm" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text6', this.value)">
                <datalist id="lst-imm"><option value="Immunized"><option value="Un-immunized"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Para / Gravida</label><input id="nb-para-gravida" type="text" value="" oninput="updateNbField('Text7', this.value)"></div>
            <div class="form-group"><label>Prev. Still Birth</label><input id="nb-prev-still-birth" type="text" value="-" oninput="updateNbField('Text8', this.value)"></div>
         </div>
         <div class="form-group"><label>Weight / BMI</label><input id="nb-weight-bmi" type="text" value="Kg/m2" oninput="updateNbField('Text9', this.value)"></div>
      </div>

      <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
         <h4 style="margin:0 0 15px; color:#555; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #ddd; padding-bottom:5px;">Antenatal Labs</h4>
         <div class="form-grid">
            <div class="form-group"><label>LMP</label><input id="nb-lmp" type="text" placeholder="DD/MM/YYYY" oninput="updateNbField('Text10', this.value)"></div>
            <div class="form-group"><label>EDD</label><input id="nb-edd" type="text" placeholder="DD/MM/YYYY" oninput="updateNbField('Text11', this.value)"></div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Hb (g/dL)</label><input id="nb-hb" type="text" value="g/dL" oninput="updateNbField('Text12', this.value)"></div>
            <div class="form-group">
                <label>Blood Group</label>
                <input list="lst-bg" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text13', this.value)">
                <datalist id="lst-bg"><option value="O+ve"><option value="O-ve"><option value="A+ve"><option value="A-ve"><option value="B+ve"><option value="B-ve"><option value="AB+ve"><option value="AB-ve"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>VDRL</label>
                <input list="lst-vdrl" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text14', this.value)">
                <datalist id="lst-vdrl"><option value="Negative, G6PD: Normal"></datalist>
            </div>
            <div class="form-group"><label>Other Tests</label>
                <input list="lst-other-tests" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text15', this.value)">
                <datalist id="lst-other-tests"><option value="HIV: -ve, HbsAg: -ve, HCV: -ve"></datalist>
            </div>
         </div>
      </div>
      
      <div style="background:#fff0f0; padding:15px; border-radius:8px; border:1px solid #f5c6cb;">
         <h4 style="margin:0 0 15px; color:#d32f2f; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #f5c6cb; padding-bottom:5px;">Risk Factors & Labor</h4>
         <div class="form-grid">
            <div class="form-group"><label>Toxemia</label><input id="nb-toxemia" type="text" value="-" oninput="updateNbField('Text16', this.value)"></div>
            <div class="form-group"><label>Hydramnios</label><input id="nb-hydramnios" type="text" value="-" oninput="updateNbField('Text17', this.value)"></div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>PIH</label><input id="nb-pih" type="text" value="-" oninput="updateNbField('Text18', this.value)"></div>
            <div class="form-group"><label>APH</label><input id="nb-aph" type="text" value="-" oninput="updateNbField('Text19', this.value)"></div>
         </div>
         <div class="form-group"><label>Any Other Illness</label><input id="nb-any-other-illness" type="text" oninput="updateNbField('Text20', this.value)"></div>
         <div class="form-grid">
            <div class="form-group"><label>Presentation</label>
                <input list="lst-presentation" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text21', this.value)">
                <datalist id="lst-presentation"><option value="Cephalic"></datalist>
            </div>
            <div class="form-group"><label>Time of ROM</label><input id="nb-time-rom" type="text" value="-" oninput="updateNbField('Text22', this.value)"></div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Liquor Quality</label>
                <input list="lst-liq-qual" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text23', this.value)">
                <datalist id="lst-liq-qual"><option value="Clear"></datalist>
            </div>
            <div class="form-group"><label>Liquor Quantity</label>
                <input list="lst-liq-quan" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text24', this.value)">
                <datalist id="lst-liq-quan"><option value="Adequate"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Drugs Given</label><input id="nb-drugs-given" type="text" value="-" oninput="updateNbField('Text25', this.value)"></div>
            <div class="form-group"><label>Fetal Distress</label><input id="nb-fetal-distress" type="text" value="-" oninput="updateNbField('Text26', this.value)"></div>
         </div>
         <div class="form-group"><label>Thalassemia Status</label>
            <textarea id="nb-thalassemia" rows="2" oninput="updateNbField('Text27', this.value)">Mother: &#10;Father: </textarea>
         </div>
      </div>
   </div>

   <div class="nb-col">
      <div style="background:#e3f2fd; padding:15px; border-radius:8px; border:1px solid #b3e5fc;">
         <h4 style="margin:0 0 15px; color:#0277bd; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #b3e5fc; padding-bottom:5px;">Baby's Birth Details</h4>
         <div class="form-grid">
            <div class="form-group">
                <label>Delivery Mode</label>
                <input list="lst-mode" id="nb-b-mode" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text30', this.value); generateDiagnosis();">
                <datalist id="lst-mode"><option value="SVD"><option value="Em LSCS"><option value="El LSCS"><option value="Instrumental"></datalist>
            </div>
            <div class="form-group"><label>Indication</label><input type="text" id="nb-b-ind" oninput="updateNbField('Text31', this.value); generateDiagnosis();"></div>
         </div>
         <div class="form-group">
            <label>Date & Time</label>
            <input type="datetime-local" id="nb-b-datetime" oninput="updateNbField('Text35', this.value.replace('T', ' ')); syncBirthDate(this.value);">
         </div>
         <div style="margin-bottom:15px; border-top:1px dashed #ccc; padding-top:10px;">
             <label style="display:block; font-weight:bold; margin-bottom:5px;">APGAR Score</label>
             <div style="display:flex; gap:10px;">
                <input id="nb-apgar-1min" type="text" value="/10" placeholder="1 min" oninput="updateNbField('Text32', this.value)">
                <input id="nb-apgar-5min" type="text" value="/10" placeholder="5 min" oninput="updateNbField('Text33', this.value)">
                <input id="nb-apgar-10min" type="text" value="/10" placeholder="10 min" oninput="updateNbField('Text34', this.value)">
             </div>
         </div>

         <div class="form-grid">
            <div class="form-group"><label>Resuscitation</label><input id="nb-resuscitation" type="text" value="Dry stimulation" oninput="updateNbField('Text36', this.value)"></div>
            <div class="form-group"><label>Intubation</label><input id="nb-intubation" type="text" value="-" oninput="updateNbField('Text37', this.value)"></div>
         </div>
         <div class="form-group"><label>Bicarbonate / Lethedron</label><input id="nb-bicarbonate" type="text" value="-" oninput="updateNbField('Text38', this.value)"></div>

         <div class="form-grid">
            <div class="form-group">
                <label>Sex</label>
                <input list="lst-sex" id="nb-sex-combo" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text39', this.value); generateDiagnosis();">
                <datalist id="lst-sex"><option value="Male"><option value="Female"></datalist>
            </div>
            <div class="form-group"><label>Maturity</label><input type="text" id="nb-b-mat" value="" placeholder="e.g., 39+5 WOG" oninput="updateNbField('Text40', this.value)"></div>
         </div>
         <div class="form-grid">
            <div class="form-group">
                <label>Weight (Kg)</label>
                <input type="number" id="nb-b-wt" placeholder="Kg" oninput="updateNbField('Text41', this.value + ' kg'); syncBirthWeight(this.value);">
            </div>
         </div>

         <div class="form-grid">
            <div class="form-group">
                <label>Term/Preterm/Postterm</label>
                <input list="lst-gest" id="nb-gest-sel" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbTicks('gest', this.value); generateDiagnosis();">
                <datalist id="lst-gest"><option value="Term"><option value="Preterm"><option value="Postterm"></datalist>
            </div>
            <div class="form-group">
                <label>AGA/SGA/LGA</label>
                <input list="lst-size" id="nb-size-sel" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbTicks('size', this.value); generateDiagnosis();">
                <datalist id="lst-size"><option value="AGA"><option value="SGA"><option value="LGA"></datalist>
            </div>
         </div>
      </div>

      <div style="padding:15px; border:1px solid #eee; border-radius:8px;">
         <h4 style="margin:0 0 15px; color:#555; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #eee; padding-bottom:5px;">Baby Exam & Inv</h4>
         <div class="form-grid">
            <div class="form-group"><label>Cong. Anomalies</label>
                <input list="lst-cong-anom" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text43', this.value)">
                <datalist id="lst-cong-anom"><option value="No gross anomaly"></datalist>
            </div>
            <div class="form-group">
                <label>Cord Blood</label>
                <input list="lst-cord" value="Collected" onfocus="this.select()" oninput="updateNbField('Text49', this.value)">
                <datalist id="lst-cord"><option value="Collected"><option value="Not Collected"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Anal Patency</label>
                <input list="lst-anal" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text44', this.value)">
                <datalist id="lst-anal"><option value="Patent"></datalist>
            </div>
            <div class="form-group"><label>Esophageal Patency</label>
                <input list="lst-eso" value="" placeholder="Select..." onfocus="this.select()" oninput="updateNbField('Text45', this.value)">
                <datalist id="lst-eso"><option value="To be established"></datalist>
            </div>
         </div>
         <div class="form-grid">
            <div class="form-group"><label>Resp. Distress</label><input id="nb-resp-distress" type="text" value="-" oninput="updateNbField('Text46', this.value)"></div>
            <div class="form-group"><label>Cynosis/Pallor/Jaundice</label><input id="nb-cyanosis" type="text" value="-" oninput="updateNbField('Text47', this.value)"></div>
         </div>
         <div class="form-group"><label>Any other (Baby)</label><input id="nb-any-other-baby" type="text" value="-" oninput="updateNbField('Text48', this.value)"></div>
         <div class="form-group"><label>Investigations</label><input id="nb-investigations" type="text" value="Hb, PCV, Blood Grouping" oninput="updateNbField('Text50', this.value)"></div>
         <div class="form-grid">
            <div class="form-group"><label>Gastric Aspirate</label><input id="nb-gastric-aspirate" type="text" value="-" oninput="updateNbField('Text51', this.value)"></div>
            <div class="form-group"><label>Culture</label><input id="nb-culture" type="text" value="-" oninput="updateNbField('Text52', this.value)"></div>
         </div>
         <div class="form-group"><label>Any other (Inv)</label><input id="nb-any-other-inv" type="text" value="-" oninput="updateNbField('Text53', this.value)"></div>
      </div>
   </div>
   <div class="nb-bottom-span" style="background:#e8f5e9; padding:15px; border-radius:8px; border:1px solid #c3e6cb;">
       <h4 style="margin:0 0 15px; color:#2e7d32; font-size:13px; text-transform:uppercase; font-weight:700; border-bottom:1px solid #c3e6cb; padding-bottom:5px;">Assessment & Plan</h4>
       <div class="form-group"><label>Condition</label>
           <textarea id="nb-condition" rows="2" oninput="updateNbField('Text66', this.value)">Baby born vigorous, cried immediately after birth</textarea>
       </div>
       <div class="form-group">
          <label>Examination</label>
          <textarea id="nb-examination" style="min-height:150px;" oninput="updateNbField('Text67', this.value)">Tone and cry:            Normal&#10;Reflex and Activity:  Normal&#10;&#10;RS: B/L EAE, CLEAR&#10;No LCR, UCR, XR, NF or Grunting&#10;&#10;CVS: S1 S2 M0&#10;&#10;Umbilical Vessels: 2A +1V&#10;&#10;HR , RR , SpO2 % in RA&#10;&#10;-</textarea>
       </div>
       <div class="form-group"><label>Advice</label>
           <textarea id="nb-advice" style="min-height:100px;" oninput="updateNbField('Text68', this.value)">-Routine newborn care&#10;-Exclusive breast feeding as early as possible then every 2hrly&#10;-Immunization as protocol&#10;-CCHD >24HOL, NMS >72HOL&#10;-W/F Tachypnea, Poor feeding, Lethargy</textarea>
       </div>
       <div class="form-group">
          <label>Diagnosis (Auto-Generated)</label>
          <textarea id="nb-generated-dx" oninput="updateNbField('Text69', this.value); syncNbVisualField('Text69', this.value);" style="background:#f0f0f0; min-height:40px;"></textarea>
       </div>
       <div class="form-group"><label>Attended By</label>
           <textarea id="nb-attended-by" rows="3" oninput="updateNbField('Text70', this.value)">Attended By:&#10;Dr. &#10;Dr. (MO)</textarea>
       </div>
   </div>
</div>
        <div id="view-pdf">
           <div id="pdf-stage"></div>
        </div>
        <div id="view-newborn-visual">
           <div id="nb-visual-stage"></div>
        </div>
      </div>
    </div>
    <div id="adm-toolbar">
       <span id="pdf-controls" style="display:none; gap:10px; align-items:center; border-right:1px solid #ddd; padding-right:10px; margin-right:10px;">
         <label style="font-size:12px;">Size:</label>
         <select id="sel-pdf-font" onchange="changePdfFont(this.value)">
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13" selected>13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="18">18</option>
          </select>
          <label style="font-size:12px;">Ln:</label>
          <select id="sel-pdf-line" onchange="changePdfLineHeight(this.value)">
            <option value="1.0">1.0</option>
            <option value="1.1">1.1</option>
            <option value="1.2">1.2</option>
            <option value="1.3" selected>1.3</option>
            <option value="1.4">1.4</option>
            <option value="1.5">1.5</option>
          </select>
          <label style="font-size:12px; display:flex; align-items:center; gap:4px;">
            <input type="checkbox" id="chk-auto-fit" onchange="toggleAutoFit(this.checked)" style="cursor:pointer;">
            Auto-fit
          </label>
       </span>
       <button class="tool-btn" onclick="printOnly()">Print Only</button>
       <button class="tool-btn" id="btn-save-edits" style="display:none; background:#ffc107; color:black; border:none;" onclick="saveEdits()">Save Edits</button>
       <button class="tool-btn primary" id="btn-print-add" onclick="saveAndAdd()">Print & Add</button>
    </div>
  </div>

  <div id="discharge-system">
    <div id="dc-header">
      <div class="dc-header-content">
          <h2 style="margin:0; font-size:18px;">Discharge Center</h2>

          <div class="dc-selects">
              <select id="dc-template-type" class="dc-selector" style="min-width: 150px;" onchange="updateDcTemplate()">
                  <option value="pediatric">Template: Pediatric</option>
                  <option value="neonate">Template: Neonate</option>
                  <option value="neonate_hx">Template: Neonate with Hx</option>
              </select>

              <select id="dc-patient-select" class="dc-selector" onchange="selectDcPatient(this.value)">
                  <option value="">-- Select Patient to Discharge --</option>
              </select>
          </div>

          <div class="dc-buttons">
              <button class="btn-sleek" onclick="generateDcDocx()">Download .docx</button>
              <button class="btn-sleek btn-warn" onclick="resetDcForm()">Reset</button>
          </div>
      </div>
      <div class="dc-close-btn">
          <button onclick="closeDischargeSystem()" style="background:none; border:none; font-size:32px; cursor:pointer; padding:10px; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center;">√ó</button>
      </div>
    </div>
    
    <div id="dc-body">
      <div class="dc-split-view">
          <div class="dc-form-pane">
              <div id="dc-form-container" class="dc-paper">
                  <h1 class="dc-title">DISCHARGE SUMMARY</h1>
                  
                  <table>
                      <tbody id="dc-table-body">
                          <tr>
                              <td style="width:19%;"><span class="label-text">NAME:</span></td>
                              <td style="width:23%;"><textarea id="dc-name" rows="1"></textarea></td>
                              <td style="width:10%;"><span class="label-text">AGE:</span></td>
                              <td style="width:10%;"><textarea id="dc-age" rows="1"></textarea></td>
                              <td style="width:13%;"><span class="label-text">GENDER:</span></td>
                              <td style="width:10%;"><textarea id="dc-sex" rows="1"></textarea></td>
                              <td style="width:10%;"><span class="label-text" id="lbl-weight">WEIGHT:</span></td>
                              <td style="width:10%;"><textarea id="dc-weight" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td><span class="label-text">ADDRESS:</span></td>
                              <td colspan="3"><textarea id="dc-address" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">HOSPITAL No:</span></td>
                              <td colspan="2"><textarea id="dc-mrn" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td><span class="label-text">WARD:</span></td>
                              <td><textarea id="dc-ward" rows="1"></textarea></td>
                              <td><span class="label-text">BED:</span></td>
                              <td><textarea id="dc-bed" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">FOLDER No:</span></td>
                              <td colspan="2"><textarea id="dc-folder" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td colspan="2"><span class="label-text">DATE OF ADMISSION:</span></td>
                              <td colspan="2"><textarea id="dc-doa" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">DATE OF DISCHARGE:</span></td>
                              <td colspan="2"><textarea id="dc-dod" rows="1"></textarea></td>
                          </tr>
                          <tr><td colspan="8" style="border:none!important; height:10px;"></td></tr>
                          
                          <tr id="row-diagnosis">
                              <td colspan="1" style="width:19%;"><span class="label-text">DIAGNOSIS:</span></td>
                              <td colspan="7"><textarea id="dc-diagnosis"></textarea></td>
                          </tr>

                          <tr id="row-birth-hx-split" style="display:none;">
                              <td colspan="1"><span class="label-text" id="lbl-split-row">BIRTH HISTORY:</span></td>
                              <td colspan="4"><textarea id="dc-birth-hx-col1" style="min-height:80px;"></textarea></td>
                              <td colspan="3"><textarea id="dc-birth-hx-col2" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-history">
                              <td colspan="1"><span class="label-text" id="lbl-history">HISTORY:</span></td>
                              <td colspan="7"><textarea id="dc-history" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-exam">
                              <td colspan="1"><span class="label-text" id="lbl-exam">EXAMINATION:</span></td>
                              <td colspan="7"><textarea id="dc-exam" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-maternal-hx" style="display:none;">
                              <td colspan="1"><span class="label-text">MATERNAL HISTORY:</span></td>
                              <td colspan="7"><textarea id="dc-maternal-hx" style="min-height:60px;"></textarea></td>
                          </tr>

                          <tr>
                              <td colspan="1"><span class="label-text">INVESTIGATIONS:</span></td>
                              <td colspan="7"><textarea id="dc-ix">ALL ENCLOSED</textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">TREATMENT AND HOSPITAL COURSE:</span></td>
                              <td colspan="7"><textarea id="dc-course" style="min-height:120px;"></textarea></td>
                          </tr>
                          
                          <tr><td colspan="8" style="border:none!important; height:10px;"></td></tr>
                          
                          <tr>
                              <td colspan="1"><span class="label-text">ON DISCHARGE CONDITION:</span></td>
                              <td colspan="7"><textarea id="dc-cond">Alert, oriented.&#10;Vitals: Stable.</textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">TREATMENT ON DISCHARGE:</span></td>
                              <td colspan="7"><textarea id="dc-rx"></textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">REVIEW:</span></td>
                              <td colspan="7"><textarea id="dc-review">Follow up in P-OPD after    days</textarea></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>

          <div class="dc-history-pane">
              <h3>Plan History (Earliest First)</h3>
              <div id="dc-history-list"></div>
          </div>
      </div>
    </div>
  </div>
<script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC3_DD-ezlWahQeCdPLcFh_lohLn63Q7eY",
      authDomain: "pediatric-handover.firebaseapp.com",
      projectId: "pediatric-handover",
      storageBucket: "pediatric-handover.firebasestorage.app",
      messagingSenderId: "104007714087",
      appId: "1:104007714087:web:77811513530b0ee9859502"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --- LAZY LOADING VARIABLES ---
    let isDischargeExpanded = false;
    let activeUnsub = null;
    let dischargeUnsub = null;
    const activeWards = ["PW","GW","SW","PVT","ICU","NICU","ER"];

    // --- CONFIGURATION ---
    const PDF_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/Admission.pdf';
    const REQUEST_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/AdmissionRequest.pdf';
    const NEWBORN_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/Newborn.pdf';
    const ANCHORS_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/anchors.json';
    const NB_ANCHORS_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/newborn-anchors.json';

    // *** TEMPLATE URLs ***
    const DOCX_URL_PED = "https://raw.githubusercontent.com/nuhadwrk/admission/main/discharge_template.docx"; 
    const DOCX_URL_NEO = "https://raw.githubusercontent.com/nuhadwrk/admission/main/neonate.docx"; 
    const DOCX_URL_NEO_HX = "https://raw.githubusercontent.com/nuhadwrk/admission/main/neonatehx.docx";

    // *** DEFAULTS (Updated with your specific placeholders) ***
    const DEFAULTS = {
        neo_birth_hx_col1: `Date: \nType of Delivery: \nMaturity: \nAPGAR Score: \nLiquor: \nDistress: None\nCried immediately after delivery: Yes`,
        
        neo_findings: `Cried after delivery, Vigorous, Pink
Congenital anomalies: none grossly.
Hip Abduction test: normal
UA: 3 vessels
CVS: S1+S2+M0
RS: B/L EAE, No added sounds
CRT: <3s
Abdomen: no organomegaly
B/L descended testes
Neonatal reflexes: normal
Urine and meconium: Passed
CCHD: Passed, RH:    RF:    `,

        neo_measurements: `Birth weight:  
HC:   cm
Length:   cm
HR:   RR:   SpO2:   `,

        neo_maternal: `Age:  , \nBlood group:  ; , VDRL/HIV/HBsAg/HCV: Non-reactive`,
        
        neo_cond: `- Sucking well.\n- Breast feeding on demand.\n- Urine and meconium passing\n- All vitals stable.\n- Weight on discharge:   kg`,
        
        neo_course: `1. Breast feeding on demand\n2. Inj. vitamin K 1mg given at birth (left thigh) on \n3. Vaccines given: BCG, Hep. B on `,
        
        neo_rx: `- Early morning and light exposure.\n- Exclusive breastfeeding for 6 months.\n- Cord care.\n- Immunization according to schedule.\n- Advised to keep home smoke-free.\n- Check for increase in yellowish discoloration of skin, poor feeding, lethargy etc.\n- Jusdee oral drops 1 ml PO OD x 1 year.`,
        
        neohx_rx: `- Early morning and light exposure.\n- Exclusive breastfeeding for 6 months.\n- Cord care.\n- Immunization according to schedule.\n- Advised to keep home smoke-free including balconies, doorway and stairs and do not allow anyone to smoke near baby.\n- Check for increase in yellowish discoloration of skin, poor feeding, lethargy etc.`,

        neo_review: `Follow up in P-OPD after 3days with Hb/PCV, TSB, DSB, FT4, TSH\nNeonatal Metabolic screening from RHC`,

        ped_cond: `Alert, oriented.\nVitals: Stable.`,
        ped_rx: ``
    };

    // --- UTILS ---
    function getOrdinalSuffix(n) { const l=n%10, t=n%100; if(t>=11&&t<=13)return'th'; return l===1?'st':l===2?'nd':l===3?'rd':'th'; }
    function calculateDaysAdmitted(doa) { try{ const d=new Date(doa), t=new Date(); t.setHours(0,0,0,0); d.setHours(0,0,0,0); const diff=Math.floor((t-d)/86400000)+1; return diff<=0?'1st DOA':`${diff}${getOrdinalSuffix(diff)} DOA`; }catch(e){return'1st DOA';} }
    
    function calculateNeonatalAge(dob, dot) { try{ if(!dob||!dot)return{display:'?'}; const b=new Date(`${dob}T${dot}:00`); if(isNaN(b.getTime()))return{display:'?'}; const n=new Date(), h=Math.floor((n-b)/3600000), d=Math.floor(h/24)+1; return {days:d,hours:h,display:h<=96?`${d}${getOrdinalSuffix(d)} DOL (${h} HOL)`:`${d}${getOrdinalSuffix(d)} DOL`}; }catch(e){return{days:1,hours:24,display:'?'};} }
    // Helper to get dynamic age for both Cards and Modals
function getDisplayAge(p) {
    if (p.isAutoAge && p.dob && p.dot) {
        return calculateNeonatalAge(p.dob, p.dot).display;
    }
    return p.age || '';
}
  function getLiveCGA(p) {
    // We need GA Weeks, DOB, and DOT to calculate
    const gaWeeks = parseInt(p.gaWeeks) || 0;
    const gaDays = parseInt(p.gaDays) || 0;
    
    if (gaWeeks > 0 && p.dob && p.dot) {
        try {
            const birthDate = new Date(`${p.dob}T${p.dot}:00`);
            const now = new Date();
            
            if (!isNaN(birthDate.getTime())) {
                // Calculate chronological age in days
                const chronoDays = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
                
                // Add Birth GA + Chrono Age
                const totalGADays = (gaWeeks * 7) + gaDays;
                const totalCGADays = totalGADays + chronoDays;
                
                const currentCgaWeeks = Math.floor(totalCGADays / 7);
                const currentCgaDays = totalCGADays % 7;
                
                return ` (CGA: ${currentCgaWeeks}+${currentCgaDays})`;
            }
        } catch(e) { return ''; }
    }
    return '';
}
    function calculateCompletedDOL(dob, dot) {
        if(!dob || !dot) return "";
        try {
            const birthDate = new Date(`${dob}T${dot}:00`);
            const now = new Date();
            if(isNaN(birthDate.getTime())) return "";
            const diffMs = now - birthDate;
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            return `${days} DOL`;
        } catch(e) { return ""; }
    }

    function formatTimestamp(ts) { const d=new Date(ts); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

    // Extract first logged plan from patient logs
    // Rule: Plan is always the second log entry (after "Admission Record Created")
    //       OR first entry if no admission record text
    function getFirstLoggedPlan(logs) {
        if(!logs) return '';

        // Split by bullet points and filter empty
        const entries = logs.split('‚Ä¢').filter(e => e.trim());
        if(entries.length === 0) return '';

        // Check if first entry is admission record/note (not a plan)
        const firstEntry = entries[0].toLowerCase();
        const isAdmissionRecord = firstEntry.includes('admission') ||
                                  firstEntry.includes('admitted') ||
                                  firstEntry.includes('record created');

        // If first entry is admission record, plan is second entry
        // Otherwise, plan is first entry
        const planEntry = isAdmissionRecord && entries.length > 1 ? entries[1] : entries[0];

        // Remove timestamp (first line) and return plan text
        const lines = planEntry.split('\n').filter(l => l.trim());
        if(lines.length <= 1) return planEntry.trim();

        // Skip first line (timestamp) and return rest
        let planText = lines.slice(1).join('\n').trim();

        // Remove any plan label prefixes (PLAN:, Initial Plan:, Admission Plan:)
        planText = planText.replace(/^\s*(PLAN|Initial Plan|Admission Plan)\s*:\s*/i, '').trim();

        return planText;
    }
    function getLocalISODate() { return new Date().toLocaleDateString('en-CA'); }
    function getCurrentShift() { const h = new Date().getHours(); if (h>=8 && h<16) return "Morning"; if (h>=16) return "Evening"; return "Night"; }

    // --- LOGGING UTILS ---
    let historySortOrder = 'newest'; // Global sort order: 'newest' or 'oldest'

    function formatLogsToHtml(logsStr, patientId, limitToLast3 = false, allowEdit = false, sortOrder = 'newest') {
        if (!logsStr) return allowEdit ? '' : '<div style="font-size:12px; color:#888; font-style:italic; padding-left:5px;">No logs</div>';
        let entries = logsStr.split('‚Ä¢').filter(e => e.trim().length > 0);

        // Apply sort order (newest = reverse, oldest = keep original)
        if (sortOrder === 'newest') {
            entries = entries.reverse();
        }

        if (limitToLast3) { entries = entries.slice(0, 3); allowEdit = false; }
        let html = '';
        entries.forEach(e => {
            const lines = e.trim().split('\n');
            const datePart = lines[0].trim();
            const body = lines.slice(1).join('\n').trim();
            if(body) {
                if (allowEdit) {
                    html += `<li class="history-item editable-item"><div class="history-date">${datePart}</div><div class="history-text" contenteditable="false" onblur="saveLogsFromDom('${patientId}', this)">${body}</div><span class="log-delete-btn" onclick="deleteLogItem(this, '${patientId}')" title="Delete Log">√ó</span></li>`;
                } else {
                    html += `<li class="history-item"><div class="history-date">${datePart}</div><div class="history-text">${body}</div></li>`;
                }
            }
        });
        if (limitToLast3 && html === '') return '<div style="font-size:12px; color:#888; font-style:italic; padding-left:5px;">No recent logs</div>';
        const listId = limitToLast3 ? `recent-list-${patientId}` : `full-list-${patientId}`;
        return `<ul class="history-list" id="${listId}">${html}</ul>`;
    }

    function toggleEditHistory(id, context) {
        const patientId = context === 'modal' ? currentPatientId : id;
        const listId = context === 'modal' ? 'history-list' : `full-list-${patientId}`;
        const listEl = document.getElementById(listId);
        if(!listEl) return;
        listEl.classList.toggle('editing-mode');
        const isEditing = listEl.classList.contains('editing-mode');
        const textItems = listEl.querySelectorAll('.history-text');
        textItems.forEach(el => el.contenteditable = isEditing); 
        textItems.forEach(el => el.setAttribute('contenteditable', isEditing)); 
        const linkId = context === 'modal' ? 'modal-edit-link' : `card-edit-link-${patientId}`;
        const linkEl = document.getElementById(linkId);
        if(linkEl) {
            linkEl.innerText = isEditing ? 'Done' : 'Edit';
            linkEl.style.color = isEditing ? '#28a745' : 'var(--primary)';
        }
    }

function saveLogsFromDom(patientId, element) {
        const listContainer = element.closest('ul');
        if (!listContainer) return;
        
        const items = listContainer.querySelectorAll('li.history-item');
        let logEntries = [];
        
        items.forEach(li => {
            const dateText = li.querySelector('.history-date').innerText.trim();
            const bodyText = li.querySelector('.history-text').innerText.trim();
            if (dateText && bodyText) { 
                logEntries.push(`‚Ä¢ ${dateText}\n ${bodyText}\n\n`); 
            }
        });

        // FIX: Check global sort order to prevent reversing the list unintentionally
        let reconstructedLogs = '';
        
        // If UI is showing Oldest First, the DOM list is ALREADY chronological.
        // If UI is showing Newest First (default), we must reverse it to store it chronologically in DB.
        if (typeof historySortOrder !== 'undefined' && historySortOrder === 'oldest') {
             reconstructedLogs = logEntries.join('');
        } else {
             reconstructedLogs = logEntries.reverse().join('');
        }

        db.collection('patients').doc(patientId).update({ logs: reconstructedLogs })
          .catch(e => console.error("Error saving logs", e));
    }

function deleteLogItem(btn, patientId) {
        if(!confirm("Delete this log entry?")) return;
        
        const li = btn.closest('li');
        const listContainer = li.closest('ul'); // 1. Capture parent BEFORE removing child
        
        li.remove(); // 2. Remove the visual item
        
        // 3. Reconstruct the log string from the remaining items
        const items = listContainer.querySelectorAll('li.history-item');
        let logEntries = [];
        
        items.forEach(item => {
            const dateText = item.querySelector('.history-date').innerText.trim();
            const bodyText = item.querySelector('.history-text').innerText.trim();
            if (dateText && bodyText) { 
                logEntries.push(`‚Ä¢ ${dateText}\n ${bodyText}\n\n`); 
            }
        });
        
        // 4. Handle Sorting: Ensure DB is always saved Chronological (Oldest -> Newest)
        // If UI is showing Newest First (default), we must reverse list before saving.
        // If UI is showing Oldest First, the list is already correct.
        let reconstructedLogs = '';
        if (typeof historySortOrder !== 'undefined' && historySortOrder === 'oldest') {
             reconstructedLogs = logEntries.join('');
        } else {
             reconstructedLogs = logEntries.reverse().join('');
        }
        
        // 5. Save to Firestore
        db.collection('patients').doc(patientId).update({ logs: reconstructedLogs })
            .catch(e => {
                console.error("Error saving logs", e);
                alert("Failed to delete log from server.");
            });
    }

    function checkLogInput(id) {
        const el = document.getElementById(`new-plan-${id}`);
        const btn = document.getElementById(`btn-log-${id}`);
        const txt = el.innerText.trim();
        if(txt.length > 0) { btn.disabled = false; } 
        else { btn.disabled = true; }
    }

    // --- DISCHARGE CENTER LOGIC ---
    let currentDcPatientId = null;

    function launchDischargeSystem() {
        document.getElementById('discharge-system').style.display = 'flex';
        loadDcPatients();
        document.getElementById('dc-template-type').value = 'pediatric';
        updateDcTemplate(); 
        document.querySelectorAll('#dc-form-container textarea').forEach(el => el.value = '');
        document.getElementById('dc-history-list').innerHTML = '<div style="text-align:center;color:#888;margin-top:20px;">Select a patient to view history</div>';
    }

    function dischargeFromModal() {
        const idToProcess = currentPatientId;
        if(!idToProcess) return;
        closeModal();
        launchDischargeSystem();
        setTimeout(() => {
            const selectEl = document.getElementById('dc-patient-select');
            if(selectEl) {
                selectEl.value = idToProcess;
                selectDcPatient(idToProcess);
            }
        }, 100); 
    }

    function closeDischargeSystem() {
        document.getElementById('discharge-system').style.display = 'none';
        currentDcPatientId = null;
    }

    function loadDcPatients() {
        const select = document.getElementById('dc-patient-select');
        select.innerHTML = '<option value="">-- Select Patient --</option>';
        const wards = ["NICU", "ICU", "PW", "GW", "SW", "PVT", "ER"];
        const grouped = {};
        Object.values(localPatients).forEach(p => {
            if(p.ward === 'Discharge') return;
            if(!grouped[p.ward]) grouped[p.ward] = [];
            grouped[p.ward].push(p);
        });
        wards.forEach(w => {
            if(grouped[w] && grouped[w].length > 0) {
                const group = document.createElement('optgroup');
                group.label = w;
                grouped[w].sort((a,b) => (parseInt(a.bed)||0) - (parseInt(b.bed)||0));
                grouped[w].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.docId;
                    opt.innerText = `Bed ${p.bed}: ${p.name}`;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            }
        });
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function formatDateDDMMYYYY(iso) {
        if(!iso) return '';
        try { const d = new Date(iso); if(isNaN(d.getTime())) return iso; return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`; } catch(e) { return iso; }
    }

    function updateDcTemplate() {
        const type = document.getElementById('dc-template-type').value;
        const rowHistory = document.getElementById('row-history');
        const rowBirthHxSplit = document.getElementById('row-birth-hx-split');
        const rowExam = document.getElementById('row-exam');
        const rowMaternalHx = document.getElementById('row-maternal-hx');
        const tBody = document.getElementById('dc-table-body');
        const lblWeight = document.getElementById('lbl-weight');
        const lblExam = document.getElementById('lbl-exam');
        const lblHistory = document.getElementById('lbl-history');
        const lblSplit = document.getElementById('lbl-split-row');

        rowHistory.style.display = 'none'; rowBirthHxSplit.style.display = 'none'; rowMaternalHx.style.display = 'none';

        if (type === 'pediatric') {
            lblWeight.innerText = "WEIGHT:"; lblExam.innerText = "EXAMINATION:"; lblHistory.innerText = "HISTORY:";
            if(tBody.contains(rowHistory)) tBody.insertBefore(rowHistory, rowExam);
            rowHistory.style.display = 'table-row'; rowExam.style.display = 'table-row';
        } else if (type === 'neonate') {
            lblWeight.innerText = "BIRTH WEIGHT:"; lblHistory.innerText = "BIRTH HISTORY:"; lblSplit.innerText = "FINDINGS AT BIRTH:"; 
            if(tBody.contains(rowHistory)) tBody.insertBefore(rowHistory, rowExam);
            rowHistory.style.display = 'table-row';
            if (rowHistory.nextSibling) { tBody.insertBefore(rowBirthHxSplit, rowHistory.nextSibling); } else { tBody.appendChild(rowBirthHxSplit); }
            rowBirthHxSplit.style.display = 'table-row'; rowExam.style.display = 'none'; rowMaternalHx.style.display = 'table-row';
        } else if (type === 'neonate_hx') {
            lblWeight.innerText = "WEIGHT:"; lblExam.innerText = "EXAMINATION:"; lblHistory.innerText = "HISTORY:"; lblSplit.innerText = "BIRTH HISTORY:";
            rowHistory.style.display = 'table-row'; rowExam.style.display = 'table-row';
            if (rowExam.nextSibling) { tBody.insertBefore(rowBirthHxSplit, rowExam.nextSibling); } else { tBody.appendChild(rowBirthHxSplit); }
            rowBirthHxSplit.style.display = 'table-row'; rowMaternalHx.style.display = 'table-row';
        }
        if(currentDcPatientId) selectDcPatient(currentDcPatientId);
    }

// --- REFACTORED: AUTO-TEMPLATE BASED ON AGE ONLY ---
function selectDcPatient(id, forceReset = false) {
    if (!id) return;
    const p = localPatients[id];
    
    // -----------------------------------------------------------
    // 1. AUTO-DETECT TEMPLATE (STRICTLY AGE < 30 DAYS)
    // -----------------------------------------------------------
    const currentTemplate = document.getElementById('dc-template-type').value;
    let targetTemplate = 'pediatric'; // Default to Paeds

    let isNeonate = false;

    // Check 1: Auto-Calculated Age (Most Accurate)
    if (p.isAutoAge && p.dob && p.dot) {
        const ageObj = calculateNeonatalAge(p.dob, p.dot);
        // If days are calculated and less than 30
        if (ageObj.days !== undefined && ageObj.days < 30) isNeonate = true;
    }
    // Check 2: Manual Age String (Fallback)
    else if (p.age) {
        const a = p.age.toLowerCase();
        // Logic: 
        // 1. Contains "hr" (e.g., "6 hrs") -> Neonate
        // 2. Contains "day" AND number is < 30 (e.g., "5 days") -> Neonate
        // 3. Does NOT contain "mo" or "yr" (avoids "1 day 5 mos")
        if ( (a.includes('hr') || (a.includes('day') && parseInt(a) < 30)) && !a.includes('mo') && !a.includes('yr') ) {
            isNeonate = true;
        }
    }

    if (isNeonate) targetTemplate = 'neonate';

    // -----------------------------------------------------------
    // 2. SWITCH & RELOAD IF MISMATCH
    // -----------------------------------------------------------
    const isCurrentNeo = currentTemplate.includes('neonate');
    const isTargetNeo = targetTemplate === 'neonate';

// If template mismatch AND we are switching to a new patient (not just reloading)
    if (id !== currentDcPatientId && isCurrentNeo !== isTargetNeo) {
        currentDcPatientId = id; 
        document.getElementById('dc-template-type').value = targetTemplate;
        updateDcTemplate(); 
        return; 
    }

    // -----------------------------------------------------------
    // 3. STANDARD DATA LOADING
    // -----------------------------------------------------------
    currentDcPatientId = id;
    const data = forceReset ? {} : (p.dischargeData || {});
    const type = document.getElementById('dc-template-type').value;
    const nb = p.newbornData || {}; 
    
    let mrnOnly = p.id || ''; let nidOnly = p.nid || ''; 
    if(!nidOnly && p.id && p.id.includes(',')) { const parts = p.id.split(','); mrnOnly = parts[0].trim(); nidOnly = parts.length > 1 ? parts[1].trim() : ''; }
    const nameWithNid = nidOnly ? `${p.name} (${nidOnly})` : p.name;
    
    let ageDisplay = p.age;
    if ((type === 'neonate' || type === 'neonate_hx') && p.isAutoAge && p.dob && p.dot) { ageDisplay = calculateCompletedDOL(p.dob, p.dot); }

    let formattedBirthDate = nb.Text35 || '';
    if (formattedBirthDate) {
        try {
            const d = new Date(formattedBirthDate);
            if (!isNaN(d.getTime())) {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                formattedBirthDate = `${day}/${month}/${year} ${time}`;
            }
        } catch (e) {}
    }

    let g6pdText = nb.Text14 || '-';
    if (g6pdText.includes("G6PD")) {
        g6pdText = g6pdText.substring(g6pdText.indexOf("G6PD"));
    }

    const nbBirthHx = nb.Text35 ? `Date: ${formattedBirthDate}\nType of Delivery: ${nb.Text30} ${nb.Text31||''}\nMaturity: ${nb.Text40||''}\nAPGAR: ${nb.Text32} (1 min), ${nb.Text33} (5 min), ${nb.Text34} (10 min)\nLiquor: ${nb.Text23||''} + ${nb.Text24||''}\nDistress: None\nCried immediately after delivery: Yes` : DEFAULTS.neo_birth_hx_col1;

    const nbFindings = DEFAULTS.neo_findings; 

    let vitalsStr = "HR:   RR:   SpO2:   ";
    if (nb.Text67) {
        const hrMatch = nb.Text67.match(/HR\s*([0-9]+)/i);
        const rrMatch = nb.Text67.match(/RR\s*([0-9]+)/i);
        const spo2Match = nb.Text67.match(/SpO2\s*([0-9]+)/i);
        if(hrMatch || rrMatch || spo2Match) {
            vitalsStr = `HR: ${hrMatch?hrMatch[1]:'-'}  RR: ${rrMatch?rrMatch[1]:'-'}  SpO2: ${spo2Match?spo2Match[1]:'-'}%`;
        }
    }
    const nbMeasurements = nb.Text41 ? `Birth weight: ${nb.Text41}\nHC:   cm\nLength:   cm\n${vitalsStr}` : DEFAULTS.neo_measurements;

    const nbMaternal = nb.Text1 ? `Age: ${nb.Text2||'-'}, ${nb.Text7||'-'}\nBlood group: ${nb.Text13||'-'}; ${g6pdText}, VDRL/HIV/HBsAg/HCV: Non-reactive` : DEFAULTS.neo_maternal;

    let admHist = "";
    if(p.admissionData) {
        admHist = `${(p.admissionData.hopi || '').trim()}\n\nPast Hx: ${(p.admissionData.pasthx || '').trim()}\n\nPersonal Hx: ${(p.admissionData.personalhx || '').trim()}\n\nFamily Hx: ${(p.admissionData.fhx || '').trim()}`;
    } else { admHist = (p.hopi || '').trim(); }

    const admGeneralExamOnly = p.admissionData?.ge || p.general_exam || "";
    const examParts = [{ l: 'G/E', v: p.general_exam }, { l: 'CVS', v: p.cvs }, { l: 'RS', v: p.rs }, { l: 'Abd', v: p.abdomen }, { l: 'CNS', v: p.cns }];
    const admExamFull = examParts.filter(part => (part.v || '').trim() !== '').map(part => `${part.l}: ${part.v.trim()}`).join('\n');
    const firstLoggedPlan = getFirstLoggedPlan(p.logs);
    const admissionCourse = `In ER:\n${(p.treatment_history||'').trim()}\n\nAfter Admission:\n${firstLoggedPlan}`;

    const map = {
        'dc-name': data.name || nameWithNid, 'dc-age': data.age || ageDisplay, 'dc-sex': data.sex || p.sex, 'dc-weight': data.weight || p.weight,
        'dc-mrn': data.mrn || mrnOnly, 'dc-ward': data.ward || p.ward, 'dc-bed': data.bed || p.bed, 'dc-folder': data.folder || '',
        'dc-doa': data.doa || formatDateDDMMYYYY(p.doa), 'dc-dod': data.dod || formatDateDDMMYYYY(getLocalISODate()),
        'dc-diagnosis': data.diagnosis || p.diagnosis, 'dc-address': data.address || '', 'dc-ix': data.ix || ((type === 'neonate' || type === 'neonate_hx') ? "ALL ENCLOSED\nBG: , G6PD: " : "ALL ENCLOSED"), 'dc-review': data.review || "Follow up in P-OPD after 3 days"
    };

    if (type === 'neonate') { 
        map['dc-history'] = data.history || nbBirthHx; 
        map['dc-birth-hx-col1'] = data.birth_hx_1 || nbFindings; 
        map['dc-birth-hx-col2'] = data.birth_hx_2 || nbMeasurements; 
        map['dc-course'] = data.course || DEFAULTS.neo_course; 
        map['dc-review'] = data.review || DEFAULTS.neo_review;
    } else if (type === 'neonate_hx') { 
        map['dc-history'] = data.history || admHist; 
        const hasAdmGE = (admGeneralExamOnly && admGeneralExamOnly.trim().length > 0);
        map['dc-exam'] = data.exam || (hasAdmGE ? admExamFull : DEFAULTS.neohx_exam); 
        map['dc-birth-hx-col1'] = data.birth_hx_1 || nbBirthHx; 
        map['dc-birth-hx-col2'] = data.birth_hx_2 || nbMeasurements; 
        map['dc-course'] = data.course || ''; 
    } else { 
        map['dc-history'] = data.history || admHist; map['dc-exam'] = data.exam || admExamFull; map['dc-course'] = data.course || admissionCourse;
    }

    map['dc-maternal-hx'] = data.maternal_hx || nbMaternal;

    if (type === 'neonate') { map['dc-cond'] = data.cond || DEFAULTS.neo_cond; map['dc-rx'] = data.rx || DEFAULTS.neo_rx; } 
    else if (type === 'neonate_hx') { map['dc-cond'] = data.cond || DEFAULTS.neo_cond; map['dc-rx'] = data.rx || DEFAULTS.neohx_rx; } 
    else { map['dc-cond'] = data.cond || DEFAULTS.ped_cond; map['dc-rx'] = data.rx || DEFAULTS.ped_rx; }

    for (const [elId, val] of Object.entries(map)) {
        const el = document.getElementById(elId);
        if(el) { el.value = val; if(el.tagName === 'TEXTAREA') autoResize(el); }
    }
    renderDcHistory(p.logs);
}
    function renderDcHistory(logsStr) {
        const container = document.getElementById('dc-history-list');
        if(!logsStr) { container.innerHTML = "No history."; return; }
        let entries = logsStr.split('‚Ä¢').filter(e => e.trim().length > 0);
        let html = "";
        entries.forEach(e => {
            const lines = e.trim().split('\n');
            const datePart = lines[0].trim();
            const body = lines.slice(1).join('\n').trim();
            if(body) {
                html += `<div class="dc-history-item"><div class="dc-history-date">${datePart}</div><div class="dc-history-text">${body}</div></div>`;
            }
        });
        container.innerHTML = html;
    }

    function resetDcForm() {
        if(!currentDcPatientId) return;
        if(!confirm("WARNING: Wipe edits?")) return;
        selectDcPatient(currentDcPatientId, true);
        document.querySelector('#dc-form-container').dispatchEvent(new Event('input'));
    }

    document.querySelector('#dc-form-container').addEventListener('input', function(e) {
        if(e.target.tagName === 'TEXTAREA') autoResize(e.target);
        if(!currentDcPatientId) return;
        const data = {};
        document.querySelectorAll('#dc-form-container textarea').forEach(el => { const key = el.id.replace('dc-', '').replace(/-/g, '_'); data[key] = el.value; });
        db.collection('patients').doc(currentDcPatientId).update({ dischargeData: data });
    });
async function generateDcDocx() {
        await ensureDocxLibs(); // Load docx libraries if not already loaded
        if(!currentDcPatientId) { alert("Select a patient."); return; }

        const type = document.getElementById('dc-template-type').value;
        let url = DOCX_URL_PED;
        if(type === 'neonate') url = DOCX_URL_NEO;
        if(type === 'neonate_hx') url = DOCX_URL_NEO_HX;

        try {
            const response = await fetch(url);
            if(!response.ok) throw new Error("Template fetch failed");
            const content = await response.arrayBuffer();
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            
            let rawName = document.getElementById('dc-name').value;
            let nid = "";
            const match = rawName.match(/^(.*)\s*\((.*)\)$/);
            if (match) {
               rawName = match[1].trim(); 
               nid = match[2].trim();
            }

            const data = {
                name: rawName,
                nid: nid, 
                age: document.getElementById('dc-age').value,
                sex: document.getElementById('dc-sex').value,
                weight: document.getElementById('dc-weight').value,
                mrn: document.getElementById('dc-mrn').value,
                address: document.getElementById('dc-address').value,
                ward: document.getElementById('dc-ward').value,
                bed: document.getElementById('dc-bed').value,
                folder: document.getElementById('dc-folder').value,
                doa: document.getElementById('dc-doa').value,
                dod: document.getElementById('dc-dod').value,
                diagnosis: document.getElementById('dc-diagnosis').value,
                
                // MAPPINGS from the Textareas
                history: document.getElementById('dc-history').value, 
                exam: document.getElementById('dc-exam').value,
                maternal_hx: document.getElementById('dc-maternal-hx').value,
                birth_hx_1: document.getElementById('dc-birth-hx-col1').value,
                birth_hx_2: document.getElementById('dc-birth-hx-col2').value,
                
                investigations: document.getElementById('dc-ix').value,
                course: document.getElementById('dc-course').value,
                condition: document.getElementById('dc-cond').value,
                rx: document.getElementById('dc-rx').value,
                review: document.getElementById('dc-review').value,
                
                adm_cons: "",
                dis_cons: "DR. ALAA ADEL AHMED SAYED AHMED SOBEIH ELAMAWEY",
                prep_by: ""
            };

            doc.render(data);
            const out = doc.getZip().generate({ type:"blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            
            // Filename: [Hospital No] [Name].docx
            saveAs(out, `${data.mrn} ${rawName.split('(')[0].trim()}.docx`);
        } catch(e) {
            console.error(e); alert("Error: " + e.message);
        }
    }

    // --- JS MOBILE DETECTION & INITIALIZATION ---
    function checkMobile() {
       const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
       if(isMobile) {
           document.body.classList.add('is-mobile');
           document.getElementById('admSidebar').classList.remove('show');
       }
    }
    // --- AUTO-CLEANUP FUNCTION ---
    async function autoCleanup() {
        try {
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const snapshot = await db.collection('patients').where('ward', '==', 'Discharge').get();

            snapshot.forEach(async (doc) => {
                const patient = doc.data();
                const dischargeTime = patient.dischargeTimestamp || 0;

                // If discharged more than 7 days ago, delete
                if (dischargeTime > 0 && dischargeTime < sevenDaysAgo) {
                    console.log(`Auto-cleanup: Deleting patient ${doc.id} discharged on ${new Date(dischargeTime).toLocaleDateString()}`);

                    // Delete associated images from storage
                    if (patient.images && patient.images.length > 0) {
                        for (const img of patient.images) {
                            if (img.url && img.url.includes('firebasestorage')) {
                                try {
                                    await storage.refFromURL(img.url).delete();
                                } catch (e) {
                                    console.warn('Error deleting image:', e);
                                }
                            }
                        }
                    }

                    // Delete patient document
                    await doc.ref.delete();
                }
            });
        } catch (error) {
            console.error('Auto-cleanup error:', error);
        }
    }

    window.onload = function() {
        checkMobile();
        loadPatients();
        autoCleanup();
        document.getElementById("handoverDate").innerText = getLocalISODate();
        fetch(ANCHORS_URL).then(r=>r.json()).then(d=> anchors = d.anchorsByPage || d);
    }

    // --- MAIN LOGIC ---
    let currentPatientId=null, localPatients={}, chartInstance=null;
    document.getElementById("doa").value = getLocalISODate();

    // --- HANDOVER SUMMARY ---
// --- HANDOVER SUMMARY & NOTES ---
    let notesDebounce;
    function saveNotes(val) {
        clearTimeout(notesDebounce);
        notesDebounce = setTimeout(() => {
            // Save notes securely (merge:true ensures we don't wipe numbers)
            db.collection('summaries').doc('current').set({ notes: val }, { merge: true });
        }, 1000);
    }

    function recalcSummary() {
      const d={
        adM:+document.getElementById('adM').value||0, adE:+document.getElementById('adE').value||0, adN:+document.getElementById('adN').value||0,
        disM:+document.getElementById('disM').value||0, disE:+document.getElementById('disE').value||0, disN:+document.getElementById('disN').value||0,
        // CRITICAL FIX: Include notes here so saving numbers doesn't erase them
        notes: document.getElementById('notesText').value 
      };
      document.getElementById('totalAd').innerText=d.adM+d.adE+d.adN; document.getElementById('totalDis').innerText=d.disM+d.disE+d.disN;
      
      // Save entire object
      db.collection('summaries').doc('current').set(d, {merge: true});
    }

    // Load Data on Startup
    db.collection('summaries').doc('current').get().then(doc=>{ 
        if(doc.exists){ 
            const d=doc.data(); 
            ['adM','adE','adN','disM','disE','disN'].forEach(k=>document.getElementById(k).value=d[k]||0); 
            
            // FIX: Load the saved notes back into the textarea
            if(d.notes) document.getElementById('notesText').value = d.notes;
            
            recalcSummary(); 
        } 
    });

    // --- PATIENT LOADING ---
    function loadPatients() {
      const container = document.getElementById('wardsContainer');
      const wards = ["PW","GW","SW","PVT","ICU","NICU","ER","Discharge"];
      
      if(container.innerHTML === '') {
          wards.forEach(w => {
             const sec = document.createElement('div');
             const h = document.createElement('h2');
             const g = document.createElement('div');
             
             h.className = 'ward-header'; 
             if(w === 'Discharge'){ 
                 h.classList.add('discharge-header'); 
                 h.onclick = () => toggleDischarge(w);
                 h.innerText = `${w} (Click to load)`;
             } else {
                 h.innerText = `${w} (0)`;
             }
             
             h.style.background = `var(--${w})`; 
             h.id = `header-${w}`;
             
             g.className = 'card-grid'; 
             g.id = `ward-${w}`;
             
             if(w !== 'Discharge') g.classList.add('expanded');
             
             sec.appendChild(h); 
             sec.appendChild(g); 
             container.appendChild(sec); 
          });
      }
      setupRealtimeListeners();
    }

    function setupRealtimeListeners() {
        if(activeUnsub) activeUnsub();
        
        activeUnsub = db.collection('patients').where('ward', 'in', activeWards).onSnapshot(snap => {
            const counts = {}; 
            activeWards.forEach(w => counts[w] = 0);
            let totalActive = 0;

            snap.docChanges().forEach(change => {
                const p = change.doc.data(); 
                p.docId = change.doc.id; 
                
                if (change.type === 'added' || change.type === 'modified') {
                    localPatients[p.docId] = p;
                    renderCardInCorrectWard(p);
                }
                if (change.type === 'removed') {
                    removeCard(p.docId);
                    delete localPatients[p.docId];
                }
            });

            snap.docs.forEach(doc => {
               const d = doc.data();
               if(counts[d.ward] !== undefined) counts[d.ward]++;
               totalActive++;
            });

            document.getElementById('totalCount').innerText = totalActive;
            const bdText = activeWards.map(w => `${w} (${counts[w]||0})`).join(', ');
            if(document.getElementById('wardBreakdown')) document.getElementById('wardBreakdown').innerText = bdText;
            
            activeWards.forEach(w => {
               document.getElementById(`header-${w}`).innerText = `${w} (${counts[w]})`;
            });

            if(currentPatientId && localPatients[currentPatientId]) refreshModalIfOpen();
        });
    }

    function renderCardInCorrectWard(p) {
        const gridId = `ward-${p.ward}`;
        const grid = document.getElementById(gridId);
        if (!grid) return;

        let c = document.getElementById(`card-${p.docId}`);
        if(!c) {
            c = createCard(p); 
            const cards = Array.from(grid.children);
            let inserted = false;
            
            if (p.ward === 'Discharge') {
                 const myTime = p.dischargeTimestamp || p.timestamp || 0;
                 for(let existingCard of cards) {
                     const exP = localPatients[existingCard.getAttribute('data-id')];
                     if(exP && (exP.dischargeTimestamp||exP.timestamp) < myTime) {
                         grid.insertBefore(c, existingCard);
                         inserted = true;
                         break;
                     }
                 }
            } else {
                 const myBed = parseInt(p.bed) || 0;
                 for(let existingCard of cards) {
                     const exP = localPatients[existingCard.getAttribute('data-id')];
                     if(exP && (parseInt(exP.bed)||0) > myBed) {
                         grid.insertBefore(c, existingCard);
                         inserted = true;
                         break;
                     }
                 }
            }
            
            if(!inserted) grid.appendChild(c);
        } else { 
            if(c.parentElement !== grid) grid.appendChild(c);
            updateCardDOM(c, p);
        }
    }

    function removeCard(id) {
        const c = document.getElementById(`card-${id}`);
        if(c) c.remove();
    }

    function toggleDischarge(w) { 
        if (w !== 'Discharge') return;

        const grid = document.getElementById(`ward-Discharge`);
        const header = document.getElementById(`header-Discharge`);
        
        isDischargeExpanded = !isDischargeExpanded;
        grid.classList.toggle('expanded'); 
        header.classList.toggle('expanded'); 

        if (isDischargeExpanded && !dischargeUnsub) {
            header.innerText = "Discharge (Loading...)";
            dischargeUnsub = db.collection('patients').where('ward', '==', 'Discharge').onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    const p = change.doc.data(); 
                    p.docId = change.doc.id; 
                    
                    if(change.type === 'added' || change.type === 'modified') {
                        localPatients[p.docId] = p;
                        renderCardInCorrectWard(p);
                    }
                    if(change.type === 'removed') {
                        removeCard(p.docId);
                        delete localPatients[p.docId];
                    }
                });
                header.innerText = `Discharge (${snap.size})`;
            });
        }
    }

    function createCard(p) {
        const id=p.docId, c=document.createElement('div'); c.className='patient-card'; c.id=`card-${id}`; c.setAttribute('data-id',id);
        const days=calculateDaysAdmitted(p.doa), age=p.isAutoAge&&p.dob&&p.dot?calculateNeonatalAge(p.dob,p.dot).display:p.age;
        
        const isDischarged = p.ward === 'Discharge';
        const disText = isDischarged ? `Discharged ${formatTimestamp(p.dischargeTimestamp||p.timestamp||Date.now())}` : '';
        const disTag=`<span class="discharge-badge ${isDischarged?'discharge-active':''} card-ctrl">${disText}</span>`;
        
        c.innerHTML = `
             <button class="expand-btn card-ctrl" onclick="openModal('${id}')">‚õ∂</button>
             <button class="delete-btn card-ctrl" onclick="deletePatient('${id}')">√ó</button>
             <span class="new-badge${p.isNew?' new-active':''} card-ctrl">NEW</span>${disTag}
             
             <p><strong>Name:</strong> <span data-field="name" contenteditable class="editable" onblur="updateField('${id}','name',this.innerText)">${p.name}</span></p>
             <p><strong>HNo:</strong> <span data-field="id" contenteditable class="editable" onblur="updateField('${id}','id',this.innerText)">${p.id||''}</span></p>
             <p><strong>NID:</strong> <span data-field="nid" contenteditable class="editable" onblur="updateField('${id}','nid',this.innerText)">${p.nid||''}</span></p>
             <p><strong>DOA:</strong> <span data-field="doa" contenteditable class="editable" onblur="updateField('${id}','doa',this.innerText)">${p.doa||''}</span> <span>(${days})</span></p>
             <p><strong>Shift:</strong> <span data-field="shift" contenteditable class="editable" onblur="updateField('${id}','shift',this.innerText)">${p.shift||''}</span></p>
             <p><strong>Bed:</strong> <span data-field="bed" contenteditable class="editable" onblur="updateField('${id}','bed',this.innerText)">${p.bed||''}</span></p>
             <p><strong onclick="toggleAgeMode('${id}')">Age:</strong> <span data-field="age" id="age-disp-${id}" contenteditable="${!p.isAutoAge}" onblur="updateField('${id}','age',this.innerText)">${age}</span><span id="cga-label-${id}">${getLiveCGA(p)}</span>

             <div class="age-toggle" id="age-toggle-${id}">
                <label><input type="radio" name="ageMode-${id}" value="manual" ${!p.isAutoAge?'checked':''} onchange="toggleAutoInputs('${id}')"> Man</label>
                <label><input type="radio" name="ageMode-${id}" value="auto" ${p.isAutoAge?'checked':''} onchange="toggleAutoInputs('${id}')"> Auto</label>
                <div class="auto-age-inputs" id="auto-age-${id}" style="display:${p.isAutoAge?'flex':'none'}">
                   <input type="date" id="dob-${id}" value="${p.dob||''}" onblur="saveAgeMode('${id}')"><input type="time" id="dot-${id}" value="${p.dot||''}" onblur="saveAgeMode('${id}')">
                </div>
                <div style="margin-top:6px; padding-top:6px; border-top:1px dashed #ccc;">
                   <label style="font-weight:600; display:block; margin-bottom:4px;">GA (Gestational Age)</label>
                   <div style="display:flex; gap:6px; align-items:center;">
                      <input type="number" id="ga-weeks-${id}" placeholder="Weeks" min="0" max="50" value="${p.gaWeeks||''}" style="padding:4px; width:60px;" onblur="saveGAData('${id}')">
                      <span>weeks</span>
                      <input type="number" id="ga-days-${id}" placeholder="Days" min="0" max="6" value="${p.gaDays||''}" style="padding:4px; width:50px;" onblur="saveGAData('${id}')">
                      <span>days</span>
                   </div>
                </div>
             </div>
             
             <p class="inline-fields"><strong>Sex:</strong> <span data-field="sex" contenteditable class="editable" onblur="updateField('${id}','sex',this.innerText)">${p.sex||''}</span></p>
             <p><strong>Weight:</strong> <span data-field="weight" contenteditable class="editable" onblur="updateField('${id}','weight',this.innerText)">${p.weight||''}</span></p>
             <p><strong>Diagnosis:</strong> <span data-field="diagnosis" contenteditable class="editable" onblur="updateField('${id}','diagnosis',this.innerText)">${p.diagnosis||''}</span></p>
             <p><strong>Medications:</strong></p><p><span data-field="medications" contenteditable class="editable" onblur="updateField('${id}','medications',this.innerText)">${p.medications||''}</span></p>
             <p><strong>Issues:</strong> <span data-field="issues" contenteditable class="editable" onblur="updateField('${id}','issues',this.innerText)">${p.issues||''}</span></p>
             
             <p><strong class="hopi-toggle" id="hopi-toggle-btn-${id}" onclick="toggleHopi('${id}')">HOPI:</strong></p>
             <div class="hopi-content" id="hopi-content-${id}">
                <span data-field="hopi" contenteditable class="editable" onblur="updateField('${id}','hopi',this.innerText)">${p.hopi||''}</span>
             </div>
             
             <p style="display:flex; justify-content:space-between; align-items:center;">
                <strong class="hopi-toggle" id="plan-toggle-btn-${id}" onclick="togglePlanHist('${id}')">Plan History:</strong>
                <span class="edit-history-link" id="card-edit-link-${id}" style="display:none;" onclick="toggleEditHistory('${id}', 'card')">Edit</span>
             </p>
             <div class="hopi-content plan-history" id="plan-hist-${id}">
                ${formatLogsToHtml(p.logs || '', id, false, true)}
             </div>

             <div class="recent-logs-container" id="recent-logs-${id}">
                ${formatLogsToHtml(p.logs || '', id, true, false)}
             </div>

             <p><strong class="current-plan-label">Current plan:</strong></p>
             <p><span contenteditable class="editable" id="new-plan-${id}" oninput="saveDraftPlan('${id}', this.innerText); checkLogInput('${id}');">${p.currentPlanDraft || ''}</span></p>
             
             <button class="log-btn" id="btn-log-${id}" ${(p.currentPlanDraft && p.currentPlanDraft.trim().length > 0) ? '' : 'disabled'} onclick="logPlan('${id}')">Log</button>
             
             <p><strong>Ward:</strong><select onchange="changeWard('${id}',this.value)">${["PW","GW","SW","PVT","ICU","NICU","ER","Discharge"].map(w=>`<option value="${w}" ${w===p.ward?'selected':''}>${w}</option>`).join('')}</select></p>
             <div class="new-checkbox"><label><input type="checkbox" ${p.isNew?'checked':''} onchange="toggleNew('${id}')"> New</label></div>
        `;
        return c;
    }

    let draftTimeout;
    function saveDraftPlan(id, text) {
        clearTimeout(draftTimeout);
        draftTimeout = setTimeout(() => {
            db.collection('patients').doc(id).update({ currentPlanDraft: text });
        }, 800);
    }

    function updateCardDOM(c, p) {
        const fields = ['name', 'id', 'nid', 'doa', 'shift', 'bed', 'age', 'sex', 'weight', 'diagnosis', 'medications', 'issues', 'hopi'];
        fields.forEach(f => {
            const el = c.querySelector(`[data-field="${f}"]`);
            if (el && document.activeElement !== el) {
                let val = p[f] || '';
                if (f === 'age' && p.isAutoAge && p.dob && p.dot) val = calculateNeonatalAge(p.dob, p.dot).display;
                if (f === 'doa') {
                    if(el.innerText !== val) el.innerText = val;
                    if(el.nextElementSibling) el.nextElementSibling.innerText = `(${calculateDaysAdmitted(val)})`;
                } else {
                    if(el.innerText !== val) el.innerText = val;
                }
            }
        });
        
        const badge = c.querySelector('.discharge-badge');
        if (badge) {
            if(p.ward === 'Discharge') {
                badge.classList.add('discharge-active');
                badge.innerText = `Discharged ${formatTimestamp(p.dischargeTimestamp||p.timestamp||Date.now())}`;
            } else {
                badge.classList.remove('discharge-active');
            }
        }

        const sel = c.querySelector('select');
        if (sel && document.activeElement !== sel && sel.value !== p.ward) sel.value = p.ward;

        const hist = c.querySelector(`#plan-hist-${p.docId}`);
        if (hist && !hist.classList.contains('editing-mode')) {
            const newHTML = formatLogsToHtml(p.logs || '', p.docId, false, true);
            if (hist.innerHTML !== newHTML) hist.innerHTML = newHTML;
        }

        const recent = c.querySelector(`#recent-logs-${p.docId}`);
        if(recent) {
            const newRecent = formatLogsToHtml(p.logs || '', p.docId, true, false);
            if(recent.innerHTML !== newRecent) recent.innerHTML = newRecent;
        }

        // Update CGA label - LIVE CALCULATION
const cgaLabel = c.querySelector(`#cga-label-${p.docId}`);
if (cgaLabel) {
    const cgaText = getLiveCGA(p);
    if (cgaLabel.innerText !== cgaText) cgaLabel.innerText = cgaText;
}

        // Update GA input fields
        const gaWeeksInput = document.getElementById(`ga-weeks-${p.docId}`);
        const gaDaysInput = document.getElementById(`ga-days-${p.docId}`);
        if (gaWeeksInput && document.activeElement !== gaWeeksInput) gaWeeksInput.value = p.gaWeeks || '';
        if (gaDaysInput && document.activeElement !== gaDaysInput) gaDaysInput.value = p.gaDays || '';

        const planInput = document.getElementById(`new-plan-${p.docId}`);
        const logBtn = document.getElementById(`btn-log-${p.docId}`);
        
        if(planInput && document.activeElement !== planInput) {
            const draftText = p.currentPlanDraft || '';
            if(planInput.innerText !== draftText) planInput.innerText = draftText;
        }
        
        if(logBtn) {
            const hasDraft = (p.currentPlanDraft && p.currentPlanDraft.trim().length > 0);
            logBtn.disabled = !hasDraft;
        }
    }

    function updateField(id,f,v) { db.collection('patients').doc(id).update({[f]:v}); }
    
    function toggleHopi(id) { 
        document.getElementById(`hopi-content-${id}`).classList.toggle('expanded');
        document.getElementById(`hopi-toggle-btn-${id}`).classList.toggle('expanded');
    }
    
    function togglePlanHist(id) { 
        const isExpanded = document.getElementById(`plan-hist-${id}`).classList.toggle('expanded');
        document.getElementById(`plan-toggle-btn-${id}`).classList.toggle('expanded');
        
        const editLink = document.getElementById(`card-edit-link-${id}`);
        if(editLink) editLink.style.display = isExpanded ? 'block' : 'none';
        
        const recentLogs = document.getElementById(`recent-logs-${id}`);
        if(recentLogs) recentLogs.style.display = isExpanded ? 'none' : 'block';
        
        if(!isExpanded) {
            const listEl = document.getElementById(`full-list-${id}`);
            if(listEl && listEl.classList.contains('editing-mode')) {
                toggleEditHistory(id, 'card');
            }
        }
    }
    
    function toggleAgeMode(id) { const e=document.getElementById(`age-toggle-${id}`); e.style.display=e.style.display==='block'?'none':'block'; }
    function toggleAutoInputs(id) { const a=document.querySelector(`#age-toggle-${id} input[value='auto']`).checked; document.getElementById(`auto-age-${id}`).style.display=a?'flex':'none'; document.getElementById(`age-disp-${id}`).contentEditable=!a; saveAgeMode(id); }
    function saveAgeMode(id) { const a=document.querySelector(`#age-toggle-${id} input[value='auto']`).checked, dob=document.getElementById(`dob-${id}`).value, dot=document.getElementById(`dot-${id}`).value, u={isAutoAge:a,dob,dot}; if(a&&dob&&dot) u.age=calculateNeonatalAge(dob,dot).display; db.collection('patients').doc(id).update(u); }

    function saveGAData(id) {
    const gaWeeks = parseInt(document.getElementById(`ga-weeks-${id}`).value) || 0;
    const gaDays = parseInt(document.getElementById(`ga-days-${id}`).value) || 0;
    
    // We ONLY save the inputs (Birth GA). 
    // We do NOT save the calculated CGA result to DB anymore.
    // The display logic (getLiveCGA) handles the math.
    const update = { gaWeeks, gaDays };

    // Update the DB with the new Birth GA
    db.collection('patients').doc(id).update(update).then(() => {
        // Force a visual update immediately so the user sees the change
        if (localPatients[id]) {
            localPatients[id].gaWeeks = gaWeeks;
            localPatients[id].gaDays = gaDays;
            const cgaLabel = document.getElementById(`cga-label-${id}`);
            if(cgaLabel) cgaLabel.innerText = getLiveCGA(localPatients[id]);
        }
    });
}

    function changeWard(id,w) { const u={ward:w}; if(w==='Discharge') u.dischargeTimestamp=Date.now(); db.collection('patients').doc(id).update(u); }
    function toggleNew(id) { db.collection('patients').doc(id).get().then(d=>db.collection('patients').doc(id).update({isNew:!d.data().isNew})); }
    
    // Global variable to store patient ID for action modal
    let pendingActionPatientId = null;

    // Open patient action modal (Discharge or Delete)
    function deletePatient(id) {
       pendingActionPatientId = id;
       document.getElementById('patientActionModal').classList.add('active');
    }

    function closePatientActionModal() {
       document.getElementById('patientActionModal').classList.remove('active');
    }

    function handleDischargeAction() {
       if(!pendingActionPatientId) return;

       // Discharge the patient automatically (no shift selection for now)
       changeWard(pendingActionPatientId, 'Discharge');
       closePatientActionModal();
       pendingActionPatientId = null;
    }

    function handleDeleteAction() {
       if(!pendingActionPatientId) return;
       closePatientActionModal();

       if(confirm("WARNING: Permanently delete record AND X-RAYS?")) {
         const id = pendingActionPatientId;
         pendingActionPatientId = null;

         db.collection('patients').doc(id).get().then(d=>{
             if(d.exists) {
               const i=d.data().images||[];
               const ps=i.map(x=>(x.url&&x.url.includes('firebasestorage'))?storage.refFromURL(x.url).delete().catch(e=>console.warn(e)):Promise.resolve());
               Promise.all(ps).finally(()=>db.collection('patients').doc(id).delete());
             } else {
               db.collection('patients').doc(id).delete();
             }
         });
       } else {
         pendingActionPatientId = null;
       }
    }
    
    function logPlan(id) {
        const inputEl = document.getElementById(`new-plan-${id}`);
        const btn = document.getElementById(`btn-log-${id}`);
        const content = inputEl.innerText.trim();
        if(!content) return;
        
        inputEl.innerText = '';
        btn.disabled = true;

        const p = localPatients[id];
        const ts = formatTimestamp(Date.now());
        const days = calculateDaysAdmitted(p.doa);
        const newEntry = `‚Ä¢ ${ts} (${days})\n ${content}\n\n`;
        const updatedLogs = (p.logs || '') + newEntry;

        db.collection('patients').doc(id).update({
            logs: updatedLogs,
            plan: content, 
            lastLoggedPlan: content,
            currentPlanDraft: '' 
        }).catch(e => {
            console.error("Log failed", e);
            inputEl.innerText = content;
            btn.disabled = false;
            alert("Failed to save log. Please try again.");
        });
    }

    function toggleForm() { 
        const f=document.getElementById('formSection'); 
        f.style.display=f.style.display==='block'?'none':'block'; 
        if(f.style.display === 'block') {
            document.getElementById('doa').value = getLocalISODate();
            document.getElementById('shift').value = getCurrentShift();
        }
    }
    function toggleAutoInputsForm() { 
        const el = document.getElementById('form-radio-auto');
        const a = el ? el.checked : false;
        document.getElementById('form-auto-age-inputs').style.display=a?'flex':'none'; 
    }
    function addPatient() {
       const autoRadio = document.getElementById('form-radio-auto');
       const a = autoRadio ? autoRadio.checked : false;
       const dob=document.getElementById('dob').value, dot=document.getElementById('dot').value;
       let age=document.getElementById('age').value; if(a&&dob&&dot) age=calculateNeonatalAge(dob,dot).display;

       const initialPlan = document.getElementById('plan').value;
       let initialLogs = `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Record Created.\n\n`;
       if(initialPlan) {
           initialLogs += `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Plan:\n${initialPlan}\n\n`;
       }

       db.collection('patients').add({
         name:document.getElementById('name').value,
         id:document.getElementById('hno').value,
         nid:document.getElementById('nid').value,
         doa:document.getElementById('doa').value,
         age, dob:dob||'', dot:dot||'', isAutoAge:a, shift:document.getElementById('shift').value, bed:document.getElementById('bed').value,
         sex:document.getElementById('sex').value, weight:document.getElementById('weight').value, diagnosis:document.getElementById('diagnosis').value,
         medications:document.getElementById('medications').value, issues:document.getElementById('issues').value, hopi:document.getElementById('hopi').value,
         ward:document.getElementById('ward').value, plan:initialPlan, isNew:document.getElementById('isNew').checked,
         timestamp:Date.now(), logs: initialLogs, lastLoggedPlan: initialPlan, labs:{dates:[],tests:{}}, images:[]
       }).then(()=>document.getElementById('formSection').style.display='none');
    }
    function toggleDarkMode() { const h=document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark'); }

    // --- DETAIL MODAL ---
    function openModal(id) {
    currentPatientId=id; const p=localPatients[id]; if(!p)return;
    document.getElementById('detailModal').classList.add('active'); 
    document.getElementById('modalTitle').innerText=`${p.name} - Details`;
    
    // Standard fields (Removed 'age' from loop to handle it dynamically)
    ['name','id','ward','bed','sex','weight','diagnosis','medications','issues'].forEach(f=>{ 
        const e=document.getElementById(`det-${f}`); 
        if(e)e.innerText=p[f]||''; 
    });

    // DYNAMIC AGE FIX
    const ageEl = document.getElementById('det-age');
    if(ageEl) ageEl.innerText = getDisplayAge(p);

    // Handle HOPI with admission plan
    const hopiEl = document.getElementById('det-hopi');
    if(hopiEl) {
        let hopiText = p.hopi || '';
        const admPlan = getFirstLoggedPlan(p.logs);
        if(admPlan) {
            hopiText = hopiText ? `${hopiText}\n\n<strong>Admission Plan:</strong>\n${admPlan}` : `<strong>Admission Plan:</strong>\n${admPlan}`;
        }
        hopiEl.innerHTML = hopiText;
    }

    const hosp = document.getElementById('det-hosp');
    const nid = document.getElementById('det-nid');
    if(hosp) hosp.innerText = p.id || '';
    if(nid) nid.innerText = p.nid || '';

    renderLabMatrix(); renderImages(); renderHistory(); switchTab('details');
}

function refreshModalIfOpen() {
    if(!currentPatientId || !document.getElementById('detailModal').classList.contains('active')) return;
    const p=localPatients[currentPatientId]; if(!p)return;
    
    // Standard fields
    ['name','id','ward','bed','sex','weight','diagnosis','medications','issues'].forEach(f=>{ 
        const e=document.getElementById(`det-${f}`); 
        if(e&&document.activeElement!==e)e.innerText=p[f]||''; 
    });

    // DYNAMIC AGE FIX
    const ageEl = document.getElementById('det-age');
    if(ageEl && document.activeElement !== ageEl) ageEl.innerText = getDisplayAge(p);

    const hopiEl = document.getElementById('det-hopi');
    if(hopiEl && document.activeElement !== hopiEl) {
        let hopiText = p.hopi || '';
        const admPlan = getFirstLoggedPlan(p.logs);
        if(admPlan) {
            hopiText = hopiText ? `${hopiText}\n\n<strong>Admission Plan:</strong>\n${admPlan}` : `<strong>Admission Plan:</strong>\n${admPlan}`;
        }
        hopiEl.innerHTML = hopiText;
    }
    if(document.getElementById('tab-labs').classList.contains('active')) renderLabMatrix();
    if(document.getElementById('tab-imaging').classList.contains('active')) renderImages();
    if(document.getElementById('tab-history').classList.contains('active')) renderHistory();
}
    function closeModal() { document.getElementById('detailModal').classList.remove('active'); currentPatientId=null; }
    window.onclick = function(e) { if(e.target==document.getElementById('detailModal'))closeModal(); if(e.target==document.getElementById('admissionModal'))closeAdmissionModal(); if(e.target==document.getElementById('lightbox'))closeLightbox(); if(e.target==document.getElementById('patientActionModal'))closePatientActionModal(); }
    async function switchTab(id) {
       document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
       const btn=Array.from(document.querySelectorAll('.tab-btn')).find(b=>b.getAttribute('onclick').includes(id)); if(btn)btn.classList.add('active');
       document.getElementById(`tab-${id}`).classList.add('active');
       if(id==='labs') {
           await ensureChartJS(); // Load Chart.js if not already loaded
           renderLabMatrix();
       }
    }
    function updateFromDetail(f,v) {
        if(!currentPatientId) return;

        // Special handling for HOPI - strip admission plan before saving
        if(f === 'hopi') {
            // Remove "Admission Plan:" section (everything after it)
            v = v.split(/\n\s*Admission Plan\s*:/i)[0].trim();
        }

        db.collection('patients').doc(currentPatientId).update({[f]:v});
    }
    
    function updateIdFromDetail() {
        if(!currentPatientId) return;
        const h = document.getElementById('det-hosp').innerText.trim();
        const n = document.getElementById('det-nid').innerText.trim();
        db.collection('patients').doc(currentPatientId).update({id: h, nid: n});
    }

    /* --- PRINT SYSTEM FUNCTIONS --- */

// 1. Toggle Dropdown (Fixes Mobile/Tablet issue)
function togglePrintDropdown() {
    document.getElementById("printDropdown").classList.toggle("show");
}

// Close dropdown if clicked outside
window.onclick = function(event) {
    if (!event.target.matches('.dropdown-btn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < dropdowns.length; i++) {
            var openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
    // Keep existing modal close logic
    if (event.target == document.getElementById('detailModal')) closeModal();
    if (event.target == document.getElementById('admissionModal')) closeAdmissionModal();
    if (event.target == document.getElementById('lightbox')) closeLightbox();
    if (event.target == document.getElementById('patientActionModal')) closePatientActionModal();
}

// 2. Standard Reports (Print All, Ward, NICU)
function printReport(t, wl) {
    const d = document.getElementById('handoverDate').innerText;
    let txt = `HANDOVER REPORT - ${t} - ${d}\n\n`; // Changed const to let

    wl.forEach(w => {
        const l = Object.values(localPatients).filter(p => p.ward === w);
        if (l.length > 0) {
            txt += `--- ${w} (${l.length}) ---\n`;
            l.sort((a, b) => (parseInt(a.bed) || 0) - (parseInt(b.bed) || 0));
            l.forEach(p => {
                txt += `BED ${p.bed}: ${p.name} (${p.age}/${p.sex})\n   Dx: ${p.diagnosis}\n   Plan: ${p.plan}\n\n`;
            });
        }
    });

    const w = window.open('', '_blank');
    if (!w) { alert("‚ö†Ô∏è POPUP BLOCKED\nPlease allow popups for this site."); return; }
    
    w.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${txt}</pre>`);
    w.document.close();
    w.print();
}

function printAll() { printReport('ALL', ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER"]); }
function printNICU() { printReport('NICU', ["NICU"]); }
function printWard() { printReport('WARD', ["PW", "GW", "SW", "PVT", "ICU"]); }

// 3. Print New (Detailed Format)
function printNew() {
    const d = document.getElementById('handoverDate').innerText;
    let txt = `NEW ADMISSIONS DETAILED REPORT - ${d}\n\n`;

    // Filter New Patients
    const newPatients = Object.values(localPatients).filter(p => p.isNew);
    
    if (newPatients.length === 0) { alert("No new patients marked."); return; }

    // Group by Ward
    const grouped = {};
    newPatients.forEach(p => {
        if (!grouped[p.ward]) grouped[p.ward] = [];
        grouped[p.ward].push(p);
    });

    const wardOrder = ["NICU", "ICU", "PW", "GW", "SW", "PVT", "ER"];
    
    wardOrder.forEach(ward => {
        if (grouped[ward]) {
            txt += `--- ${ward} (${grouped[ward].length}) ---\n`;
            
            // Sort by Bed
            grouped[ward].sort((a, b) => (parseInt(a.bed) || 0) - (parseInt(b.bed) || 0));

            grouped[ward].forEach(p => {
                // Header
                txt += `BED ${p.bed}: ${p.name} (${p.age || '?'}/${p.sex || '?'})\n`;
                txt += `Weight: ${p.weight || '-'}\n`;
                txt += `----------------------------------------\n`;

                // Diagnosis
                txt += `DIAGNOSIS:\n${p.diagnosis || ''}\n\n`;

                // Meds & Issues
                if (p.medications && p.medications.trim()) txt += `MEDICATIONS:\n${p.medications}\n\n`;
                if (p.issues && p.issues.trim()) txt += `ISSUES:\n${p.issues}\n\n`;

                // HOPI / Plan (Content only, no label)
                if (p.hopi && p.hopi.trim()) {
                    txt += `${p.hopi.trim()}\n`;
                }
                
                txt += `\n\n========================================\n\n`;
            });
        }
    });

    const w = window.open('', '_blank');
    if (!w) { alert("‚ö†Ô∏è POPUP BLOCKED"); return; }
    
    w.document.write(`
        <html>
            <head><title>New Admissions Report</title></head>
            <body>
                <pre style="font-family:monospace; white-space:pre-wrap; font-size:14px;">${txt}</pre>
                <script>window.onload = function() { window.print(); }<\/script>
            </body>
        </html>`
    );
    w.document.close();
}

// 4. Single Patient Print (Detailed Format)
function printPatientDetails() {
    const d = document.getElementById('handoverDate').innerText;
    
    const getTxt = (id) => {
        const el = document.getElementById(id);
        return el ? el.innerText.trim() : '';
    };

    let txt = `PATIENT DETAIL REPORT - ${d}\n\n`;

    // Header Block
    txt += `NAME: ${getTxt('det-name')}\n`;
    
    let idLine = `ID:   ${getTxt('det-hosp')}`;
    if (getTxt('det-nid')) idLine += ` | NID: ${getTxt('det-nid')}`;
    txt += `${idLine}\n\n`; 

    txt += `${getTxt('det-ward')} - Bed ${getTxt('det-bed')}, ${getTxt('det-age')} / ${getTxt('det-sex')}\n`;
    txt += `Weight: ${getTxt('det-weight')}\n`;
    txt += `----------------------------------------\n\n`;

    // Details
    txt += `DIAGNOSIS:\n${getTxt('det-diagnosis')}\n\n`;

    const meds = getTxt('det-medications');
    if (meds) txt += `MEDICATIONS:\n${meds}\n\n`;

    const issues = getTxt('det-issues');
    if (issues) txt += `ISSUES:\n${issues}\n\n`;

    // HOPI / Plan (Content only)
    const hopi = getTxt('det-hopi');
    if (hopi) txt += `${hopi}\n`;

    const w = window.open('', '_blank');
    if (!w) { alert("‚ö†Ô∏è POPUP BLOCKED"); return; }

    w.document.write(`
        <html>
            <head><title>${getTxt('det-name')} - Details</title></head>
            <body>
                <pre style="font-family:monospace; white-space:pre-wrap; font-size:14px;">${txt}</pre>
                <script>window.onload = function() { window.print(); }<\/script>
            </body>
        </html>`
    );
    w.document.close();
}
// --- NEW FUNCTION: Auto-populate standard labs ---
    function loadStandardLabs() {
        const p = localPatients[currentPatientId];
        // Safely get existing labs or create empty structure
        const l = p.labs || { dates: [], tests: {} };
        
        // Your requested standard list
        const standardTests = [
            "Hb", "PCV", "TLC", "N", "L", "PLT", 
            "CRP", "Procal", 
            "Na", "K", 
            "TSB", "DSB", "AST", "ALT", 
            "Urea", "BUN", "Creat", "URE", 
            "Blood C/S", "Urine C/S"
        ];

        // If no dates exist (new table), add today's date automatically
        if (l.dates.length === 0) {
            const t = new Date();
            l.dates.push(`${t.getDate()}/${t.getMonth()+1}`);
        }

        // Loop through standard tests and add them ONLY if they don't exist
        standardTests.forEach(test => {
            if (!l.tests[test]) {
                // Create an array of "-" placeholders matching the number of date columns
                l.tests[test] = new Array(l.dates.length).fill("-");
            }
        });

        // Save to Firebase (this will trigger the listener to re-render the table)
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }
// --- NEW LABS LOGIC (ARRAY BASED) ---

    // 1. Convert old Object format to Array format on the fly
    function ensureLabArrayFormat(p) {
        let labs = p.labs || { dates: [], tests: {}, rows: [] };
        
        // If "rows" doesn't exist but "tests" does, migrate data!
        if (!labs.rows && labs.tests) {
            console.log("Migrating labs to ordered array...");
            labs.rows = Object.keys(labs.tests).map(k => ({
                name: k,
                vals: labs.tests[k]
            }));
            delete labs.tests; // Remove old format
            
            // Save immediately so it sticks
            db.collection('patients').doc(currentPatientId).update({labs: labs});
        }
        
        // Ensure structure exists
        if (!labs.rows) labs.rows = [];
        if (!labs.dates) labs.dates = [];
        
        return labs;
    }
// --- NEW: Delete Column Logic ---
    function delLabCol(index) {
        if(!confirm("Delete this entire Date column?")) return;
        
        const p = localPatients[currentPatientId];
        const l = p.labs;

        // 1. Remove the Date Header
        l.dates.splice(index, 1);

        // 2. Remove the value at this index from EVERY test row
        l.rows.forEach(row => {
            if (row.vals && row.vals.length > index) {
                row.vals.splice(index, 1);
            }
        });

        db.collection('patients').doc(currentPatientId).update({labs: l});
    }
    // 2. Main Render Function
function renderLabMatrix() {
        const p = localPatients[currentPatientId];
        const labs = ensureLabArrayFormat(p); 
        
        const t = document.getElementById('labMatrix'); 
        t.innerHTML = '';

        // --- 1. Sleek Header (with Delete Column) ---
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');
        
        // Corner Header
        let h = `<th style="width:45px; text-align:center; font-size:11px; color:#999;">ACTIONS</th>
                 <th style="min-width:60px;"></th>`; 
        
        // Date Headers
        labs.dates.forEach((d, i) => {
            h += `
                <th>
                    <div class="col-header-wrapper">
                        <input type="text" value="${d}" onblur="upLabDate(${i},this.value)" 
                               style="text-align:center; font-weight:bold; border-bottom:2px solid var(--primary); padding:4px;">
                        <button class="btn-del-col" onclick="delLabCol(${i})">Delete</button>
                    </div>
                </th>`;
        });
        
        // Add Date Button
        h += `<th style="vertical-align:top;"><button class="btn-sm" style="font-size:10px; padding:2px 6px;" onclick="addLabCol()">+ Date</button></th>`;
        
        tr.innerHTML = h; 
        thead.appendChild(tr); 
        t.appendChild(thead);

        // --- 2. Body (Rows with Icon Toolbar) ---
        const tbody = document.createElement('tbody');
        
        labs.rows.forEach((row, rIndex) => {
            const r = document.createElement('tr');
            
            // Icon Toolbar Cell
            let controls = `
                <td class="lab-action-cell">
                    <div class="lab-toolbar">
                        <button class="icon-btn btn-up" onclick="moveLabRow(${rIndex}, -1)" title="Move Up">‚ñ≤</button>
                        <button class="icon-btn btn-dn" onclick="moveLabRow(${rIndex}, 1)" title="Move Down">‚ñº</button>
                        <button class="icon-btn btn-add-row" onclick="insertLabRow(${rIndex})" title="Insert Row Below">‚úö</button>
                        <button class="icon-btn btn-del-row" onclick="delLabRow(${rIndex})" title="Delete Row">‚úï</button>
                    </div>
                </td>
            `;
            
            let nameCell = `<td><input type="text" value="${row.name}" style="font-weight:600;" onblur="renLabRow(${rIndex},this.value)"></td>`;
            
            let valCells = '';
            row.vals.forEach((v, cIndex) => { 
                valCells += `<td><input type="text" value="${v}" style="text-align:center;" onblur="upLabVal(${rIndex},${cIndex},this.value)"></td>`; 
            });
            
            r.innerHTML = controls + nameCell + valCells + `<td></td>`; 
            tbody.appendChild(r);
        });

        // --- 3. Footer Controls ---
        const addRow = document.createElement('tr');
        addRow.innerHTML = `
            <td colspan="2" style="padding: 10px 5px;">
                <div style="display:flex; gap:8px;">
                    <button class="btn-sm" onclick="addLabRow()">Add Row (Bottom)</button>
                    <button class="btn-sm" style="background:#17a2b8;" onclick="loadStandardLabs()">Load Standard Panel</button>
                </div>
            </td>
            <td colspan="${labs.dates.length + 1}"></td>
        `;
        tbody.appendChild(addRow);
        t.appendChild(tbody);

        renderChartArray(labs);
    }

    // --- Data Manipulation Functions ---

    function upLabVal(rIndex, cIndex, val) {
        const p = localPatients[currentPatientId];
        const l = p.labs;
        l.rows[rIndex].vals[cIndex] = val;
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function renLabRow(rIndex, val) {
        const p = localPatients[currentPatientId];
        const l = p.labs;
        l.rows[rIndex].name = val;
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function upLabDate(cIndex, val) {
        const p = localPatients[currentPatientId];
        const l = p.labs;
        l.dates[cIndex] = val;
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function addLabCol() {
        const p = localPatients[currentPatientId];
        const l = ensureLabArrayFormat(p);
        const t = new Date();
        l.dates.push(`${t.getDate()}/${t.getMonth()+1}`);
        // Add empty string to every row's value array
        l.rows.forEach(r => r.vals.push("-"));
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function addLabRow() {
        const p = localPatients[currentPatientId];
        const l = ensureLabArrayFormat(p);
        l.rows.push({ name: "New Test", vals: new Array(l.dates.length).fill("-") });
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    // --- NEW: Insert, Delete, Move ---

    function insertLabRow(index) {
        const p = localPatients[currentPatientId];
        const l = p.labs;
        // Insert at index + 1
        l.rows.splice(index + 1, 0, { name: "New Test", vals: new Array(l.dates.length).fill("-") });
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function delLabRow(index) {
        if(!confirm("Delete this row?")) return;
        const p = localPatients[currentPatientId];
        const l = p.labs;
        l.rows.splice(index, 1);
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    function moveLabRow(index, direction) {
        const p = localPatients[currentPatientId];
        const l = p.labs;
        const targetIndex = index + direction;
        
        // Bounds check
        if (targetIndex < 0 || targetIndex >= l.rows.length) return;

        // Swap
        const temp = l.rows[index];
        l.rows[index] = l.rows[targetIndex];
        l.rows[targetIndex] = temp;
        
        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    // --- Updated Load Standard Labs ---
    function loadStandardLabs() {
        const p = localPatients[currentPatientId];
        const l = ensureLabArrayFormat(p);
        
        const standardTests = [
            "Hb", "PCV", "TLC", "N", "L", "PLT", "CRP", "Procal", 
            "Na", "K", "TSB", "DSB", "AST", "ALT", 
            "Urea", "BUN", "Creat", "URE", "Blood C/S", "Urine C/S"
        ];

        if (l.dates.length === 0) {
            const t = new Date();
            l.dates.push(`${t.getDate()}/${t.getMonth()+1}`);
        }

        standardTests.forEach(testName => {
            // Check if row exists by name
            const exists = l.rows.some(r => r.name === testName);
            if (!exists) {
                l.rows.push({ name: testName, vals: new Array(l.dates.length).fill("-") });
            }
        });

        db.collection('patients').doc(currentPatientId).update({labs: l});
    }

    // --- Updated Chart Logic for Array Format ---
    async function renderChartArray(l) {
        await ensureChartJS();
        const ctx = document.getElementById('labsChart').getContext('2d'); 
        if(chartInstance) chartInstance.destroy();
        
        const clr = ['#e63946','#2a9d8f','#457b9d','#f4a261', '#9b59b6', '#34495e']; 
        let ci = 0;

        const ds = l.rows.map(row => {
            // Try to parse values (handle "-", empty, numbers)
            const dataPoints = row.vals.map(v => {
                const num = parseFloat(v);
                return isNaN(num) ? null : num;
            });
            
            // Only plot if there is at least one valid number
            if (dataPoints.every(v => v === null)) return null;

            return {
                label: row.name,
                data: dataPoints,
                borderColor: clr[ci++ % clr.length],
                tension: 0.3,
                spanGaps: true
            };
        }).filter(d => d); // Remove null datasets

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: l.dates, datasets: ds },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
    async function renderChart(l){
       await ensureChartJS(); // Ensure Chart.js is loaded
       const ctx=document.getElementById('labsChart').getContext('2d'); if(chartInstance)chartInstance.destroy();
       const clr=['#e63946','#2a9d8f','#457b9d','#f4a261']; let ci=0;
       const ds=Object.keys(l.tests).map(k=>{ const d=l.tests[k].map(v=>parseFloat(v)||null); if(d.every(v=>v===null))return null; return {label:k,data:d,borderColor:clr[ci++%4],tension:0.3,spanGaps:true}; }).filter(d=>d);
       chartInstance=new Chart(ctx,{type:'line',data:{labels:l.dates,datasets:ds},options:{responsive:true,maintainAspectRatio:false}});
    }

    function renderImages(){
       const p=localPatients[currentPatientId], g=document.getElementById('img-grid'); g.innerHTML='';
       (p.images||[]).forEach((img,i)=>{
          const d=document.createElement('div'); d.className='img-card';
          d.innerHTML=`<img src="${img.url}" onclick="openLightbox('${img.url}')"><div class="img-caption">${img.caption}</div><button class="img-delete" onclick="delImg(${i})">√ó</button>`;
          g.appendChild(d);
       });
    }
    async function addImage(){
        await ensureImageCompression(); // Load image compression library if not already loaded
        const fi=document.getElementById('img-file'), f=fi.files[0], cap=document.getElementById('img-cap').value, btn=document.getElementById('upload-btn');
        if(!f){alert("Select file");return;}
        btn.disabled=true;
        btn.innerText="Compressing...";

        try {
            // Image compression options
            const options = {
                maxSizeMB: 1,              // Target ~1MB
                maxWidthOrHeight: 1920,    // Max dimension
                useWebWorker: true,
                fileType: 'image/jpeg'     // Convert all to JPEG (including HEIC/HEIF)
            };

            // Compress the image
            const compressedFile = await imageCompression(f, options);

            btn.innerText="Uploading...";

            // Upload compressed file
            const ref=storage.ref().child('images/'+currentPatientId+'/'+Date.now()+'_'+compressedFile.name);
            const task=ref.put(compressedFile);

            task.on('state_changed',
                s=>{ btn.innerText=`${Math.round((s.bytesTransferred/s.totalBytes)*100)}%`; },
                e=>{alert(e.message); btn.disabled=false; btn.innerText="Upload";},
                ()=>{
                    task.snapshot.ref.getDownloadURL().then(u=>{
                        const p=localPatients[currentPatientId], i=p.images||[];
                        i.push({url:u,caption:cap||'Image'});
                        return db.collection('patients').doc(currentPatientId).update({images:i});
                    }).then(()=>{
                        fi.value='';
                        document.getElementById('img-cap').value='';
                        btn.disabled=false;
                        btn.innerText="Upload";
                    });
                }
            );
        } catch (error) {
            console.error('Image compression error:', error);
            alert('Error compressing image: ' + error.message);
            btn.disabled=false;
            btn.innerText="Upload";
        }
    }
    function delImg(i){
        if(!confirm("Delete from storage?"))return;
        const p=localPatients[currentPatientId], img=p.images[i];
        let prom=Promise.resolve();
        if(img.url&&img.url.includes('firebasestorage')) prom=storage.refFromURL(img.url).delete().catch(e=>console.warn(e));
        prom.finally(()=>{ const n=p.images.filter((_,x)=>x!==i); db.collection('patients').doc(currentPatientId).update({images:n}); });
    }
    function openLightbox(u){ document.getElementById('lightbox').style.display='flex'; document.getElementById('lightbox-img').src=u; }
    function closeLightbox(){ document.getElementById('lightbox').style.display='none'; }
    function renderHistory(){
       const p=localPatients[currentPatientId];
       document.getElementById('history-list').innerHTML = formatLogsToHtml(p.logs || '', currentPatientId, false, true, historySortOrder);
    }

    function toggleHistorySort() {
        historySortOrder = historySortOrder === 'newest' ? 'oldest' : 'newest';
        const btn = document.getElementById('history-sort-btn');
        if (btn) {
            btn.innerText = historySortOrder === 'newest' ? 'Newest ‚¨á' : 'Oldest ‚¨Ü';
        }
        renderHistory();
    }
// --- ADMISSION SYSTEM LOGIC & VARIABLES ---
const MAP_FORM_PDF = { 
        'f-name': 'name', 'f-hosp-no': 'hid', 'f-age': 'age', 'f-sex': 'sex', 
        'f-weight': 'weight', // Added weight
        'f-ward': 'ward', 'f-bed': 'bed', 'f-doa': 'doa', 
        'f-adm-dx': 'dx',     // Added top diagnosis
        'f-finaldx': 'dx', 
        'f-plan': 'management', 'f-complaints': 'complains', 'f-hopi': 'hopi', 
        'f-past': 'pasthx', 'f-family': 'fhx', 'f-treatment': 'txhx', 
        'f-obs': 'obs', 'f-personal': 'personalhx', 'f-ge': 'ge', 
        'f-cvs': 'cvs', 'f-rs': 'rs', 'f-abd': 'pa', 'f-pelvis': 'pelvis', 
        'f-cns': 'cns', 'f-le': 'le' 
    };
    const MAP_PDF_DB = { 'name':'name', 'hid':'id', 'age':'age', 'sex':'sex', 'ward':'ward', 'bed':'bed', 'doa':'doa', 'management':'plan', 'complains':'complaint', 'hopi':'hopi', 'pasthx':'past_history', 'fhx':'family_history', 'txhx':'treatment_history', 'obs':'obs_history', 'personalhx':'personal_history', 'ge':'general_exam', 'cvs':'cvs', 'rs':'rs', 'pa':'abdomen', 'pelvis':'pelvis', 'cns':'cns', 'le':'local_exam', 'dx':'diagnosis' };
    
    // Newborn PDF Field Map (Required for PDF Generation)
    const MAP_NB_PDF = { 'Text1': '', 'Text2': 'years', 'Text3': '', 'Text4': '', 'Text5': '', 'Text6': '', 'Text7': '', 'Text8': '-', 'Text9': 'Kg/m2', 'Text10': '', 'Text11': '', 'Text12': 'g/dL', 'Text13': '', 'Text14': '', 'Text15': '', 'Text16': '-', 'Text17': '-', 'Text18': '-', 'Text19': '-', 'Text20': '', 'Text21': '', 'Text22': '-', 'Text23': '', 'Text24': '', 'Text25': '-', 'Text26': '-', 'Text27': 'Mother: \nFather: ', 'Text29': '', 'Text30': '', 'Text31': '', 'Text32': '/10', 'Text33': '/10', 'Text34': '/10', 'Text35': '', 'Text36': 'Dry stimulation', 'Text37': '-', 'Text38': '-', 'Text39': '', 'Text40': '', 'Text41': 'Kg', 'Text42': '', 'Text43': '', 'Text44': '', 'Text45': '', 'Text46': '-', 'Text47': '-', 'Text48': '-', 'Text49': 'Collected', 'Text50': 'Hb, PCV, Blood Grouping', 'Text51': '-', 'Text52': '-', 'Text53': '-', 'Text59': '', 'Text60': '', 'Text61': '', 'Text62': '', 'Text63': '', 'Text64': '', 'Text66': 'Baby born vigorous, cried immediately after birth', 'Text67': 'Tone and cry:            Normal\nReflex and Activity:  Normal\n\nRS: B/L EAE, CLEAR\nNo LCR, UCR, XR, NF or Grunting\n\nCVS: S1 S2 M0\n\nUmbilical Vessels: 2A +1V\n\nHR , RR , SpO2 % in RA\n\n-', 'Text68': '-Routine newborn care\n-Exclusive breast feeding as early as possible then every 2hrly\n-Immunization as protocol\n-CCHD >24HOL, NMS >72HOL\n-W/F Tachypnea, Poor feeding, Lethargy', 'Text69': '', 'Text70': 'Attended By:\nDr. \nDr. (MO)' };

    const ALLOWED_EDIT_PDF = [ 'dx', 'management', 'complains', 'hopi', 'pasthx', 'fhx', 'txhx', 'obs', 'personalhx', 'ge', 'cvs', 'rs', 'pa', 'pelvis', 'cns', 'le' ];
    const FIELD_MAX_LINES = { 'f-hopi': 9, 'f-complaints': 3, 'f-past': 6, 'f-personal': 6, 'f-family': 6, 'f-treatment': 6, 'f-obs': 6, 'f-ge': 5, 'f-cvs': 5, 'f-rs': 5, 'f-abd': 5, 'f-pelvis': 5, 'f-cns': 5, 'f-le': 5, 'f-plan': 8 };

    let pdfDoc = null;
    let anchors = {};
    let nbAnchors = {};
    let pdfValues = {};
    let nbValues = JSON.parse(JSON.stringify(MAP_NB_PDF));
    let currentMode = 'form';
    let pdfFontSize = 13;
    let nbFontSize = 9;  // Default font size for newborn (fixed)
    let nbLineHeight = 1.2;  // Default line height for newborn (fixed)
    let pdfLineHeight = 1.3;
    let visualScaleFactor = 0.62;
    let visualLineHeightFactor = 1.0769; // Visual 1.4 ‚âà Print 1.3 (1.4/1.3)
    let storedScaleFit = null;
    let isAutoFit = false;
    let calculatedFontSize = 13;
    let isSyncing = false; // Prevent infinite sync loops

    // === Your REAL PDF dimensions ===
    const PDF_PAGE_WIDTH_PT  = 595;   // points (8.26 in √ó 72)
    const PDF_PAGE_HEIGHT_PT = 775;   // points (10.76 in √ó 72)

    // Screen conversion ‚Äî increase DPI to make base preview larger
    const PREVIEW_DPI = 96;  // ‚Üê Change this value to control size (higher = larger)
    const PT_TO_PX = PREVIEW_DPI / 72;  // ‚âà 1.3333 px per point at 96 DPI

    // Preview size in pixels (this is what controls how big it appears initially)
    const PREVIEW_WIDTH_PX  = Math.round(PDF_PAGE_WIDTH_PT  * PT_TO_PX);   // ~794 px at 96 dpi (matches patient details width)
    const PREVIEW_HEIGHT_PX = Math.round(PDF_PAGE_HEIGHT_PT * PT_TO_PX);   // ~1033 px at 96 dpi

    // Newborn field type mappings
    const NB_FIELD_TYPES = {
        'Text35': 'datetime',  // Birth date & time
        'Text30': 'datalist',  // Delivery mode
        'Text39': 'datalist',  // Sex
        'Text59': 'clickable', // Term
        'Text60': 'clickable', // Preterm
        'Text61': 'clickable', // Postterm
        'Text62': 'clickable', // AGA
        'Text63': 'clickable', // SGA
        'Text64': 'clickable', // LGA
        'Text41': 'text',      // Weight (text field with "kg" default)
        'Text4': 'datalist',   // Consanguinity
        'Text5': 'datalist',   // Booking Status
        'Text6': 'datalist',   // Immunization
        'Text13': 'datalist',  // Blood Group
        'Text14': 'datalist',  // VDRL
        'Text15': 'datalist',  // Other Tests
        'Text21': 'datalist',  // Presentation
        'Text23': 'datalist',  // Liquor Quality
        'Text24': 'datalist',  // Liquor Quantity
        'Text43': 'datalist',  // Cong. Anomalies
        'Text44': 'datalist',  // Anal Patency
        'Text45': 'datalist',  // Esophageal Patency
        'Text49': 'datalist',  // Cord Blood
        // Rest are text/textarea inputs
    };

    const NB_DATALIST_OPTIONS = {
        'Text30': ['SVD', 'Em LSCS', 'El LSCS', 'Instrumental'],
        'Text39': ['Male', 'Female'],
        'Text4': ['Non-consanguineous', 'Consanguineous'],
        'Text5': ['Booked', 'Unbooked'],
        'Text6': ['Immunized', 'Un-immunized'],
        'Text13': ['O+ve', 'O-ve', 'A+ve', 'A-ve', 'B+ve', 'B-ve', 'AB+ve', 'AB-ve'],
        'Text14': ['Negative, G6PD: Normal'],
        'Text15': ['HIV: -ve, HbsAg: -ve, HCV: -ve'],
        'Text21': ['Cephalic'],
        'Text23': ['Clear'],
        'Text24': ['Adequate'],
        'Text43': ['No gross anomaly'],
        'Text44': ['Patent'],
        'Text45': ['To be established'],
        'Text49': ['Collected', 'Not Collected'],
    }; 

    function updateNbField(key, val) { nbValues[key] = val; }
    function updateNbTicks(group, val) {
        if(group === 'gest') { nbValues['Text59'] = ''; nbValues['Text60'] = ''; nbValues['Text61'] = ''; if(val === 'Term') nbValues['Text59'] = '____'; if(val === 'Preterm') nbValues['Text60'] = '____'; if(val === 'Postterm') nbValues['Text61'] = '____'; }
        if(group === 'size') { nbValues['Text62'] = ''; nbValues['Text63'] = ''; nbValues['Text64'] = ''; if(val === 'AGA') nbValues['Text62'] = '____'; if(val === 'SGA') nbValues['Text63'] = '____'; if(val === 'LGA') nbValues['Text64'] = '____'; }
    }

    // Sync individual field to visual form in real-time
    function syncNbVisualField(fieldName, value) {
        // Only sync when in newborn visual mode
        if(currentMode !== 'newborn') return;
        // Prevent infinite loops
        if(isSyncing) return;

        // Find the visual field element and update it
        const stage = document.getElementById('nb-visual-stage');
        if(!stage) return;

        isSyncing = true;
        // Find all input/div elements and update matching field
        const allFields = stage.querySelectorAll('.pdf-box, .nb-pdf-datalist, .nb-pdf-datetime, .nb-pdf-number, .nb-pdf-text, .nb-pdf-clickable');
        allFields.forEach(el => {
            const fieldId = el.getAttribute('data-field');
            if(fieldId === fieldName) {
                if(el.tagName === 'INPUT') {
                    el.value = value;
                } else if(el.classList.contains('nb-pdf-clickable')) {
                    // For clickable fields, update text and underline
                    el.innerText = value;
                    el.style.textDecoration = value === '____' ? 'underline' : 'none';
                } else {
                    el.innerText = value;
                }
            }
        });
        isSyncing = false;
    }

// Sync from visual form back to sidebar form
function syncFromVisualToForm(fieldName, value) {
    // Prevent infinite loops
    if(isSyncing) return;

    isSyncing = true;
    nbValues[fieldName] = value;

    // Map visual fields back to form fields
    const visualToFormMap = {
        'Text29': 'nb-f-hosp-no',
        'Text42': 'nb-f-nid-no',
        'Text1': 'nb-m-name',       // Mother's name
        // Text21 is Presentation (Cephalic), not baby name - baby name stored separately as p.name
        'Text69': 'nb-generated-dx', // Diagnosis
    };

    const formFieldId = visualToFormMap[fieldName];
    if(formFieldId) {
        const formField = document.getElementById(formFieldId);
        if(formField && formField.value !== value) {
            formField.value = value;
            
            // --- FIX STARTS HERE ---
            // If we just updated Mother's Name (Text1), we must manually trigger the baby name sync
            if (fieldName === 'Text1') {
                syncBabyName();
            }
            // --- FIX ENDS HERE ---

            // Also sync diagnosis to patient details diagnosis field
            if(fieldName === 'Text69') {
                document.getElementById('nb-f-adm-dx').value = value;
            }
        }
    }
    isSyncing = false;
}

    // Sync ALL form field values into nbValues before saving
    function syncAllNbFieldsToValues() {
        // Direct ID mappings
        const fieldMap = {
            'nb-m-name': 'Text1',
            'nb-m-age': 'Text2',
            'nb-m-mrd': 'Text3',
            'nb-para-gravida': 'Text7',
            'nb-prev-still-birth': 'Text8',
            'nb-weight-bmi': 'Text9',
            'nb-lmp': 'Text10',
            'nb-edd': 'Text11',
            'nb-hb': 'Text12',
            'nb-toxemia': 'Text16',
            'nb-hydramnios': 'Text17',
            'nb-pih': 'Text18',
            'nb-aph': 'Text19',
            'nb-any-other-illness': 'Text20',
            'nb-time-rom': 'Text22',
            'nb-drugs-given': 'Text25',
            'nb-fetal-distress': 'Text26',
            'nb-thalassemia': 'Text27',
            'nb-f-hosp-no': 'Text29',
            'nb-b-mode': 'Text30',
            'nb-b-ind': 'Text31',
            'nb-apgar-1min': 'Text32',
            'nb-apgar-5min': 'Text33',
            'nb-apgar-10min': 'Text34',
            'nb-resuscitation': 'Text36',
            'nb-intubation': 'Text37',
            'nb-bicarbonate': 'Text38',
            'nb-sex-combo': 'Text39',
            'nb-b-mat': 'Text40',
            'nb-f-nid-no': 'Text42',
            'nb-resp-distress': 'Text46',
            'nb-cyanosis': 'Text47',
            'nb-any-other-baby': 'Text48',
            'nb-investigations': 'Text50',
            'nb-gastric-aspirate': 'Text51',
            'nb-culture': 'Text52',
            'nb-any-other-inv': 'Text53',
            'nb-condition': 'Text66',
            'nb-examination': 'Text67',
            'nb-advice': 'Text68',
            'nb-generated-dx': 'Text69',
            'nb-attended-by': 'Text70',
            'nb-gest-sel': 'gest_val',
            'nb-size-sel': 'size_val'
        };

        // Read all fields with IDs
        Object.keys(fieldMap).forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                nbValues[fieldMap[id]] = el.value;
            }
        });

        // Special handling for weight (adds ' kg')
        const weightEl = document.getElementById('nb-b-wt');
        if(weightEl && weightEl.value) {
            nbValues['Text41'] = weightEl.value + ' kg';
        }

        // Special handling for birth datetime
        const dobEl = document.getElementById('nb-b-datetime');
        if(dobEl && dobEl.value) {
            nbValues['Text35'] = dobEl.value.replace('T', ' ');
        }

        // Fields with datalists (use querySelector for inputs with list attribute)
        const listFields = [
            {list: 'lst-consang', key: 'Text4'},
            {list: 'lst-booking', key: 'Text5'},
            {list: 'lst-imm', key: 'Text6'},
            {list: 'lst-bg', key: 'Text13'},
            {list: 'lst-vdrl', key: 'Text14'},
            {list: 'lst-other-tests', key: 'Text15'},
            {list: 'lst-presentation', key: 'Text21'},
            {list: 'lst-liq-qual', key: 'Text23'},
            {list: 'lst-liq-quan', key: 'Text24'},
            {list: 'lst-cong-anom', key: 'Text43'},
            {list: 'lst-anal', key: 'Text44'},
            {list: 'lst-eso', key: 'Text45'},
            {list: 'lst-cord', key: 'Text49'}
        ];

        listFields.forEach(({list, key}) => {
            const input = document.querySelector(`input[list="${list}"]`);
            if(input) {
                nbValues[key] = input.value;
            }
        });

        console.log('‚úì Synced all newborn fields to nbValues');
    }

    // Load ALL nbValues back into form fields (reverse of syncAllNbFieldsToValues)
    function loadAllNbFieldsFromValues() {
        // Use the same mapping
        const fieldMap = {
            'nb-m-name': 'Text1',
            'nb-m-age': 'Text2',
            'nb-m-mrd': 'Text3',
            'nb-para-gravida': 'Text7',
            'nb-prev-still-birth': 'Text8',
            'nb-weight-bmi': 'Text9',
            'nb-lmp': 'Text10',
            'nb-edd': 'Text11',
            'nb-hb': 'Text12',
            'nb-toxemia': 'Text16',
            'nb-hydramnios': 'Text17',
            'nb-pih': 'Text18',
            'nb-aph': 'Text19',
            'nb-any-other-illness': 'Text20',
            'nb-time-rom': 'Text22',
            'nb-drugs-given': 'Text25',
            'nb-fetal-distress': 'Text26',
            'nb-thalassemia': 'Text27',
            'nb-f-hosp-no': 'Text29',
            'nb-b-mode': 'Text30',
            'nb-b-ind': 'Text31',
            'nb-apgar-1min': 'Text32',
            'nb-apgar-5min': 'Text33',
            'nb-apgar-10min': 'Text34',
            'nb-resuscitation': 'Text36',
            'nb-intubation': 'Text37',
            'nb-bicarbonate': 'Text38',
            'nb-sex-combo': 'Text39',
            'nb-b-mat': 'Text40',
            'nb-f-nid-no': 'Text42',
            'nb-resp-distress': 'Text46',
            'nb-cyanosis': 'Text47',
            'nb-any-other-baby': 'Text48',
            'nb-investigations': 'Text50',
            'nb-gastric-aspirate': 'Text51',
            'nb-culture': 'Text52',
            'nb-any-other-inv': 'Text53',
            'nb-condition': 'Text66',
            'nb-examination': 'Text67',
            'nb-advice': 'Text68',
            'nb-generated-dx': 'Text69',
            'nb-attended-by': 'Text70',
            'nb-gest-sel': 'gest_val',
            'nb-size-sel': 'size_val'
        };

        // Write all values from nbValues to form fields
        Object.keys(fieldMap).forEach(id => {
            const el = document.getElementById(id);
            const textKey = fieldMap[id];
            if(el && nbValues[textKey] !== undefined && nbValues[textKey] !== null) {
                el.value = nbValues[textKey];
            }
        });

        // Special handling for weight (remove ' kg' suffix)
        if(nbValues['Text41']) {
            const weightEl = document.getElementById('nb-b-wt');
            if(weightEl) {
                weightEl.value = parseFloat(nbValues['Text41']) || '';
            }
        }

        // Special handling for birth datetime (convert space to T)
        if(nbValues['Text35']) {
            const dobEl = document.getElementById('nb-b-datetime');
            if(dobEl) {
                dobEl.value = nbValues['Text35'].replace(' ', 'T');
            }
        }

        // Fields with datalists
        const listFields = [
            {list: 'lst-consang', key: 'Text4'},
            {list: 'lst-booking', key: 'Text5'},
            {list: 'lst-imm', key: 'Text6'},
            {list: 'lst-bg', key: 'Text13'},
            {list: 'lst-vdrl', key: 'Text14'},
            {list: 'lst-other-tests', key: 'Text15'},
            {list: 'lst-presentation', key: 'Text21'},
            {list: 'lst-liq-qual', key: 'Text23'},
            {list: 'lst-liq-quan', key: 'Text24'},
            {list: 'lst-cong-anom', key: 'Text43'},
            {list: 'lst-anal', key: 'Text44'},
            {list: 'lst-eso', key: 'Text45'},
            {list: 'lst-cord', key: 'Text49'}
        ];

        listFields.forEach(({list, key}) => {
            const input = document.querySelector(`input[list="${list}"]`);
            if(input && nbValues[key]) {
                input.value = nbValues[key];
            }
        });

        console.log('‚úì Loaded all newborn fields from nbValues');

        // Auto-sync baby name after loading data
        if (document.getElementById('nb-auto-name')?.checked) {
            syncBabyName();
        }
    }

    // --- SYNC FUNCTIONS ---
    function syncBirthWeight(val) { updateVisualField('weight', val); }
    function syncBirthDate(dateTimeVal) {
        if (!dateTimeVal) return; const [datePart, timePart] = dateTimeVal.split('T');
        document.getElementById('nb-f-doa').value = datePart;
    }
    function syncBabyName() {
        const autoChecked = document.getElementById('nb-auto-name').checked;
        if(!autoChecked) return;

        const motherName = nbValues['Text1'] || '';
        const babyName = 'BO ' + motherName;

        // Only update the Input field for Name, do NOT touch Text21 (Presentation)
        document.getElementById('nb-f-name').value = babyName;

        // Note: The Baby's Name isn't stored in nbValues for the Newborn PDF
        // because that specific PDF doesn't seem to have a dedicated "Baby Name" box
        // defined in your map (it's stored separately as p.name in the database).
    }

    function toggleAutoName() {
        if (document.getElementById('nb-auto-name').checked) {
            syncBabyName();
        }
    }

    function generateDiagnosis() {
       const gest = document.getElementById('nb-gest-sel').value || ''; const sexVal = document.getElementById('nb-sex-combo').value || '';
       const size = document.getElementById('nb-size-sel').value || ''; const mode = document.getElementById('nb-b-mode').value || ''; const ind = (document.getElementById('nb-b-ind').value || '').trim();
       let sexShort = 'M'; if(sexVal === 'Female') sexShort = 'F'; if(sexVal === 'Ambiguous') sexShort = 'Amb';

       // Abbreviate "Term" to "T", keep "Preterm" and "Postterm" full
       let gestShort = gest;
       if(gest === 'Term') gestShort = 'T';

       let modeStr = mode; if(mode !== 'SVD' && ind !== '' && mode !== '') { modeStr += ` for ${ind}`; } else if (mode === 'SVD' && ind !== '') { modeStr += ` for ${ind}`; }
       const parts = ['S/L']; if(gestShort) parts.push(gestShort); if(sexVal) parts.push(sexShort); if(size) parts.push(size); if(modeStr) parts.push(modeStr);
       const dx = parts.join('/') + " for observation";
       document.getElementById('nb-generated-dx').value = dx;
       document.getElementById('nb-f-adm-dx').value = dx;
       updateNbField('Text69', dx);
    }
    
    // --- HOPI GENERATOR HELPER ---
    function getNewbornHopiText() {
        const blue = (label) => `<span style="color: var(--primary)">${label}</span>`;
        const val = (v) => v || '-';

        return `<div style="white-space: pre-wrap; line-height: 1.6;">
<strong>MOTHER'S DETAILS</strong>
${blue('Name:')} ${val(nbValues['Text1'])}
${blue('Age:')} ${val(nbValues['Text2'])}
${blue('MRD No:')} ${val(nbValues['Text3'])}
${blue('Consanguinity:')} ${val(nbValues['Text4'])}
${blue('Booked / Unbooked:')} ${val(nbValues['Text5'])}
${blue('Immunized / Un-immunized:')} ${val(nbValues['Text6'])}
${blue('Para Gravida:')} ${val(nbValues['Text7'])}
${blue('Previous Still Birth:')} ${val(nbValues['Text8'])}
${blue('Weight:')} ${val(nbValues['Text9'])}
${blue('LMP:')} ${val(nbValues['Text10'])}
${blue('EDD:')} ${val(nbValues['Text11'])}
${blue('HB:')} ${val(nbValues['Text12'])}
${blue('Blood Grp & Type:')} ${val(nbValues['Text13'])}
${blue('VDRL:')} ${val(nbValues['Text14'])}, ${blue('Other tests:')} ${val(nbValues['Text15'])}
${blue('Toxemia:')} ${val(nbValues['Text16'])}
${blue('Hydramnios:')} ${val(nbValues['Text17'])}
${blue('P.I.H:')} ${val(nbValues['Text18'])}
${blue('A.P.H:')} ${val(nbValues['Text19'])}
${blue('Any other illness:')} ${val(nbValues['Text20'])}
${blue('Presentation:')} ${val(nbValues['Text21'])}
${blue('Time of Membrane rupture:')} ${val(nbValues['Text22'])}
${blue('Liquor Quality:')} ${val(nbValues['Text23'])}${blue(', Quantity:')} ${val(nbValues['Text24'])}
${blue('Drugs given:')} ${val(nbValues['Text25'])}
${blue('Any Evidence of Foetal Distress:')} ${val(nbValues['Text26'])}
${val(nbValues['Text27'])}


<strong>BABY'S DETAILS</strong>
${blue('Type of Delivery:')} ${val(nbValues['Text30'])}
${blue('Indication:')} ${val(nbValues['Text31'])}
${blue('Date & Time of Delivery:')} ${val(nbValues['Text35'])}
${blue('APGAR at:')} ${blue('1min')} ${val(nbValues['Text32'])} ${blue('5min')} ${val(nbValues['Text33'])} ${blue('10min')} ${val(nbValues['Text34'])}
${blue('Resuscitation:')} ${val(nbValues['Text36'])}
${blue('Intubation & IPPR:')} ${val(nbValues['Text37'])}
${blue('Bicarbonate / Lethedron:')} ${val(nbValues['Text38'])}
${blue('Sex of Baby:')} ${val(nbValues['Text39'])}
${blue('Maturity:')} ${val(nbValues['Text40'])}
${blue('Weight:')} ${val(nbValues['Text41'])}
${blue('Congenital Anomalies:')} ${val(nbValues['Text43'])}
${blue('Anal Patency:')} ${val(nbValues['Text44'])}
${blue('Oesophageal Patency:')} ${val(nbValues['Text45'])}
${blue('Respiratory Distress:')} ${val(nbValues['Text46'])}
${blue('Cyanosis/Pallor/Jaundice:')} ${val(nbValues['Text47'])}
${blue('Any Other:')} ${val(nbValues['Text48'])}
${blue('Cord Blood Collected / Not Collected:')} ${val(nbValues['Text49'])}
${blue('Investigation on Blood:')} ${val(nbValues['Text50'])}
${blue('Gastric Aspirate - Microscopy:')} ${val(nbValues['Text51'])}
${blue('Culture:')} ${val(nbValues['Text52'])}
${blue('Any Other:')} ${val(nbValues['Text53'])}

${blue('Problems:')} ${val(nbValues['Text66'])}

${val(nbValues['Text67'])}
</div>`;
    }

    function launchAdmissionSystem(clearData = true) {
       document.getElementById('admission-system').style.display='flex';
       if(clearData) {
           document.querySelectorAll('#admission-system input, #admission-system textarea').forEach(e => { if(e.type === 'checkbox') e.checked = false; else e.value = e.defaultValue || ''; });
           document.querySelectorAll('#admission-system select').forEach(e => {
    // If the select has a defaultSelected option, revert to it. Otherwise index 0.
    const options = Array.from(e.options);
    const defaultOption = options.find(opt => opt.defaultSelected);
    e.selectedIndex = defaultOption ? defaultOption.index : 0;
});
           document.getElementById('f-doa').value = getLocalISODate(); document.getElementById('nb-f-doa').value = getLocalISODate();
           document.getElementById('f-shift').value = getCurrentShift(); document.getElementById('nb-f-shift').value = getCurrentShift();
           pdfValues = {}; nbValues = JSON.parse(JSON.stringify(MAP_NB_PDF)); currentPatientId = null;
           const autoName = document.getElementById('nb-auto-name'); if(autoName) autoName.checked = true;
       }
       setMode('form');
       if(Object.keys(anchors).length === 0) fetch(ANCHORS_URL).then(r=>r.json()).then(d=> anchors = d.anchorsByPage || d);
       loadTemplates();
       document.getElementById('admSidebar').classList.remove('show');
       const btnSave = document.getElementById('btn-save-edits'); if(btnSave) btnSave.style.display = 'none';
       const btnPrint = document.getElementById('btn-print-add'); if(btnPrint) btnPrint.style.display = 'inline-block';
    }
    function closeAdmissionSystem() { document.getElementById('admission-system').style.display='none'; }
    
    function setMode(mode) {
       if (currentMode === 'form' && mode === 'pdf') syncFormToPdf();
       if (currentMode === 'pdf' && mode === 'form') syncPdfToForm();

       currentMode = mode;
       document.getElementById('btn-mode-form').className = `mode-card ${mode==='form'?'active':''}`;
       document.getElementById('btn-mode-pdf').className = `mode-card ${mode==='pdf'?'active':''}`;
       document.getElementById('btn-mode-newborn').className = `mode-card ${mode==='newborn'?'active':''}`;
       
       document.getElementById('view-form').style.display = mode==='form'?'block':'none';
       document.getElementById('view-pdf').style.display = mode==='pdf'?'flex':'none';
       document.getElementById('view-newborn').style.display = 'none'; // Hidden - using visual mode instead
       document.getElementById('view-newborn-visual').style.display = mode==='newborn'?'flex':'none';
       // Only show font controls for admission PDF, not for newborn (newborn has fixed size/line height)
       document.getElementById('pdf-controls').style.display = mode==='pdf'?'flex':'none';

       if(document.body.classList.contains('is-mobile')) toggleAdmSidebar();
       if(mode==='pdf') { renderPdfVisual(); syncPdfControls(); }
       if(mode==='newborn') {
           renderNbVisual();
           syncPdfControls();
           // Auto-sync baby name when entering newborn mode
           setTimeout(() => {
               if (document.getElementById('nb-auto-name')?.checked) {
                   syncBabyName();
               }
           }, 100);
       }

       if(mode === 'newborn') {
           document.getElementById('adm-std-details').style.display = 'none';
           document.getElementById('adm-newborn-details').style.display = 'block';
           const hno = document.getElementById('f-hosp-no').value;
           if(!document.getElementById('nb-f-hosp-no').value) document.getElementById('nb-f-hosp-no').value = hno;
           nbValues['Text29'] = document.getElementById('nb-f-hosp-no').value;
           nbValues['Text42'] = document.getElementById('nb-f-nid-no').value;
       } else {
           document.getElementById('adm-std-details').style.display = 'block';
           document.getElementById('adm-newborn-details').style.display = 'none';
       }
    }

    function toggleAdmSidebar() { document.getElementById('admSidebar').classList.toggle('show'); }
    function toggleAdmAutoInputs() { const el = document.getElementById('adm-radio-auto'); const a = el ? el.checked : false; document.getElementById('adm-auto-age-inputs').style.display = a ? 'flex' : 'none'; }
function updateVisualField(pdfKey, value) { 
        // 1. Update Data
        pdfValues[pdfKey] = value; 
        
        // 2. Update Visual PDF (Direct Call)
        syncPdfVisualField(pdfKey, value);
    }

    // Sync field to standard visual mode PDF in real-time
function syncPdfVisualField(fieldName, value) {
        // We do NOT check currentMode here. We just check if the element exists.
        const stage = document.getElementById('pdf-stage');
        if (!stage) return;

        // Find box using the attribute we explicitly set above
        const boxes = stage.querySelectorAll(`.pdf-box[data-field="${fieldName}"]`);
        
        boxes.forEach(box => {
            // Only update if text is different (prevents cursor jumping issues)
            if (box.innerText !== value) {
                box.innerText = value;
            }
        });
    }

function syncDx(val, fromBottom) {
        // 1. Sync the two sidebar inputs
        if (fromBottom) {
            const topEl = document.getElementById('f-adm-dx');
            if(topEl && topEl.value !== val) topEl.value = val;
        } else {
            const botEl = document.getElementById('f-finaldx');
            if(botEl && botEl.value !== val) botEl.value = val;
        }
        
        // 2. Update Data
        pdfValues['dx'] = val;
        
        // 3. Update Visual PDF (Direct Call)
        syncPdfVisualField('dx', val);
    }

    function checkOverflow(fieldId) {
        if (fieldId !== 'f-hopi' && fieldId !== 'f-past') return; const pdfKey = MAP_FORM_PDF[fieldId]; if(!pdfKey) return;
        let targetAnchor = null; Object.values(anchors).forEach(pageAnchors => { const found = pageAnchors.find(a => a.name === pdfKey); if(found) targetAnchor = found; }); if(!targetAnchor) return;
        const maxLines = FIELD_MAX_LINES[fieldId] || 9; const text = document.getElementById(fieldId).value; const warnEl = document.getElementById('warn-' + fieldId);
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const fontSize = 9; ctx.font = `${fontSize}px Helvetica`; 
        const pageWidth = 595; const boxW = targetAnchor.w * pageWidth; const words = text.split(' '); let lineCount = 1; let currentLineW = 0;
        for(const word of words) {
           if(word.includes('\n')) { const parts = word.split('\n'); const firstW = ctx.measureText(parts[0] + ' ').width; if (currentLineW + firstW > boxW) { lineCount++; } for(let k=1; k<parts.length; k++) { lineCount++; const partW = ctx.measureText(parts[k] + ' ').width; if(partW > boxW) { lineCount += Math.floor(partW / boxW); currentLineW = partW % boxW; } else { currentLineW = partW; } } continue; }
           const wordW = ctx.measureText(word + ' ').width; if (currentLineW + wordW > boxW) { lineCount++; currentLineW = wordW; } else { currentLineW += wordW; }
        }
        if(lineCount > maxLines) { if(warnEl) { warnEl.style.display = 'block'; warnEl.innerText = `‚ö†Ô∏è Text limit exceeded: ${lineCount}/${maxLines} lines`; } } else { if(warnEl) warnEl.style.display = 'none'; }
    }

async function renderPdfVisual() {
        const stage = document.getElementById('pdf-stage');
        stage.innerHTML = '';

        const activeFontSize = isAutoFit ? calculatedFontSize : pdfFontSize;

        for (let i = 1; i <= 4; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'pdf-page';
            
            // Layout styling
            wrapper.style.width = `${PREVIEW_WIDTH_PX}px`;
            wrapper.style.height = `${PREVIEW_HEIGHT_PX}px`;
            wrapper.style.position = 'relative';
            wrapper.style.margin = '30px auto';
            wrapper.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
            wrapper.style.backgroundImage = `url('https://raw.githubusercontent.com/nuhadwrk/admission/main/Admissionp${i}.jpg')`;
            wrapper.style.backgroundSize = '100% 100%';
            wrapper.style.backgroundRepeat = 'no-repeat';

            // Scale logic
            const maxWidth = window.innerWidth - 60;
            let scale = 1.0;
            if (PREVIEW_WIDTH_PX > maxWidth) {
                scale = maxWidth / PREVIEW_WIDTH_PX;
            }
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.transformOrigin = 'top center';

            if(anchors[i]) {
                anchors[i].forEach(a => {
                    const box = document.createElement('div');
                    box.className = 'pdf-box';
                    
                    // --- CRITICAL FIX: Use setAttribute so querySelector finds it reliably ---
                    box.setAttribute('data-field', a.name);
                    
                    box.contentEditable = ALLOWED_EDIT_PDF.includes(a.name) ? 'true' : 'false';

                    // Positioning
                    box.style.left   = `${a.x * PREVIEW_WIDTH_PX}px`;
                    box.style.top    = `${a.y * PREVIEW_HEIGHT_PX}px`;
                    box.style.width  = `${a.w * PREVIEW_WIDTH_PX}px`;
                    box.style.height = `${a.h * PREVIEW_HEIGHT_PX}px`;
                    box.style.fontSize    = `${activeFontSize * PT_TO_PX}px`;
                    box.style.lineHeight = pdfLineHeight;
                    
                    // Set Value
                    box.innerText = pdfValues[a.name] || '';

                    // --- Bidirectional Sync (Visual -> Form) ---
                    if (box.contentEditable === 'true') {
                        box.oninput = () => {
                            const val = box.innerText.trim();
                            pdfValues[a.name] = val;
                            
                            // 1. Direct Sync for Diagnosis (Critical Field)
                            if (a.name === 'dx') {
                                const topDx = document.getElementById('f-adm-dx');
                                const botDx = document.getElementById('f-finaldx');
                                if (topDx) topDx.value = val;
                                if (botDx) botDx.value = val;
                            }
                            // 2. Generic Sync for others using the Map
                            else {
                                // Find which Form ID maps to this PDF Field
                                const formId = Object.keys(MAP_FORM_PDF).find(key => MAP_FORM_PDF[key] === a.name);
                                if (formId) {
                                    const el = document.getElementById(formId);
                                    if (el) el.value = val;
                                }
                            }
                        };
                    }

                    wrapper.appendChild(box);
                });
            }
            stage.appendChild(wrapper);
        }
    }

    async function renderNbVisual() {
        const stage = document.getElementById('nb-visual-stage');
        stage.innerHTML = '';

        // Sync values from form
        const hospNo = document.getElementById('nb-f-hosp-no').value;
        const nidNo = document.getElementById('nb-f-nid-no').value;
        if(hospNo) nbValues['Text29'] = hospNo;
        if(nidNo) nbValues['Text42'] = nidNo;

        const activeFontSize = isAutoFit ? calculatedFontSize : nbFontSize;

        // Load newborn anchors if not loaded
        if(Object.keys(nbAnchors).length === 0) {
            console.log('Loading newborn anchors...');
            try {
                const response = await fetch(NB_ANCHORS_URL);
                nbAnchors = await response.json();
                console.log('Newborn anchors loaded:', Object.keys(nbAnchors).length, 'pages');
            } catch(e) {
                console.error('Failed to load anchors:', e);
                stage.innerHTML = '<div style="padding:40px;text-align:center;color:#999;">Newborn anchors not found. Please upload newborn-anchors.json to your repository.</div>';
                return;
            }
        }

        const imgUrl = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/Newborn.jpg';
        const numPages = Object.keys(nbAnchors).length || 1;

        for(let i=1; i<=numPages; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'pdf-page';

            // Use same dimensions as standard visual
            wrapper.style.width = `${PREVIEW_WIDTH_PX}px`;
            wrapper.style.height = `${PREVIEW_HEIGHT_PX}px`;
            wrapper.style.position = 'relative';
            wrapper.style.margin = '30px auto';
            wrapper.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
            wrapper.style.backgroundImage = `url('${imgUrl}')`;
            wrapper.style.backgroundSize = '100% 100%';
            wrapper.style.backgroundRepeat = 'no-repeat';

            // Only constrain by width, allow vertical scrolling
            const maxWidth = window.innerWidth - 60;
            let scale = 1.0;

            if (PREVIEW_WIDTH_PX > maxWidth) {
                scale = maxWidth / PREVIEW_WIDTH_PX;
            }

            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.transformOrigin = 'top center';

          if(nbAnchors[i]) {
             nbAnchors[i].forEach(a => {
                const fieldType = NB_FIELD_TYPES[a.name];
                let box;

                // Special handling for Text27 - add "Thalassemia status:" label
                if (a.name === 'Text27') {
                    box = document.createElement('div');
                    box.className = 'pdf-box';
                    box.contentEditable = true;
                    box.dataset.field = a.name;
                    const currentValue = nbValues[a.name] || 'Mother: \nFather: ';
                    if (!currentValue.includes('Thalassemia status:')) {
                        nbValues[a.name] = 'Thalassemia status:\nMother: \nFather: ';
                    }
                    box.innerText = nbValues[a.name];
                    box.oninput = (e) => { nbValues[a.name] = e.target.innerText; };
                }
                // Create appropriate control based on field type
                else if (fieldType === 'datalist') {
                    box = document.createElement('input');
                    box.type = 'text';
                    box.className = 'nb-pdf-datalist';
                    box.dataset.field = a.name;
                    box.value = nbValues[a.name] || '';
                    box.setAttribute('list', 'dl-' + a.name);

                    // Create datalist
                    const datalist = document.createElement('datalist');
                    datalist.id = 'dl-' + a.name;
                    const options = NB_DATALIST_OPTIONS[a.name] || [];
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        datalist.appendChild(option);
                    });
                    wrapper.appendChild(datalist);

                    box.oninput = (e) => {
                        nbValues[a.name] = e.target.value;
                        syncFromVisualToForm(a.name, e.target.value);
                        // Trigger diagnosis generation for delivery mode and sex
                        if (a.name === 'Text30' || a.name === 'Text39') {
                            generateNbDiagnosis();
                        }
                    };
                } else if (fieldType === 'datetime') {
                    box = document.createElement('input');
                    box.type = 'datetime-local';
                    box.className = 'nb-pdf-datetime';
                    box.dataset.field = a.name;
                    box.value = nbValues[a.name] || '';
                    box.onchange = (e) => {
                        nbValues[a.name] = e.target.value;
                        syncFromVisualToForm(a.name, e.target.value);
                    };
                } else if (fieldType === 'text') {
                    // Text input field (like weight with "kg" default)
                    box = document.createElement('input');
                    box.type = 'text';
                    box.className = 'nb-pdf-text';
                    box.dataset.field = a.name;
                    box.value = nbValues[a.name] || '';
                    box.oninput = (e) => {
                        nbValues[a.name] = e.target.value;
                        syncFromVisualToForm(a.name, e.target.value);
                    };
                } else if (fieldType === 'number') {
                    box = document.createElement('input');
                    box.type = 'number';
                    box.className = 'nb-pdf-number';
                    box.dataset.field = a.name;
                    box.value = nbValues[a.name] || '';
                    box.oninput = (e) => {
                        nbValues[a.name] = e.target.value;
                        syncFromVisualToForm(a.name, e.target.value);
                    };
                } else if (fieldType === 'clickable') {
                    // For Term/Preterm/AGA/SGA - clickable underline
                    box = document.createElement('div');
                    box.className = 'nb-pdf-clickable';
                    box.contentEditable = false;
                    box.dataset.field = a.name;
                    box.innerText = nbValues[a.name] || '';
                    box.style.textAlign = 'center';
                    box.style.cursor = 'pointer';
                    box.style.textDecoration = nbValues[a.name] === '____' ? 'underline' : 'none';
                    box.onclick = (e) => {
                        // Toggle selection
                        if (nbValues[a.name] === '____') {
                            nbValues[a.name] = '';
                            e.target.innerText = '';
                            e.target.style.textDecoration = 'none';
                        } else {
                            // Clear group selections
                            if (['Text59', 'Text60', 'Text61'].includes(a.name)) {
                                nbValues['Text59'] = ''; nbValues['Text60'] = ''; nbValues['Text61'] = '';
                                wrapper.querySelectorAll('.nb-pdf-clickable').forEach(el => {
                                    if (el.dataset.group === 'gest') {
                                        el.innerText = '';
                                        el.style.textDecoration = 'none';
                                    }
                                });
                            }
                            if (['Text62', 'Text63', 'Text64'].includes(a.name)) {
                                nbValues['Text62'] = ''; nbValues['Text63'] = ''; nbValues['Text64'] = '';
                                wrapper.querySelectorAll('.nb-pdf-clickable').forEach(el => {
                                    if (el.dataset.group === 'size') {
                                        el.innerText = '';
                                        el.style.textDecoration = 'none';
                                    }
                                });
                            }
                            nbValues[a.name] = '____';
                            e.target.innerText = '____';
                            e.target.style.textDecoration = 'underline';
                        }
                        generateNbDiagnosis();
                    };
                    // Set group data attribute
                    if (['Text59', 'Text60', 'Text61'].includes(a.name)) box.dataset.group = 'gest';
                    if (['Text62', 'Text63', 'Text64'].includes(a.name)) box.dataset.group = 'size';
                } else {
                    // Default: contenteditable text box
                    box = document.createElement('div');
                    box.className = 'pdf-box';
                    box.contentEditable = true;
                    box.dataset.field = a.name;
                    box.innerText = nbValues[a.name] || '';
                    box.oninput = (e) => {
                        nbValues[a.name] = e.target.innerText;
                        syncFromVisualToForm(a.name, e.target.innerText);
                        // Auto-generate diagnosis if this is Text31 (indication)
                        if (a.name === 'Text31') {
                            generateNbDiagnosis();
                        }
                    };
                }

                // Common styling with pixel-based positioning
                box.style.position = 'absolute';
                box.style.left = `${a.x * PREVIEW_WIDTH_PX}px`;
                box.style.top = `${a.y * PREVIEW_HEIGHT_PX}px`;
                box.style.width = `${a.w * PREVIEW_WIDTH_PX}px`;
                box.style.height = `${a.h * PREVIEW_HEIGHT_PX}px`;
                box.style.fontSize = `${activeFontSize * PT_TO_PX}px`;
                box.style.lineHeight = nbLineHeight;
                box.style.padding = '2px';
                box.style.boxSizing = 'border-box';
                box.style.border = '1px solid rgba(0,0,0,0.1)';
                box.style.background = 'rgba(255,255,255,0.8)';

                wrapper.appendChild(box);
            });
        }
        stage.appendChild(wrapper);
       }
    }

    function generateNbDiagnosis() {
       // Get values from nbValues instead of form elements
       let gest = '';
       if (nbValues['Text59'] === '____') gest = 'Term';
       if (nbValues['Text60'] === '____') gest = 'Preterm';
       if (nbValues['Text61'] === '____') gest = 'Postterm';

       let size = '';
       if (nbValues['Text62'] === '____') size = 'AGA';
       if (nbValues['Text63'] === '____') size = 'SGA';
       if (nbValues['Text64'] === '____') size = 'LGA';

       const sexVal = nbValues['Text39'] || '';
       const mode = nbValues['Text30'] || '';
       const ind = (nbValues['Text31'] || '').trim();

       let sexShort = 'M';
       if(sexVal === 'Female') sexShort = 'F';
       if(sexVal === 'Ambiguous') sexShort = 'Amb';

       // Abbreviate "Term" to "T", keep "Preterm" and "Postterm" full
       let gestShort = gest;
       if(gest === 'Term') gestShort = 'T';

       let modeStr = mode;
       if(mode !== 'SVD' && ind !== '' && mode !== '') {
           modeStr += ` for ${ind}`;
       } else if (mode === 'SVD' && ind !== '') {
           modeStr += ` for ${ind}`;
       }

       const parts = ['S/L'];
       if(gestShort) parts.push(gestShort);
       if(sexVal) parts.push(sexShort);
       if(size) parts.push(size);
       if(modeStr) parts.push(modeStr);

       const dx = parts.join('/') + " for observation";

       // Update nbValues and form fields
       nbValues['Text69'] = dx;
       document.getElementById('nb-generated-dx').value = dx;
       document.getElementById('nb-f-adm-dx').value = dx;

       // Sync to visual form if in visual mode
       syncNbVisualField('Text69', dx);
    }

    function changePdfFont(val) {
        const newSize = parseInt(val);
        if(currentMode === 'newborn') {
            nbFontSize = newSize;
            renderNbVisual();
        } else {
            pdfFontSize = newSize;
            renderPdfVisual();
        }
    }
    function changePdfLineHeight(val) {
        // User sets visual line height, convert to print line height
        pdfLineHeight = parseFloat(val) / visualLineHeightFactor;
        if(currentMode === 'pdf') renderPdfVisual();
        if(currentMode === 'newborn') renderNbVisual();
    }

    function toggleAutoFit(enabled) {
        isAutoFit = enabled;
        const fontSel = document.getElementById('sel-pdf-font');

        if (enabled) {
            // Calculate optimal font size (use appropriate values based on mode)
            const values = currentMode === 'newborn' ? nbValues : pdfValues;
            calculatedFontSize = calculateOptimalFontSize(9, 14);
            if (fontSel) {
                fontSel.disabled = true;
                fontSel.value = calculatedFontSize;
            }
        } else {
            // Restore manual control
            if (fontSel) {
                fontSel.disabled = false;
                fontSel.value = pdfFontSize;
            }
        }

        if(currentMode === 'pdf') renderPdfVisual();
        if(currentMode === 'newborn') renderNbVisual();
    }

    function syncPdfControls() {
        const fontSel = document.getElementById('sel-pdf-font');
        const lineSel = document.getElementById('sel-pdf-line');
        const autoFitChk = document.getElementById('chk-auto-fit');

        if (autoFitChk) autoFitChk.checked = isAutoFit;

        if (isAutoFit) {
            if (fontSel) {
                fontSel.disabled = true;
                fontSel.value = calculatedFontSize;
            }
        } else {
            if (fontSel) {
                fontSel.disabled = false;
                fontSel.value = pdfFontSize;
            }
        }

        // Display the visual line height value (what user sees on screen)
        if (lineSel) lineSel.value = (pdfLineHeight * visualLineHeightFactor).toFixed(1);
    }

    function syncFormToPdf() { Object.keys(MAP_FORM_PDF).forEach(fid => { const el = document.getElementById(fid); if(el) { pdfValues[MAP_FORM_PDF[fid]] = el.value || ''; } }); }
    function syncPdfToForm() { Object.keys(MAP_FORM_PDF).forEach(fid => { const pdfKey = MAP_FORM_PDF[fid]; if (pdfValues[pdfKey] !== undefined) { const el = document.getElementById(fid); if(el) el.value = pdfValues[pdfKey]; } }); }

    function openAdmissionForPatient() {
        if(!currentPatientId || !localPatients[currentPatientId]) return; const p = localPatients[currentPatientId];
        launchAdmissionSystem(false);
        setTimeout(() => { const btnSave = document.getElementById('btn-save-edits'); const btnPrint = document.getElementById('btn-print-add'); if(btnSave) { btnSave.style.display = 'inline-block'; btnSave.innerText = "Save Edits"; btnSave.style.background = "#ffc107"; btnSave.disabled = false; } if(btnPrint) btnPrint.style.display = 'none'; }, 50);

        if(p.newbornData) {
            setMode('newborn');
            nbValues = { ...p.newbornData };

            // Set patient detail fields
            document.getElementById('nb-f-name').value = p.name || '';
            document.getElementById('nb-f-hosp-no').value = p.id || '';
            document.getElementById('nb-f-nid-no').value = p.nid || '';
            document.getElementById('nb-f-ward').value = p.ward || 'GW';
            document.getElementById('nb-f-bed').value = p.bed || '';
            document.getElementById('nb-f-shift').value = p.shift || 'Morning';
            document.getElementById('nb-f-doa').value = p.doa || '';
            document.getElementById('nb-f-adm-dx').value = p.diagnosis || '';

            // Load ALL 50+ fields from nbValues using our comprehensive function
            loadAllNbFieldsFromValues();

        } else if (p.admissionData) {
            pdfValues = { ...p.admissionData }; if(p.age) pdfValues['age'] = p.age; 
            pdfValues['ward'] = p.ward; pdfValues['bed'] = p.bed; pdfValues['shift'] = p.shift;
            Object.keys(MAP_FORM_PDF).forEach(fid => { const pdfKey = MAP_FORM_PDF[fid]; if(pdfValues[pdfKey]) { const el = document.getElementById(fid); if(el) el.value = pdfValues[pdfKey]; } });
            document.getElementById('f-hosp-no').value = p.id || ''; document.getElementById('f-nid-no').value = p.nid || '';
            if(p.diagnosis) { document.getElementById('f-adm-dx').value = p.diagnosis; document.getElementById('f-finaldx').value = p.diagnosis; }
            document.getElementById('f-weight').value = p.weight || '';
            syncFormToPdf(); 
        } else {
            document.getElementById('f-name').value = p.name || ''; document.getElementById('f-hosp-no').value = p.id || ''; 
            syncFormToPdf(); 
        }
    }

    /**
     * WYSIWYG Text Wrapping Function
     * Calculates exactly where text lines break based on PDF rendering metrics.
     * This ensures identical line breaks between screen display and printed PDF.
     *
     * @param {string} text - The text to wrap
     * @param {number} maxWidth - Maximum width in PDF points (e.g., box width * 595 - padding)
     * @param {number} fontSize - Font size in PDF points
     * @returns {string} Text with newline characters inserted at wrap points
     */
    function getWrappedText(text, maxWidth, fontSize) {
        if (!text) return '';

        // Create canvas for measuring text width using same font as PDF
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.font = `${fontSize}px Helvetica`;

        // Split text into lines (preserving existing newlines)
        const paragraphs = text.split('\n');
        const wrappedLines = [];

        for (const paragraph of paragraphs) {
            if (!paragraph.trim()) {
                // Preserve empty lines
                wrappedLines.push('');
                continue;
            }

            const words = paragraph.split(' ');
            let currentLine = words[0] || '';

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine + ' ' + word;
                const width = ctx.measureText(testLine).width;

                if (width < maxWidth) {
                    currentLine = testLine;
                } else {
                    // Line would exceed maxWidth, break here
                    wrappedLines.push(currentLine);
                    currentLine = word;
                }
            }

            // Add the last line of this paragraph
            if (currentLine) {
                wrappedLines.push(currentLine);
            }
        }

        return wrappedLines.join('\n');
    }

    function calculateOptimalFontSize(minSize, maxSize) {
       if(Object.keys(anchors).length === 0) return maxSize; const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
       const checkFit = (size) => {
         ctx.font = `${size}px Helvetica`; const lineHeight = size * pdfLineHeight;
         for(const pageNum in anchors) {
             for(const a of anchors[pageNum]) {
                const text = String(pdfValues[a.name] || '').trim(); if(!text) continue; const pageWidth = 595; const pageHeight = 842; const boxW = a.w * pageWidth; const boxH = a.h * pageHeight;
                const words = text.split(' '); let lineCount = 1; let currentLineW = 0;
                for(const word of words) { const wordW = ctx.measureText(word + ' ').width; if (currentLineW + wordW > boxW) { lineCount++; currentLineW = wordW; } else { currentLineW += wordW; } }
                const totalH = lineCount * lineHeight; if(totalH > boxH) return false;
             }
         }
         return true;
       };
       for (let s = maxSize; s >= minSize; s--) { if (checkFit(s)) return s; } return minSize; 
    }
    
    function getAggregatedAdmissionData() {
        let aggregatedHopi = ""; const addLine = (label, val) => { if(val && val.trim()) aggregatedHopi += `${label}:\n${val.trim()}\n\n`; };
        addLine("C/O", pdfValues['complains']); addLine("HOPI", pdfValues['hopi']); addLine("Past Hx", pdfValues['pasthx']); addLine("Personal Hx", pdfValues['personalhx']); addLine("Family Hx", pdfValues['fhx']); addLine("Tx Hx", pdfValues['txhx']); addLine("Obs/Gyn", pdfValues['obs']); addLine("G/E", pdfValues['ge']); addLine("CVS", pdfValues['cvs']); addLine("RS", pdfValues['rs']); addLine("Abd", pdfValues['pa']); addLine("Pelvis", pdfValues['pelvis']); addLine("CNS", pdfValues['cns']); addLine("Local", pdfValues['le']);
        return { hopi: aggregatedHopi, diagnosis: pdfValues['dx'] || "", plan: pdfValues['management'] || "" };
    }
async function saveEdits() {
    const btnSave = document.getElementById('btn-save-edits');
    if(btnSave) {
        btnSave.innerText = "Saving...";
        btnSave.style.background = "#0056b3"; 
        btnSave.disabled = true;
    }
    if(!currentPatientId) return;

    const p = localPatients[currentPatientId];
    const updates = {};

    // Helper to safely get values (PDF priority)
    const getVal = (nbKey, domId) => {
        const valFromPdf = nbValues[nbKey];
        const valFromDom = document.getElementById(domId)?.value;
        return (valFromPdf !== undefined && valFromPdf !== null && valFromPdf !== '') ? valFromPdf : (valFromDom || '');
    };

    if (currentMode === 'newborn') {
        // --- NEWBORN SAVE LOGIC ---
        updates.id = getVal('Text29', 'nb-f-hosp-no');
        updates.nid = getVal('Text42', 'nb-f-nid-no');
        
        const motherName = getVal('Text1', 'nb-m-name') || "Unknown";
        const manualName = document.getElementById('nb-f-name').value;
        updates.name = manualName || ("Baby of " + motherName);

        updates.ward = document.getElementById('nb-f-ward').value;
        updates.bed = document.getElementById('nb-f-bed').value;
        updates.shift = document.getElementById('nb-f-shift').value;
        updates.doa = document.getElementById('nb-f-doa').value; 

        // *** FIX: EXPLICITLY UPDATE SEX ***
        updates.sex = getVal('Text39', 'nb-sex-combo'); 

        updates.diagnosis = getVal('Text69', 'nb-f-adm-dx');
        
        let rawWeight = getVal('Text41', 'nb-b-wt');
        if(rawWeight && !rawWeight.toLowerCase().includes('kg')) rawWeight += ' kg';
        updates.weight = rawWeight;

        let dobString = getVal('Text35', 'nb-b-datetime');
        if(dobString) {
             dobString = dobString.replace(' ', 'T');
             const [d, t] = dobString.split('T');
             updates.dob = d; updates.dot = t; updates.isAutoAge = true;
             updates.age = calculateNeonatalAge(d, t).display;
        }

        nbValues['gest_val'] = document.getElementById('nb-gest-sel').value;
        nbValues['size_val'] = document.getElementById('nb-size-sel').value;
        
        // Ensure critical fields are in nbValues
        if(!nbValues['Text29']) nbValues['Text29'] = updates.id;
        if(!nbValues['Text42']) nbValues['Text42'] = updates.nid;
        if(!nbValues['Text39']) nbValues['Text39'] = updates.sex; // Ensure internal consistency

        updates.newbornData = { ...nbValues };
        updates.hopi = getNewbornHopiText(); 
        updates.plan = getVal('Text68', 'nb-advice') || "Routine Newborn Care";

    } else {
        // --- STANDARD SAVE LOGIC ---
        if(currentMode === 'form') syncFormToPdf();
        else syncPdfToForm();
        
        const hospNo = document.getElementById('f-hosp-no').value || "";
        const rawAge = document.getElementById('f-age').value || "?";
        
        pdfValues['hid'] = hospNo;
        pdfValues['ward'] = document.getElementById('f-ward').value;
        pdfValues['bed'] = document.getElementById('f-bed').value;
        pdfValues['name'] = document.getElementById('f-name').value;
        pdfValues['age'] = rawAge; 

        updates.name = document.getElementById('f-name').value;
        updates.id = hospNo;
        updates.nid = document.getElementById('f-nid-no').value;
        updates.bed = document.getElementById('f-bed').value;
        updates.ward = document.getElementById('f-ward').value;
        updates.shift = document.getElementById('f-shift').value;
        updates.sex = document.getElementById('f-sex').value;
        updates.age = rawAge;
        updates.doa = document.getElementById('f-doa').value;
        updates.weight = document.getElementById('f-weight').value;
        updates.admissionData = { ...pdfValues };
        
        Object.keys(MAP_PDF_DB).forEach(pk => { 
            if(pdfValues[pk]) { updates[MAP_PDF_DB[pk]] = pdfValues[pk]; }
        });
        
        const aggregated = getAggregatedAdmissionData();
        updates.hopi = aggregated.hopi;
        updates.diagnosis = aggregated.diagnosis;
        updates.plan = aggregated.plan;
    }
    
    // Log overwriting logic
    if (updates.plan && p.logs) {
        const newPlanText = updates.plan.trim();
        const logPattern = /(‚Ä¢.*?\n\s*Admission Plan:\s*\n)([\s\S]*?)(?=\n\s*‚Ä¢|$)/i;
        if (logPattern.test(p.logs)) {
            updates.logs = p.logs.replace(logPattern, `$1${newPlanText}`);
        } else {
            const header = `‚Ä¢ ${formatTimestamp(p.timestamp || Date.now())}\n Admission Plan:\n`;
            updates.logs = p.logs + `\n${header}${newPlanText}\n\n`;
        }
    }

    try {
        await db.collection('patients').doc(currentPatientId).update(updates);
        alert("Saved successfully!");
        closeAdmissionSystem();
    } catch (err) {
        console.error("Save failed: ", err);
        alert("Error saving: " + err.message);
    } finally {
        if(btnSave) {
            btnSave.innerText = "Save Edits";
            btnSave.style.background = "#ffc107";
            btnSave.disabled = false;
        }
    }
}

async function saveAndAddNewborn(printWin) {
        // REMOVED: syncAllNbFieldsToValues(); 
        // Reason: It was overwriting Visual PDF edits with empty data from hidden sidebar inputs.

        const p = { 
            timestamp: Date.now(), 
            isNew: true, 
            logs: '', 
            lastLoggedPlan: '', 
            labs: {dates:[], tests:{}}, 
            images: [] 
        };
        
        // --- 1. ROBUST DATA CAPTURE ---
        
        // Helper: Get value from Visual PDF State OR Sidebar DOM
        // This ensures we don't lose data if one side didn't sync to the other
        const getVal = (nbKey, domId) => {
            const valFromPdf = nbValues[nbKey];
            const valFromDom = document.getElementById(domId)?.value;
            // Return PDF value if exists, otherwise DOM value, otherwise empty string
            return (valFromPdf !== undefined && valFromPdf !== null && valFromPdf !== '') ? valFromPdf : (valFromDom || '');
        };

        // IDs
        p.id = getVal('Text29', 'nb-f-hosp-no');
        p.nid = getVal('Text42', 'nb-f-nid-no');
        
        // Name
        const motherName = getVal('Text1', 'nb-m-name') || "Unknown";
        // Manual baby name input takes precedence, then constructed name
        const manualBabyName = document.getElementById('nb-f-name').value; 
        p.name = manualBabyName || ("Baby of " + motherName);
        
        // Location & Shift
        p.ward = document.getElementById('nb-f-ward').value || "GW";
        p.bed = document.getElementById('nb-f-bed').value;
        p.shift = document.getElementById('nb-f-shift').value;
        
        // DOA (Sidebar only)
        p.doa = document.getElementById('nb-f-doa').value || getLocalISODate();

        // --- CRITICAL FIELDS ---

        // Diagnosis
        p.diagnosis = getVal('Text69', 'nb-f-adm-dx');

        // Plan (Advice)
        p.plan = getVal('Text68', 'nb-advice') || "Routine Newborn Care";

        // Sex (Explicit Fix)
        p.sex = getVal('Text39', 'nb-sex-combo') || 'Unknown';

        // Weight
        let rawWeight = getVal('Text41', 'nb-b-wt');
        if(rawWeight && !rawWeight.toLowerCase().includes('kg')) {
            rawWeight += ' kg';
        }
        p.weight = rawWeight;
        
        // Age & DOB
        let dobString = getVal('Text35', 'nb-b-datetime');
        if (dobString) {
            dobString = dobString.replace(' ', 'T'); 
            const [d, t] = dobString.split('T');
            p.dob = d; 
            p.dot = t; 
            p.isAutoAge = true;
            p.age = calculateNeonatalAge(d, t).display;
        } else {
            p.age = "0 DOL";
            p.isAutoAge = false;
        }
        
        // Store form state
        nbValues['gest_val'] = document.getElementById('nb-gest-sel').value;
        nbValues['size_val'] = document.getElementById('nb-size-sel').value;
        
        // Ensure nbValues is fully populated for the PDF generation
        // (We update any missing nbValues from the DOM now, SAFELY, without overwriting existing data)
        if(!nbValues['Text29']) nbValues['Text29'] = p.id;
        if(!nbValues['Text42']) nbValues['Text42'] = p.nid;
        if(!nbValues['Text39']) nbValues['Text39'] = p.sex;
        
        p.newbornData = { ...nbValues };
        
        // Generate HOPI
        p.hopi = getNewbornHopiText();

        // Create Logs
        let logs = `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Record Created.\n\n`;
        if(p.plan) { 
            logs += `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Plan:\n${p.plan}\n\n`; 
        }
        p.logs = logs;
        
        // Ensure PDF Value for weight has 'kg' for the printout
        if(nbValues['Text41'] && !nbValues['Text41'].toLowerCase().includes('kg')) {
            nbValues['Text41'] += ' Kg';
        }

        try {
            await db.collection('patients').add(p);
            
            await ensurePDFLib(); 
            const bytes = await fetch(NEWBORN_URL).then(r => r.arrayBuffer());
            const pdf = await PDFLib.PDFDocument.load(bytes);
            const form = pdf.getForm();
            for (const [key, val] of Object.entries(nbValues)) {
                try { const f = form.getTextField(key); if(f) f.setText(String(val)); } catch(e) {}
            }
            const pdfOut = await pdf.save();
            const blob = new Blob([pdfOut], { type: 'application/pdf' });
            printWin.location.href = URL.createObjectURL(blob);
            
            closeAdmissionSystem();
        } catch(e) {
            alert("Error: " + e.message);
            printWin.close();
        }
    }
    
    async function printOnly() {
       const printWin = window.open('', '_blank');
       if(printWin) { printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;"><h2>Generating PDF... Please wait.</h2></body></html>'); } 
       else { alert("Please allow popups to print."); }
       
       if (currentMode === 'newborn') {
           try {
               await ensurePDFLib(); // Ensure PDF-lib is loaded
               nbValues['Text29'] = document.getElementById('nb-f-hosp-no').value;
               nbValues['Text42'] = document.getElementById('nb-f-nid-no').value;
               
               const bytes = await fetch(NEWBORN_URL).then(r => r.arrayBuffer());
               const pdf = await PDFLib.PDFDocument.load(bytes);
               const form = pdf.getForm();
               for (const [key, val] of Object.entries(nbValues)) {
                   try { const f = form.getTextField(key); if(f) f.setText(String(val)); } catch(e) {}
               }
               const pdfOut = await pdf.save();
               const blob = new Blob([pdfOut], { type: 'application/pdf' });
               printWin.location.href = URL.createObjectURL(blob);
           } catch(e) {
               printWin.close(); alert(e.message);
           }
           return;
       }

       if(currentMode==='form') syncFormToPdf();
       
       const hospNo = document.getElementById('f-hosp-no').value || "";
       const rawWard = document.getElementById('f-ward').value || "";
       const rawBed = document.getElementById('f-bed').value || "";
       const rawAge = document.getElementById('f-age').value || "?";
       const rawSex = document.getElementById('f-sex').value || "Male";
       
       pdfValues['hid'] = hospNo;
       pdfValues['ward'] = rawWard;
       pdfValues['bed'] = rawBed;
       pdfValues['age'] = rawAge;
       pdfValues['sex'] = rawSex;
       pdfValues['nid'] = formatTimestamp(Date.now());

       await generatePdfBlob(currentMode === 'form', printWin);
    }

    async function printRequestOnly() {
        if (currentMode === 'newborn') {
            const printWin = window.open('', '_blank');
            if(!printWin) { alert("Popups needed."); return; }
            printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;"><h2>Request PDF...</h2></body></html>');
            try {
                await ensurePDFLib(); // Ensure PDF-lib is loaded
                const bytes = await fetch(REQUEST_URL).then(r => r.arrayBuffer());
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const form = pdf.getForm();
                const fieldMap = {
                    'Text21': document.getElementById('nb-f-name').value,
                    'Text20': document.getElementById('nb-f-hosp-no').value,
                    'Text23': document.getElementById('nb-f-nid-no').value,
                    'Text22': document.getElementById('nb-f-ward').value,
                    'Text24': document.getElementById('nb-f-bed').value,
                    'Text27': document.getElementById('nb-f-doa').value,
                    'Text29': document.getElementById('nb-f-adm-dx').value
                };
                Object.keys(fieldMap).forEach(k => { try { const f = form.getTextField(k); if (f) f.setText(String(fieldMap[k]||'')); } catch (e) {} });
                const pdfOut = await pdf.save();
                const url = URL.createObjectURL(new Blob([pdfOut], { type: 'application/pdf' }));
                printWin.location.href = url;
            } catch(e) { console.error(e); printWin.close(); alert(e.message); }
            return;
        }

        if(currentMode === 'form') syncFormToPdf(); else syncPdfToForm();
        
        const printWin = window.open('', '_blank');
        if(!printWin) { alert("Please allow popups."); return; }
        printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h2>Filling Admission Request...</h2></body></html>');
        
        try {
            await ensurePDFLib(); // Ensure PDF-lib is loaded
            const bytes = await fetch(REQUEST_URL).then(r => r.arrayBuffer());
            const pdf = await PDFLib.PDFDocument.load(bytes);
            const form = pdf.getForm();
            const fieldMap = {
                'Text21': pdfValues['name'] || document.getElementById('f-name').value,
                'Text20': document.getElementById('f-hosp-no').value,
                'Text23': document.getElementById('f-nid-no').value,
                'Text22': pdfValues['ward'] || document.getElementById('f-ward').value,
                'Text24': pdfValues['bed'] || document.getElementById('f-bed').value,
                'Text27': pdfValues['doa'] || document.getElementById('f-doa').value,
                'Text29': document.getElementById('f-adm-dx').value
            };
            Object.keys(fieldMap).forEach(fieldName => { try { const field = form.getTextField(fieldName); if (field) { const val = fieldMap[fieldName] || ''; field.setText(String(val)); } } catch (err) { console.warn(`Field '${fieldName}' not found in PDF. Ignoring.`); } });
            const pdfOut = await pdf.save();
            const blob = new Blob([pdfOut], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            printWin.location.href = url;
        } catch (e) { console.error(e); printWin.document.body.innerHTML = "Error: " + e.message; }
    }

    async function generatePdfBlob(autoFit, targetWindow) {
       await ensurePDFLib(); // Load PDF-lib if not already loaded
       try {
           const bytes = await fetch(PDF_URL).then(r=>r.arrayBuffer());
           const pdf = await PDFLib.PDFDocument.load(bytes);
           const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
           const pages = pdf.getPages();

           // Use isAutoFit state or autoFit parameter
           const shouldAutoFit = isAutoFit || autoFit;
           let useFontSize = pdfFontSize;

           if(shouldAutoFit) {
               // Reuse already calculated font size if available, otherwise calculate
               useFontSize = isAutoFit ? calculatedFontSize : calculateOptimalFontSize(9, 14);
           }

           Object.keys(anchors).forEach(pNum => {
              if(!pages[pNum-1]) return;
              const page = pages[pNum-1];
              const { width, height } = page.getSize();
              anchors[pNum].forEach(a => {
                 let rawVal = pdfValues[a.name];
                 if (a.name === 'age') { const sex = document.getElementById('f-sex').value || (pdfValues['sex'] || ''); rawVal = (rawVal || '') + " / " + sex; }
                 let text = (rawVal === null || rawVal === undefined) ? '' : String(rawVal).trim();
                 text = text.replace(/[\u2010-\u2015]/g, "-").replace(/[^\x00-\x7F]/g, "");
                 if(!text) return;
                 let fs = shouldAutoFit ? useFontSize : pdfFontSize;

                 // WYSIWYG: Pre-wrap text using same calculation as visual display
                 const boxWidth = (a.w * width) - 4;
                 const wrappedText = getWrappedText(text, boxWidth, fs);

                 page.drawText(wrappedText, { x: a.x * width + 2, y: height - (a.y * height) - fs, size: fs, font: font, lineHeight: fs * pdfLineHeight });
              });
           });
           const pdfOut = await pdf.save();
           const blob = new Blob([pdfOut], { type: 'application/pdf' });
           const url = URL.createObjectURL(blob);
           if (targetWindow && !targetWindow.closed) { targetWindow.location.href = url; } else { window.open(url, '_blank'); }
       } catch (e) { throw e; }
    }

    function saveTemplate() { const name = prompt("Template Name:"); if(name) { db.collection('admissions').add({ type:'template', name, values: {...pdfValues} }).then(loadTemplates); } }
    function loadTemplates() {
       db.collection('admissions').where('type','==','template').onSnapshot(snap => {
          const list = document.getElementById('template-list'); list.innerHTML='';
          snap.forEach(doc => {
             const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #eee'; d.style.cursor='pointer';
             d.innerHTML = `<span>${doc.data().name}</span> <span style="float:right;color:red;">√ó</span>`;
             d.onclick = (e) => {
                 if(e.target.innerText==='√ó') { e.stopPropagation(); db.collection('admissions').doc(doc.id).delete(); return; }
                 pdfValues = { ...doc.data().values }; syncPdfToForm(); if(currentMode === 'pdf') renderPdfVisual();
             };
             list.appendChild(d);
          });
       });
    }

    // --- REVISED saveAndAdd (Standard) to fix UNDEFINED error ---
    async function saveAndAdd() {
       const printWin = window.open('', '_blank');
       if (printWin) { printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h2>Saving & Generating PDF...</h2></body></html>'); } else { alert("Please allow popups to print."); return; }

       if (currentMode === 'newborn') { saveAndAddNewborn(printWin); return; }

       // Always sync from form to capture user input, regardless of mode
       syncFormToPdf();

       const p = { timestamp: Date.now(), isNew: true, logs: '', lastLoggedPlan: '', labs: {dates:[], tests:{}}, images: [] };
       
       const rawName = document.getElementById('f-name').value || "Unknown"; 
       const hospNo = document.getElementById('f-hosp-no').value || ""; 
       const nidNo = document.getElementById('f-nid-no').value || "";
       const rawAge = document.getElementById('f-age').value || "?";
       const rawSex = document.getElementById('f-sex').value || "Male";
       const rawWard = document.getElementById('f-ward').value || "PW";
       const rawBed = document.getElementById('f-bed').value || "";

       p.name = rawName;
       p.id = hospNo;
       p.nid = nidNo;
       p.bed = rawBed;
       p.ward = rawWard;
       p.sex = rawSex;
       p.isNew = true; 

       let isAuto = false;
       const autoRadio = document.getElementById('adm-radio-auto');
       if(autoRadio) isAuto = autoRadio.checked;
       const dob = document.getElementById('f-dob').value;
       const dot = document.getElementById('f-dot').value;
       if (isAuto && dob && dot) {
           p.age = calculateNeonatalAge(dob, dot).display;
           p.dob = dob; p.dot = dot; p.isAutoAge = true;
       } else {
           p.age = rawAge;
       }

       pdfValues['age'] = p.age;
       pdfValues['hid'] = hospNo;
       pdfValues['ward'] = p.ward;
       pdfValues['bed'] = p.bed;
       pdfValues['name'] = p.name;
       pdfValues['nid'] = formatTimestamp(Date.now());
       
       p.doa = document.getElementById('f-doa').value || getLocalISODate();
       p.shift = document.getElementById('f-shift').value || 'Morning';
       p.weight = document.getElementById('f-weight').value || '';
       p.admissionData = { ...pdfValues };
       
       Object.keys(MAP_PDF_DB).forEach(pk => {
           if(!p[MAP_PDF_DB[pk]] && pdfValues[pk]) { p[MAP_PDF_DB[pk]] = pdfValues[pk]; }
       });
       
       const aggregated = getAggregatedAdmissionData();
       p.hopi = aggregated.hopi;
       p.diagnosis = aggregated.diagnosis;
       p.plan = aggregated.plan;
       
       // --- FIX STARTS HERE ---
    // Force read from the DOM element to ensure we catch exactly what is on screen
    const rawPlanInput = document.getElementById('f-plan').value || aggregated.plan || "";

    let logs = `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Record Created.\n\n`;
    
    // Check rawPlanInput instead of aggregated.plan
    if(rawPlanInput && rawPlanInput.trim().length > 0) {
        logs += `‚Ä¢ ${formatTimestamp(Date.now())}\n Admission Plan:\n${rawPlanInput.trim()}\n\n`;
    }
    p.logs = logs;
    // --- FIX ENDS HERE ---

       try { await db.collection('patients').add(JSON.parse(JSON.stringify(p))); } 
       catch (dbError) { alert("CRITICAL ERROR: " + dbError.message); if(printWin) printWin.close(); return; }
       
       try { await generatePdfBlob(currentMode === 'form', printWin); } 
       catch (pdfError) { console.error(pdfError); if (printWin) printWin.document.body.innerHTML = "<h2 style='color:red'>PDF Failed</h2>"; alert("Saved, but PDF failed."); }
       
       closeAdmissionSystem();
       pdfValues={};
       document.querySelectorAll('#view-form input, #view-form textarea').forEach(e=>e.value='');
       document.getElementById('f-complaints').value='';
    }

    // Re-render the visual mode when window size changes
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // Scale and storedScaleFit recalculate automatically on each render
            if (currentMode === 'pdf') renderPdfVisual();
            if (currentMode === 'newborn') renderNbVisual();
        }, 100); // Small delay to improve performance
    });
  </script>
</body>
</html>
