<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Pediatric Handover System</title>
  <meta name="viewport" content="width=960, user-scalable=yes">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
  <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
      --bg: #f4f7fb; --primary: #0066cc; --primary-dark: #004a99; --accent: #2a9d8f; --text: #1d3557;
      --card-bg: #ffffff; --shadow: 0 3.8px 11.4px rgba(0,0,0,0.08); --border: #aaa;
      --editable-border: #ccc; --editable-focus: #888;
      --PW: #d1e7ff; --GW: #fde2e4; --SW: #e2f0cb; --PVT: #fff3cd; --ICU: #d4edda; --NICU: #f8d7da; --ER: #f5f5f5; --Discharge: #e2e3e5;
      --new-btn: #f6a623; --discharge-btn: #28a745;
      --panel-width: 437px; --panel-height: 342px;
    }
    [data-theme="dark"] {
      --bg: #1a202c; --primary: #4299e1; --primary-dark: #2b6cb0; --accent: #38b2ac; --text: #e2e8f0;
      --card-bg: #2d3748; --shadow: 0 3.8px 11.4px rgba(0,0,0,0.3); --border: #4a5568;
      --editable-border: #718096; --editable-focus: #a0aec0;
      --PW: #2c5282; --GW: #9b2c2c; --SW: #5a7f3f; --PVT: #b7791f; --ICU: #276749; --NICU: #9b2c2c; --ER: #4a5568; --Discharge: #3f3f46;
      --new-btn: #f6a623; --discharge-btn: #28a745;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; padding: 22.8px; background: var(--bg); color: var(--text); -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    h1 { margin: 0 0 22.8px; text-align: center; font-weight: 700; font-size: 28.5px; }
    
    .top-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 7.6px; margin-bottom: 15.2px; align-items: stretch; }
    .top-buttons button, .dropdown-btn, .theme-toggle { 
        padding: 9.5px 19px; font-weight: 600; border: none; border-radius: 7.6px; 
        cursor: pointer; transition: background 0.2s, transform 0.2s; font-size: 15.2px; 
        display: inline-flex; align-items: center; justify-content: center; 
        height: 42px; box-sizing: border-box; vertical-align: middle;
    }
    .top-buttons button:hover, .dropdown:hover .dropdown-btn { transform: translateY(-1.9px); }
    .add { background: var(--primary); color: #fff; }
    .btn-green { background: #28a745; color: #fff; }
    .btn-teal { background: #17a2b8; color: #fff; }
    .btn-teal:hover { background: #138496; }

    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { background: var(--accent); color: #fff; }
    .dropdown-content { display: none; position: absolute; background-color: var(--card-bg); min-width: 160px; box-shadow: var(--shadow); z-index: 100; border-radius: 7.6px; overflow: hidden; border: 1px solid var(--border); }
    .dropdown-content a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; cursor: pointer; }
    .dropdown-content a:hover { background-color: var(--bg); }
    .dropdown:hover .dropdown-content { display: block; }
    .theme-toggle { background: #6b7280; color: #fff; font-size: 17.1px; width: 42px; padding: 0; }
    .theme-toggle::before { content: '‚òÄ'; }
    [data-theme="dark"] .theme-toggle::before { content: 'üåô'; }
    
    .top-panel { display: flex; gap: 15.2px; align-items: stretch; justify-content: center; margin: 0 auto 22.8px; max-width: 100%; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 3.8px; }
    .panel-card { background: var(--card-bg); padding: 17.1px; border-radius: 11.4px; box-shadow: var(--shadow); width: var(--panel-width); height: var(--panel-height); flex: 0 0 var(--panel-width); }
    #handoverHeader table { margin: 15.2px 0 0 0; border-collapse: collapse; width: 100%; }
    #handoverHeader th, #handoverHeader td { border: none; padding: 5.7px; font-size: 14.3px; vertical-align: top; }
    #handoverHeader th { background: var(--bg); }
    #handoverHeader input { width: 57px; padding: 3.8px; border: 0.95px solid var(--border); border-radius: 3.8px; text-align: center; background: var(--card-bg); color: var(--text); font-size: 14.3px; }
    #notesText { width: 100%; min-height: 171px; padding: 9.5px; border-radius: 7.6px; border: 0.95px solid var(--border); background: var(--bg); color: var(--text); resize: vertical; font-size: 14.3px; }
    
    .form-section { display: none; background: var(--card-bg); padding: 22.8px; border-radius: 11.4px; max-width: 494px; margin: 0 auto 30.4px; box-shadow: var(--shadow); }
    .form-section input, .form-section select, .form-section textarea { width: 100%; margin: 5.7px 0 11.4px; padding: 9.5px; border: none; border-radius: 7.6px; font-size: 14.3px; background: var(--bg); color: var(--text); }
    .form-section textarea { min-height: 95px; resize: vertical; }
    .form-section button { width: 100%; padding: 11.4px; background: var(--primary); color: #fff; border: none; border-radius: 7.6px; font-weight: 600; font-size: 14.3px; }
    
    #form-age-toggle { display: block !important; margin-bottom: 10px; }
    .age-toggle { background: var(--card-bg); padding: 7.6px; border-radius: 3.8px; margin-top: 3.8px; border: 0.95px solid var(--border); display: none; text-align: left; font-size: 15px; }
    .age-toggle label { font-size: 12.4px; margin: 0 7.6px 0 0; gap: 3.8px; display: inline-flex; align-items: center; }
    .age-toggle input[type="radio"] { width: auto; margin: 0 4px 0 0; }
    .auto-age-inputs { display: flex; gap: 7.6px; margin-top: 3.8px; }
    .auto-age-inputs input { padding: 5.7px; border: 0.95px solid var(--editable-border); border-radius: 3.8px; background: var(--bg); color: var(--text); width: 100%; font-size: 14.3px; margin: 0; }
    .new-checkbox { margin-top: 7.6px; text-align: left; }
    .new-checkbox label { display: inline-flex; align-items: center; font-size: 15px; }
    .new-checkbox input { width: auto; margin-right: 5px; }
    
    .ward-header { text-align: center; font-size: 19px; font-weight: 600; margin: 30.4px 0 7.6px; padding: 7.6px; border-radius: 7.6px; }
    .ward-header.discharge-header { cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .ward-header.discharge-header::before { content: '‚ñ∫'; margin-right: 7.6px; font-size: 15.2px; }
    .ward-header.discharge-header.expanded::before { content: '‚ñº'; }
    
    .card-grid { display: flex; flex-wrap: wrap; gap: 15.2px; justify-content: flex-start; }
    #ward-Discharge.card-grid { display: none; }
    #ward-Discharge.card-grid.expanded { display: flex; }
    
    .patient-card { background: var(--card-bg); padding: 17.1px; border-radius: 11.4px; box-shadow: var(--shadow); position: relative; transition: transform 0.18s; padding-top: 50px; font-size: 15px; width: 295px; }
    .patient-card:hover { transform: scale(1.015); }
    .patient-card p { margin: 3.8px 0; font-size: 15px; }
    .patient-card p strong { font-weight: 700; font-size: 15px; }
    
    .card-ctrl { position: absolute; top: 10px; height: 26px; border-radius: 3.8px; display: flex; align-items: center; justify-content: center; font-size: 12.4px; z-index: 10; font-weight: 600; }
    .delete-btn { right: 9.5px; border: none; cursor: pointer; opacity: 0.7; background: #e63946; color: #fff; padding: 0 8px; min-width: 26px; }
    .new-badge { right: 42px; background: var(--new-btn); color: #fff; padding: 0 8px; display: none; opacity: 0.7; }
    .new-badge.new-active { display: flex; }
    .discharge-badge { left: 45px; background: var(--discharge-btn); color: #fff; padding: 0 8px; display: none; opacity: 0.9; }
    .discharge-badge.discharge-active { display: flex !important; }
    .expand-btn { left: 9.5px; background: var(--accent); color: #fff; border: none; width: 28px; cursor: pointer; font-size: 16px; opacity: 0.5; transition: opacity 0.2s; }
    .expand-btn:hover { opacity: 1; }
  
    .editable { border: none; background: transparent; border-bottom: 0.95px dashed var(--editable-border); padding: 0 3.8px; min-width: 19px; white-space: pre-wrap; font-size: 15px; display: inline; }
    .editable:focus { outline: none; border-bottom: 0.95px solid var(--editable-focus); }
    
    .patient-card p .editable[id^="new-plan-"] {
        display: block; 
        width: 100%; 
        min-height: 20px;
    }

    /* ARROW & EXPANSION STYLES */
    .hopi-toggle { cursor: pointer; color: var(--text); font-weight: 600; margin: 3.8px 0; font-size: 15px; display: inline-flex; align-items: center; }
    .hopi-toggle::after { content: '‚ñ∫'; margin-left: 5px; font-size: 12px; transition: transform 0.2s; display: inline-block; }
    .hopi-toggle.expanded::after { transform: rotate(90deg); }

    .hopi-content { display: none; color: var(--text); font-size: 15px; }
    .hopi-content.expanded { display: block; }
    
    .inline-fields { display: flex; gap: 7.6px; align-items: baseline; }
    .inline-fields strong { flex-shrink: 0; font-size: 15px; }
    
    /* LOGGING & HISTORY STYLES */
    .log-btn { padding: 5.7px 11.4px; border: none; border-radius: 3.8px; cursor: pointer; color: #fff; margin: 7.6px 0; font-size: 15px; transition: background-color 0.2s; }
    .log-btn:disabled { cursor: not-allowed; background: #6c757d !important; color: #eee; opacity: 0.6; }
    .log-btn:not(:disabled) { background: #28a745; }
    
    .current-plan-label { font-weight: 600; margin-top: 7.6px; display: block; font-size: 15px; }

    /* HISTORY LIST STYLES */
    .patient-card .history-list { margin: 5px 0; padding: 0 0 0 4px; list-style: none; }
    
    .patient-card .history-item { 
        padding-left: 12px; margin-bottom: 8px; border-left: 2px solid var(--border); 
        position: relative; 
    }
    .patient-card .history-item::before { 
        content: ''; position: absolute; left: -4px; top: 6px; 
        width: 6px; height: 6px; border-radius: 50%; background: var(--primary); 
    }
    .patient-card .history-date { font-size: 11px; opacity: 0.8; font-weight: 700; color: var(--primary); }
    .patient-card .history-text { font-size: 15px; line-height: 1.4; white-space: pre-wrap; }
    
    .recent-logs-container { margin: 8px 0; max-height: 200px; overflow-y: auto; padding-left: 4px; }

    /* EDIT & DELETE STYLES FOR LOGS */
    .edit-history-link { font-size: 12px; color: var(--primary); cursor: pointer; margin-left: auto; margin-right: 10px; font-weight: 600; }
    .edit-history-link:hover { text-decoration: underline; }

    .history-text[contenteditable="true"]:hover,
    .history-text[contenteditable="true"]:focus {
        background-color: rgba(0, 0, 0, 0.03);
        outline: none;
        border-radius: 4px;
    }
    
    .log-delete-btn {
        position: absolute; right: 0; top: 0; color: #e63946; font-weight: bold; cursor: pointer;
        font-size: 16px; padding: 2px 8px; opacity: 0.4; transition: opacity 0.2s; z-index: 10;
        display: none;
    }
    .history-list.editing-mode .log-delete-btn { display: block; }
    .log-delete-btn:hover { opacity: 1; background-color: rgba(230, 57, 70, 0.1); border-radius: 4px; }
    .history-item.editable-item { padding-right: 25px; }

    /* MODAL STYLES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--card-bg); width: 95%; max-width: 1000px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); border-radius: 12px 12px 0 0; flex-shrink: 0; flex-wrap: wrap; gap: 10px; }
    .modal-header h2 { margin: 0; font-size: 20px; }
    .close-modal { background: none; border: none; font-size: 24px; color: var(--text); cursor: pointer; }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--card-bg); padding: 0 20px; overflow-x: auto; flex-shrink: 0; }
    .tab-btn { padding: 12px 20px; background: none; border: none; font-weight: 600; color: var(--text); opacity: 0.6; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; font-size: 14px; }
    .tab-btn.active { opacity: 1; border-bottom-color: var(--primary); color: var(--primary); }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .sleek-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 10px; }
    .sleek-row { margin-bottom: 15px; }
    .sleek-label { font-size: 12px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .sleek-input { font-size: 14px; color: var(--text); background: transparent; border-bottom: none; width: 100%; display: block; padding-bottom: 2px; min-height: 20px; outline: none; word-wrap: break-word; line-height: 1.5; }
    .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .lab-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .lab-table th, .lab-table td { border: 1px solid var(--border); padding: 8px; text-align: center; min-width: 80px; }
    .lab-table th { background: var(--bg); font-weight: 600; }
    .lab-table input { width: 100%; border: none; background: transparent; text-align: center; color: var(--text); font-family: 'Inter', sans-serif; }
    .chart-container { height: 300px; margin-top: 20px; border: 1px solid var(--border); padding: 10px; border-radius: 8px; }
    .img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .img-card { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; border: 1px solid var(--border); background: #000; }
    .img-card img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
    .img-card img:hover { transform: scale(1.05); }
    .img-caption { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 11px; text-align: center; }
    .img-delete { position: absolute; top: 5px; right: 5px; background: #e63946; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .lightbox { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
    .lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 90vh; }
    .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
    .history-list { list-style: none; padding: 0; margin: 15px 0; }
    .history-item { border-left: 2px solid var(--border); padding-left: 15px; margin-bottom: 20px; position: relative; }
    .history-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: var(--primary); }
    .history-date { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .history-text { white-space: pre-wrap; font-size: 14px; }
    .btn-sm { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; background: var(--primary); color: white; font-size: 12px; font-weight: 600; white-space: nowrap; }
    .form-control { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
    
    /* ADMISSION SYSTEM STYLES */
    #admission-system { position: fixed; inset: 0; background: #eaeff5; z-index: 5000; display: none; flex-direction: column; }
    #adm-header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; height: 50px; }
    #adm-body { flex: 1; display: flex; overflow: hidden; position: relative; }
    .adm-sidebar { width: 250px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 15px; transition: transform 0.3s; z-index: 5500; }
    .adm-sidebar-toggle { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary); margin-right: 15px; }
    .mode-card { border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; background: #f8f9fa; }
    .mode-card.active { background: var(--primary); color: white; border-color: var(--primary); }
    .adm-viewport { flex: 1; position: relative; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; }
    #adm-shared-details { width: 100%; max-width: 800px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e0e0e0; }
    #adm-shared-details .form-group { margin-bottom: 8px; }
    #adm-shared-details label { font-size: 10px; margin-bottom: 2px; }
    #adm-shared-details input, #adm-shared-details select { padding: 4px; height: auto; font-size: 13px; }
    #view-form { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; margin-bottom: 50px; overflow: visible; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 3px; text-transform: uppercase; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .form-group textarea { min-height: 60px; resize: vertical; }
    #view-pdf { width: 100%; display: none; flex-direction: column; align-items: center; }
    #pdf-stage { margin-bottom: 80px; position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }
    
    .pdf-page { margin: 0 auto 20px auto; max-width: 850px; width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; background: white; line-height: 0; font-size: 0; }
    .pdf-canvas { display: block; width: 100%; height: auto; }
    .pdf-box { position: absolute; background: rgba(60, 130, 246, 0.05); border: 1px dashed rgba(60, 130, 246, 0.3); font-family: Helvetica, sans-serif; overflow: hidden; color: #000; line-height: 1.3; padding: 2px; }
    .pdf-box:focus { background: rgba(255, 255, 255, 0.9); border: 2px solid var(--primary); outline: none; z-index: 10; }
    
    .warning-text { color: #d32f2f; font-size: 12px; margin-top: 4px; display: none; font-weight: bold; }

    #adm-toolbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 8px 20px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center; z-index: 6000; border: 1px solid #ddd; }
    .tool-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: 600; font-size: 13px; }
    .tool-btn.primary { background: var(--primary); color: white; border: none; }
    
    body.is-mobile .adm-sidebar { position: absolute; top: 0; left: 0; bottom: 0; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
    body.is-mobile .adm-sidebar.show { transform: translateX(0); }
    body.is-mobile .adm-sidebar-toggle { display: block; }

    /* DISCHARGE CENTER STYLES */
    #discharge-system { position: fixed; inset: 0; background: #eaeff5; z-index: 5000; display: none; flex-direction: column; }
    #dc-header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; height: 60px; }
    .dc-selector { font-size: 16px; padding: 5px; min-width: 300px; }

    #dc-body { flex: 1; display: flex; overflow: hidden; position: relative; }
    .dc-split-view { display: flex; width: 100%; height: 100%; }

    /* Left Pane: The Form */
    .dc-form-pane { flex: 6; overflow-y: auto; padding: 20px; background: #fff; border-right: 2px solid #ccc; }
    .dc-paper { background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 850px; margin: 0 auto; }

    /* Right Pane: History */
    .dc-history-pane { flex: 4; overflow-y: auto; padding: 20px; background: #f4f7fb; }
    
    /* REUSED CLASSES FROM MODAL for consistency */
    .dc-history-item { 
        padding-left: 15px; margin-bottom: 20px; border-left: 2px solid var(--border); 
        position: relative; 
    }
    .dc-history-item::before { 
        content: ''; position: absolute; left: -5px; top: 0; 
        width: 8px; height: 8px; border-radius: 50%; background: var(--primary); 
    }
    .dc-history-date { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .dc-history-text { white-space: pre-wrap; font-size: 14px; }

    /* SCOPED STYLES FOR DC TEMPLATE */
    #dc-form-container * { margin: 0; padding: 0; text-indent: 0; }
    #dc-form-container .label-text { font-family: "Times New Roman", serif; font-size: 11pt; font-weight: normal; color: black; }
    #dc-form-container .s5 { font-family: Cambria, serif; font-size: 11pt; color: black; }
    #dc-form-container .s6 { font-family: "Times New Roman", serif; font-weight: bold; font-size: 11pt; color: black; }
    #dc-form-container h1.dc-title { font-family: "Times New Roman", serif; font-weight: bold; text-decoration: underline; font-size: 14pt; text-align: center; margin: 10px 0; color: black; }
    
    #dc-form-container table { width: 100%; border-collapse: collapse; font-family: "Times New Roman", serif; table-layout: fixed; }
    #dc-form-container td { border: 1px solid black !important; padding: 2px; vertical-align: top; }
    #dc-form-container textarea { width: 100%; border: none; font-family: "Times New Roman", serif; font-size: 11pt; resize: both; overflow: hidden; min-height: 25px; background: transparent; padding: 0; display: block; vertical-align: top; }
    
    /* SLEEK BUTTON STYLE for DC Download & Reset */
    .btn-sleek { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #17a2b8; color: white; border: none; cursor: pointer; transition: transform 0.1s; }
    .btn-sleek:hover { transform: scale(1.05); }

    /* Orange Reset Button Variant */
    .btn-sleek.btn-warn { background: #f0ad4e; color: white; }
    .btn-sleek.btn-warn:hover { background: #ec971f; }

    @media (max-width: 900px) {
       .modal-header { display: flex; flex-wrap: wrap; }
       .modal-header h2 { width: 100%; margin-bottom: 10px; }
       .modal-header button.btn-sm { margin-left: 0 !important; }
    }
  </style>
</head>
<body>
  <h1>Pediatric Handover</h1>
  
  <div class="top-buttons">
    <button class="add" onclick="toggleForm()">Add Patient</button>
    <button class="btn-green" onclick="launchAdmissionSystem()">Admission</button>
    <button class="btn-teal" onclick="launchDischargeSystem()">DC</button>
    <div class="dropdown">
      <button class="dropdown-btn">Print ‚ñº</button>
      <div class="dropdown-content">
        <a onclick="printAll()">Print All</a>
        <a onclick="printNICU()">Print NICU</a>
        <a onclick="printWard()">Print Ward</a>
        <a onclick="printNew()">Print New</a>
      </div>
    </div>
    <button class="theme-toggle" onclick="toggleDarkMode()" aria-label="Toggle theme"></button>
  </div>

  <div class="top-panel">
    <div id="handoverHeader" class="panel-card">
      <strong>Date:</strong> <span id="handoverDate">2025-09-15</span>
      <table>
        <tbody>
          <tr><th></th><th>Morning</th><th>Evening</th><th>Night</th></tr>
          <tr><td>Admissions</td><td><input type="number" id="adM" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="adE" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="adN" value="0" min="0" oninput="recalcSummary()"></td></tr>
          <tr><td>Discharges</td><td><input type="number" id="disM" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="disE" value="0" min="0" oninput="recalcSummary()"></td><td><input type="number" id="disN" value="0" min="0" oninput="recalcSummary()"></td></tr>
          <tr><td>Total Admissions</td><td colspan="3" id="totalAd">0</td></tr>
          <tr><td>Total Discharges</td><td colspan="3" id="totalDis">0</td></tr>
          <tr><td>Total Patients</td><td colspan="3" id="totalCount">0</td></tr>
          <tr><td>By ward</td><td colspan="3" id="wardBreakdown">PW (0), GW (0), SW (0), PVT (0), ICU (0), NICU (0), ER (0)</td></tr>
        </tbody>
      </table>
    </div>
    <div id="notesCard" class="panel-card">
      <strong>Notes/Pending work</strong>
      <textarea id="notesText" placeholder="Type pending tasks, callbacks, follow-ups..."></textarea>
    </div>
  </div>

  <div class="form-section" id="formSection">
    <input type="text" id="name" placeholder="Name" required>
    <input type="text" id="id" placeholder="ID" required>
    <input type="text" id="doa" placeholder="Date of Admission (YYYY-MM-DD)" required>
    <input type="text" id="age" placeholder="Age" required>
    <div class="age-toggle" id="form-age-toggle">
      <label><input type="radio" id="form-radio-manual" name="formAgeMode" value="manual" checked onchange="toggleAutoInputsForm()"> Manual</label>
      <label><input type="radio" id="form-radio-auto" name="formAgeMode" value="auto" onchange="toggleAutoInputsForm()"> Auto (HOL/DOL)</label>
      <div class="auto-age-inputs" id="form-auto-age-inputs" style="display: none">
        <input type="date" id="dob" placeholder="Date of Birth (YYYY-MM-DD)">
        <input type="time" id="dot" placeholder="Time of Birth (HH:MM)">
      </div>
    </div>
    <select id="shift" required><option value="Morning">Morning Shift</option><option value="Evening">Evening Shift</option><option value="Night">Night Shift</option></select>
    <input type="text" id="bed" placeholder="Bed" required>
    <select id="sex"><option value="Male">Male</option><option value="Female">Female</option></select>
    <input type="text" id="weight" placeholder="Weight" required>
    <input type="text" id="diagnosis" placeholder="Diagnosis">
    <textarea id="medications" placeholder="Medications"></textarea>
    <input type="text" id="issues" placeholder="Issues">
    <textarea id="hopi" placeholder="HOPI"></textarea>
    <select id="ward"><option value="PW">PW</option><option value="GW">GW</option><option value="SW">SW</option><option value="PVT">PVT</option><option value="ICU">ICU</option><option value="NICU">NICU</option><option value="ER">ER</option></select>
    <textarea id="plan" placeholder="Plan"></textarea>
    <div class="new-checkbox"><label><input type="checkbox" id="isNew" checked> New</label></div>
    <button onclick="addPatient()">Submit</button>
  </div>

  <div id="wardsContainer"></div>

  <div id="detailModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Patient Details</h2>
        <button class="btn-sm" onclick="openAdmissionForPatient()" style="margin-left:auto; margin-right:15px; background:var(--accent);">Reprint/Edit Admission folder</button>
        <button class="close-modal" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-tabs">
        <button class="tab-btn active" onclick="switchTab('details')">Details</button>
        <button class="tab-btn" onclick="switchTab('labs')">Labs</button>
        <button class="tab-btn" onclick="switchTab('imaging')">X-Rays</button>
        <button class="tab-btn" onclick="switchTab('history')">Plan History</button>
      </div>
      <div class="modal-body">
        <div id="tab-details" class="tab-pane active">
          <div class="sleek-grid">
             <div>
                <div class="sleek-row"><span class="sleek-label">Name</span><div contenteditable="true" id="det-name" class="sleek-input" data-field="name" onblur="updateFromDetail('name', this.innerText)"></div></div>
                <div class="sleek-grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                   <div><span class="sleek-label">Hosp. No.</span><div contenteditable="true" id="det-hosp" class="sleek-input" onblur="updateIdFromDetail()"></div></div>
                   <div><span class="sleek-label">NID No.</span><div contenteditable="true" id="det-nid" class="sleek-input" onblur="updateIdFromDetail()"></div></div>
                </div>
             </div>
             <div>
                <div class="compact-grid">
                   <div><span class="sleek-label">Ward</span><div contenteditable="true" id="det-ward" class="sleek-input" data-field="ward" onblur="updateFromDetail('ward', this.innerText)"></div></div>
                   <div><span class="sleek-label">Bed</span><div contenteditable="true" id="det-bed" class="sleek-input" data-field="bed" onblur="updateFromDetail('bed', this.innerText)"></div></div>
                   <div><span class="sleek-label">Age</span><div contenteditable="true" id="det-age" class="sleek-input" data-field="age" onblur="updateFromDetail('age', this.innerText)"></div></div>
                   <div><span class="sleek-label">Sex</span><div contenteditable="true" id="det-sex" class="sleek-input" data-field="sex" onblur="updateFromDetail('sex', this.innerText)"></div></div>
                   <div><span class="sleek-label">Wt</span><div contenteditable="true" id="det-weight" class="sleek-input" data-field="weight" onblur="updateFromDetail('weight', this.innerText)"></div></div>
                </div>
             </div>
          </div>
          <div class="sleek-row"><span class="sleek-label">Diagnosis</span><div contenteditable="true" id="det-diagnosis" class="sleek-input" data-field="diagnosis" onblur="updateFromDetail('diagnosis', this.innerText)"></div></div>
          <div class="sleek-grid" style="grid-template-columns: 1fr 1fr;">
             <div class="sleek-row"><span class="sleek-label">Medications</span><div contenteditable="true" id="det-medications" class="sleek-input" data-field="medications" style="min-height: 60px;" onblur="updateFromDetail('medications', this.innerText)"></div></div>
             <div class="sleek-row"><span class="sleek-label">Issues</span><div contenteditable="true" id="det-issues" class="sleek-input" data-field="issues" style="min-height: 60px;" onblur="updateFromDetail('issues', this.innerText)"></div></div>
          </div>
          <div class="sleek-row"><span class="sleek-label">HOPI</span><div contenteditable="true" id="det-hopi" class="sleek-input" data-field="hopi" style="min-height: 100px; white-space: pre-wrap;" onblur="updateFromDetail('hopi', this.innerText)"></div></div>
        </div>
        <div id="tab-labs" class="tab-pane">
          <div style="overflow-x: auto;"><table class="lab-table" id="labMatrix"></table></div>
          <div class="chart-container"><canvas id="labsChart"></canvas></div>
        </div>
        <div id="tab-imaging" class="tab-pane">
          <div style="background: var(--card-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">Add Image</h3>
            <div style="display: flex; gap: 10px;">
              <input type="file" id="img-file" accept="image/*" class="form-control">
              <input type="text" id="img-cap" class="form-control" placeholder="Caption" style="width: 150px;">
              <button class="btn-sm" id="upload-btn" onclick="addImage()">Upload</button>
            </div>
          </div>
          <div class="img-grid" id="img-grid"></div>
        </div>
        <div id="tab-history" class="tab-pane">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h3 style="margin:0;">Plan Log</h3>
              <span class="edit-history-link" id="modal-edit-link" onclick="toggleEditHistory(null, 'modal')">Edit</span>
           </div>
           <ul class="history-list" id="history-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="lightbox" class="lightbox"><span class="lightbox-close" onclick="closeLightbox()">&times;</span><img class="lightbox-content" id="lightbox-img"></div>
  
  <div id="admission-system">
    <div id="adm-header">
      <div style="display:flex; align-items:center;">
          <button class="adm-sidebar-toggle" onclick="toggleAdmSidebar()">‚ò∞</button>
          <h2 style="margin:0; font-size:18px;">Admission Center</h2>
      </div>
      <button onclick="closeAdmissionSystem()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
    </div>
    <div id="adm-body">
      <div class="adm-sidebar" id="admSidebar">
        <div class="mode-card active" id="btn-mode-form" onclick="setMode('form')">
          <div style="font-weight:bold;">üìù Form Mode</div>
          <div style="font-size:11px; opacity:0.8;">Fill form. Auto-prints & saves.</div>
        </div>
        <div class="mode-card" id="btn-mode-pdf" onclick="setMode('pdf')">
          <div style="font-weight:bold;">üìÑ Visual Mode</div>
          <div style="font-size:11px; opacity:0.8;">Edit directly on PDF.</div>
        </div>
        <div style="margin-top:auto;">
          <small>Templates (PDF)</small>
          <div id="template-list" style="max-height:150px; overflow-y:auto; border-top:1px solid #eee; margin-top:5px;"></div>
          <button onclick="saveTemplate()" style="width:100%; margin-top:5px; padding:5px; font-size:11px;">Save Template</button>
        </div>
      </div>

      <div class="adm-viewport" onclick="if(document.body.classList.contains('is-mobile') && document.getElementById('admSidebar').classList.contains('show')) toggleAdmSidebar()">
        <div id="adm-shared-details">
           <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; margin-bottom:10px; padding-bottom:5px;">
              <h3 style="margin:0; color:var(--primary);">1. Patient Details</h3>
              <button onclick="printRequestOnly()" class="btn-sm" style="background:#6c757d;">Print Admission Request</button>
           </div>
           <div class="form-grid">
              <div class="form-group"><label>Name</label><input type="text" id="f-name" oninput="updateVisualField('name', this.value)"></div>
              
              <div class="form-group"><label>Hosp. No.</label><input type="text" id="f-hosp-no" oninput="updateVisualField('hid', this.value)"></div>
              <div class="form-group"><label>NID No.</label><input type="text" id="f-nid-no"></div>
              
              <div class="form-group"><label>DOA</label><input type="text" id="f-doa" oninput="updateVisualField('doa', this.value)"></div>
              <div class="form-group"><label>Shift</label><select id="f-shift"><option>Morning</option><option>Evening</option><option>Night</option></select></div>
              <div class="form-group"><label>Ward</label><select id="f-ward" onchange="updateVisualField('ward', this.value)"><option>PW</option><option>GW</option><option>SW</option><option>PVT</option><option>ICU</option><option>NICU</option><option>ER</option></select></div>
              <div class="form-group"><label>Bed</label><input type="text" id="f-bed" oninput="updateVisualField('bed', this.value)"></div>
              <div class="form-group"><label>Age</label>
                 <input type="text" id="f-age" placeholder="Enter age or select Auto" oninput="updateVisualField('age', this.value)">
                 <div class="age-toggle" id="adm-age-toggle" style="display:flex; gap:10px; align-items:center; margin-top:5px; border:none; padding:0; background:transparent;">
                    <label style="margin:0; font-weight:normal; text-transform:none;"><input type="radio" id="adm-radio-manual" name="admAgeMode" value="manual" checked onchange="toggleAdmAutoInputs()"> Manual</label>
                    <label style="margin:0; font-weight:normal; text-transform:none;"><input type="radio" id="adm-radio-auto" name="admAgeMode" value="auto" onchange="toggleAdmAutoInputs()"> Auto</label>
                    <div class="auto-age-inputs" id="adm-auto-age-inputs" style="display: none; margin-left:10px;">
                      <input type="date" id="f-dob" placeholder="DOB" style="padding:4px; font-size:12px;">
                      <input type="time" id="f-dot" placeholder="Time" style="padding:4px; font-size:12px;">
                    </div>
                 </div>
              </div>
              <div class="form-group"><label>Sex</label><select id="f-sex" onchange="updateVisualField('sex', this.value)"><option>Male</option><option>Female</option></select></div>
              <div class="form-group"><label>Weight</label><input type="text" id="f-weight"></div>
              
              <div class="form-group"><label>Diagnosis</label><input type="text" id="f-adm-dx" oninput="syncDx(this.value)"></div>
           </div>
        </div>

        <div id="view-form">
          <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">2. History</h3>
          <div class="form-group"><label>Presenting Complaints</label><textarea id="f-complaints" oninput="checkOverflow('f-complaints')"></textarea></div>
          <div class="form-group"><label>History of Present Illness (HOPI)</label><textarea id="f-hopi" style="min-height:150px;" oninput="checkOverflow('f-hopi')"></textarea><div id="warn-f-hopi" class="warning-text">‚ö†Ô∏è Text Limit Exceeded</div></div>
          <div class="form-group"><label>Past History</label><textarea id="f-past" oninput="checkOverflow('f-past')"></textarea></div>
          <div class="form-group"><label>Personal History</label><textarea id="f-personal" oninput="checkOverflow('f-personal')"></textarea></div>
          <div class="form-group"><label>Family History</label><textarea id="f-family" oninput="checkOverflow('f-family')"></textarea></div>
          <div class="form-grid">
            <div class="form-group"><label>Treatment History</label><textarea id="f-treatment" oninput="checkOverflow('f-treatment')"></textarea></div>
            <div class="form-group"><label>Obstetric/Gynae History</label><textarea id="f-obs" oninput="checkOverflow('f-obs')"></textarea></div>
          </div>
          <h3 style="margin-top:15px; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">3. Examination</h3>
          <div class="form-group"><label>General Examination</label><textarea id="f-ge" oninput="checkOverflow('f-ge')"></textarea></div>
          <div class="form-grid">
             <div class="form-group"><label>CVS</label><textarea id="f-cvs" oninput="checkOverflow('f-cvs')"></textarea></div>
             <div class="form-group"><label>RS</label><textarea id="f-rs" oninput="checkOverflow('f-rs')"></textarea></div>
             <div class="form-group"><label>Abdomen</label><textarea id="f-abd" oninput="checkOverflow('f-abd')"></textarea></div>
             <div class="form-group"><label>Pelvis</label><textarea id="f-pelvis" oninput="checkOverflow('f-pelvis')"></textarea></div>
          </div>
          <div class="form-grid">
             <div class="form-group"><label>CNS</label><textarea id="f-cns" oninput="checkOverflow('f-cns')"></textarea></div>
             <div class="form-group"><label>Local Exam</label><textarea id="f-le" oninput="checkOverflow('f-le')"></textarea></div>
          </div>
          <h3 style="margin-top:15px; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:5px;">4. Assessment & Plan</h3>
          <div class="form-group"><label>Diagnosis</label><input type="text" id="f-finaldx" oninput="syncDx(this.value, true)"></div>
          <div class="form-group"><label>Plan</label><textarea id="f-plan" style="min-height:100px;" oninput="checkOverflow('f-plan')"></textarea></div>
        </div>

        <div id="view-pdf">
           <div id="pdf-loading" style="margin-top:50px;">Loading PDF Engine...</div>
           <div id="pdf-stage"></div>
        </div>
      </div>
    </div>

    <div id="adm-toolbar">
       <span id="pdf-controls" style="display:none; gap:10px; align-items:center; border-right:1px solid #ddd; padding-right:10px; margin-right:10px;">
         <label style="font-size:12px;">Size:</label>
         <select onchange="changePdfFont(this.value)">
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13" selected>13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="18">18</option>
          </select>
          <label style="font-size:12px;">Ln:</label>
          <select onchange="changePdfLineHeight(this.value)"><option value="1.0">1.0</option><option value="1.3" selected>1.3</option><option value="1.6">1.6</option></select>
       </span>
       <button class="tool-btn" onclick="printOnly()">Print Only</button>
       <button class="tool-btn primary" onclick="saveAndAdd()">Print & Add</button>
    </div>
  </div>

  <div id="discharge-system">
    <div id="dc-header">
      <div style="display:flex; align-items:center; gap: 15px;">
          <h2 style="margin:0; font-size:18px;">Discharge Center</h2>
          
          <select id="dc-template-type" class="dc-selector" style="min-width: 150px;" onchange="updateDcTemplate()">
              <option value="pediatric">Template: Pediatric</option>
              <option value="neonate">Template: Neonate</option>
              <option value="neonate_hx">Template: Neonate with Hx</option>
          </select>

          <select id="dc-patient-select" class="dc-selector" onchange="selectDcPatient(this.value)">
              <option value="">-- Select Patient to Discharge --</option>
          </select>

          <button class="btn-sleek" onclick="generateDcDocx()">Download .docx</button>
          <button class="btn-sleek btn-warn" style="margin-left:5px;" onclick="resetDcForm()">Reset</button>
      </div>
      <div style="display:flex; gap:10px;">
          <button onclick="closeDischargeSystem()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
      </div>
    </div>
    
    <div id="dc-body">
      <div class="dc-split-view">
          <div class="dc-form-pane">
              <div id="dc-form-container" class="dc-paper">
                  <h1 class="dc-title">DISCHARGE SUMMARY</h1>
                  
                  <table>
                      <tbody id="dc-table-body">
                          <tr>
                              <td style="width:19%;"><span class="label-text">NAME:</span></td>
                              <td style="width:23%;"><textarea id="dc-name" rows="1"></textarea></td>
                              <td style="width:10%;"><span class="label-text">AGE:</span></td>
                              <td style="width:10%;"><textarea id="dc-age" rows="1"></textarea></td>
                              <td style="width:13%;"><span class="label-text">GENDER:</span></td>
                              <td style="width:10%;"><textarea id="dc-sex" rows="1"></textarea></td>
                              <td style="width:10%;"><span class="label-text" id="lbl-weight">WEIGHT:</span></td>
                              <td style="width:10%;"><textarea id="dc-weight" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td><span class="label-text">ADDRESS:</span></td>
                              <td colspan="3"><textarea id="dc-address" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">HOSPITAL No:</span></td>
                              <td colspan="2"><textarea id="dc-mrn" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td><span class="label-text">WARD:</span></td>
                              <td><textarea id="dc-ward" rows="1"></textarea></td>
                              <td><span class="label-text">BED:</span></td>
                              <td><textarea id="dc-bed" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">FOLDER No:</span></td>
                              <td colspan="2"><textarea id="dc-folder" rows="1"></textarea></td>
                          </tr>
                          <tr>
                              <td colspan="2"><span class="label-text">DATE OF ADMISSION:</span></td>
                              <td colspan="2"><textarea id="dc-doa" rows="1"></textarea></td>
                              <td colspan="2"><span class="label-text">DATE OF DISCHARGE:</span></td>
                              <td colspan="2"><textarea id="dc-dod" rows="1"></textarea></td>
                          </tr>
                          <tr><td colspan="8" style="border:none!important; height:10px;"></td></tr>
                          
                          <tr id="row-diagnosis">
                              <td colspan="1" style="width:19%;"><span class="label-text">DIAGNOSIS:</span></td>
                              <td colspan="7"><textarea id="dc-diagnosis"></textarea></td>
                          </tr>

                          <tr id="row-history">
                              <td colspan="1"><span class="label-text" id="lbl-history">HISTORY:</span></td>
                              <td colspan="7"><textarea id="dc-history" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-exam">
                              <td colspan="1"><span class="label-text" id="lbl-exam">EXAMINATION:</span></td>
                              <td colspan="7"><textarea id="dc-exam" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-birth-hx-split" style="display:none;">
                              <td colspan="1"><span class="label-text" id="lbl-split-row">BIRTH HISTORY:</span></td>
                              <td colspan="4"><textarea id="dc-birth-hx-col1" style="min-height:80px;"></textarea></td>
                              <td colspan="3"><textarea id="dc-birth-hx-col2" style="min-height:80px;"></textarea></td>
                          </tr>

                          <tr id="row-maternal-hx" style="display:none;">
                              <td colspan="1"><span class="label-text">MATERNAL HISTORY:</span></td>
                              <td colspan="7"><textarea id="dc-maternal-hx" style="min-height:60px;"></textarea></td>
                          </tr>

                          <tr>
                              <td colspan="1"><span class="label-text">INVESTIGATIONS:</span></td>
                              <td colspan="7"><textarea id="dc-ix">ALL ENCLOSED</textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">TREATMENT AND HOSPITAL COURSE:</span></td>
                              <td colspan="7"><textarea id="dc-course" style="min-height:120px;"></textarea></td>
                          </tr>
                          
                          <tr><td colspan="8" style="border:none!important; height:10px;"></td></tr>
                          
                          <tr>
                              <td colspan="1"><span class="label-text">ON DISCHARGE CONDITION:</span></td>
                              <td colspan="7"><textarea id="dc-cond">Alert, oriented.&#10;Vitals: Stable.</textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">TREATMENT ON DISCHARGE:</span></td>
                              <td colspan="7"><textarea id="dc-rx"></textarea></td>
                          </tr>
                          <tr>
                              <td colspan="1"><span class="label-text">REVIEW:</span></td>
                              <td colspan="7"><textarea id="dc-review">Follow up in P-OPD after   days</textarea></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>

          <div class="dc-history-pane">
              <h3>Plan History (Earliest First)</h3>
              <div id="dc-history-list"></div>
          </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC3_DD-ezlWahQeCdPLcFh_lohLn63Q7eY",
      authDomain: "pediatric-handover.firebaseapp.com",
      projectId: "pediatric-handover",
      storageBucket: "pediatric-handover.firebasestorage.app",
      messagingSenderId: "104007714087",
      appId: "1:104007714087:web:77811513530b0ee9859502"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --- CONFIGURATION ---
    const PDF_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/Admission.pdf';
    const REQUEST_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/AdmissionRequest.pdf';
    const ANCHORS_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/anchors.json';

    // *** TEMPLATE URLs ***
    const DOCX_URL_PED = "https://raw.githubusercontent.com/nuhadwrk/admission/main/discharge_template.docx"; 
    const DOCX_URL_NEO = "https://raw.githubusercontent.com/nuhadwrk/admission/main/neonate.docx"; 
    const DOCX_URL_NEO_HX = "https://raw.githubusercontent.com/nuhadwrk/admission/main/neonatehx.docx";

    // *** UPDATED: DEFAULTS FOR TEMPLATES ***
    // (Ensure strict left alignment)
    const DEFAULTS = {
        neo_birth_hx_col1: `Date & Time of Birth: \nType of Delivery: \nMaturity: \nAPGAR Score: /10, /10 \nLiquor Quality: Clear, Adequate\nDistress: None\nCried immediately after delivery: Yes`,
        neo_birth_hx_col2: `Birth weight:  KG\nHC:  cm\nLength:  cm\nSpO2:  % on RA\nHR:  b/min`,
        
        neohx_birth_hx_col1: `Date & Time of Birth:\nType of Delivery:\nMaturity:\nAPGAR Score:\nLiquor Quality:\nCongenital anomalies`,
        neohx_birth_hx_col2: `Birth weight: KG\nHC: cm\nCCHD: Passed initial screening`,

        neo_findings: `Cried after delivery, Vigorous, Pink\nCongenital anomalies: none grossly.\nHip Abduction test: normal\nUA: 3 vessels\nCVS: S1+S2+M0\nRS: B/L EAE, No added sounds\nCRT: <3s\nAbdomen: no organomegaly\nB/L descended testes\nNeonatal reflexes: normal\nUrine and meconium: Passed\nCCHD: Passed, RH:   RF:   `,
        
        neohx_exam: `GC: CRT <2s, tongue moist, AF-level, jaundice up to umbilicus\nActivity, color, tone and reflexes were normal.\nVitals 70/38mmHg, HR 130bpm, RR 55/mt, SPO2 98% in RA, T 37.3*c, GRBS 89mg/dl,\nWeight on admission kg`,

        neo_maternal: `Age:   years, GPL at   WOG\nBlood group: O +ve; G6PD: Normal, VDRL/ HIV/HBsAg: Non-reactive`,
        
        neo_cond: `- Sucking well.\n- Breast feeding on demand.\n- Urine and meconium passing\n- All vitals stable.\n- Weight on discharge:   kg`,
        
        neo_course: `1. Breast feeding on demand\n2. Inj. vitamin K 1mg given at birth (left thigh) on \n3. Vaccines given: BCG, Hep. B on `,
        
        neo_rx: `- Early morning and light exposure.\n- Exclusive breastfeeding for 6 months.\n- Cord care.\n- Immunization according to schedule.\n- Advised to keep home smoke-free.\n- Check for increase in yellowish discoloration of skin, poor feeding, lethargy etc.\n- Jusdee oral drops 1 ml PO OD x 1 year.\n\nVaccinations:\nInj. Synflorix 0.5ml IM at 2,4 and 6 months\nDrop. Rotarix 1.5ml PO at 2 and 4 months`,
        
        neohx_rx: `- Early morning and light exposure.\n- Exclusive breastfeeding for 6 months.\n- Cord care.\n- Immunization according to schedule.\n- Advised to keep home smoke-free including balconies, doorway and stairs and do not allow anyone to smoke near baby.\n- Check for increase in yellowish discoloration of skin, poor feeding, lethargy etc.`,

        neo_review: `Follow up in P-OPD after 3days with Hb/PCV, TSB, DSB, FT4, TSH\nNeonatal Metabolic screening`,

        ped_cond: `Alert, oriented.\nVitals: Stable.`,
        ped_rx: ``
    };

    // --- UTILS ---
    function getOrdinalSuffix(n) { const l=n%10, t=n%100; if(t>=11&&t<=13)return'th'; return l===1?'st':l===2?'nd':l===3?'rd':'th'; }
    function calculateDaysAdmitted(doa) { try{ const d=new Date(doa), t=new Date(); t.setHours(0,0,0,0); d.setHours(0,0,0,0); const diff=Math.floor((t-d)/86400000)+1; return diff<=0?'1st DOA':`${diff}${getOrdinalSuffix(diff)} DOA`; }catch(e){return'1st DOA';} }
    
    // AGE LOGIC FOR PATIENT CARD
    function calculateNeonatalAge(dob, dot) { try{ if(!dob||!dot)return{display:'?'}; const b=new Date(`${dob}T${dot}:00`); if(isNaN(b.getTime()))return{display:'?'}; const n=new Date(), h=Math.floor((n-b)/3600000), d=Math.floor(h/24)+1; return {days:d,hours:h,display:h<=96?`${d}${getOrdinalSuffix(d)} DOL (${h} HOL)`:`${d}${getOrdinalSuffix(d)} DOL`}; }catch(e){return{days:1,hours:24,display:'?'};} }
    
    // NEW: AGE LOGIC FOR DISCHARGE SUMMARY (Completed Days)
    function calculateCompletedDOL(dob, dot) {
        if(!dob || !dot) return "";
        try {
            const birthDate = new Date(`${dob}T${dot}:00`);
            const now = new Date();
            if(isNaN(birthDate.getTime())) return "";
            const diffMs = now - birthDate;
            // Floor of total days = completed days
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            return `${days} DOL`;
        } catch(e) { return ""; }
    }

    function formatTimestamp(ts) { const d=new Date(ts); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function getLocalISODate() { return new Date().toLocaleDateString('en-CA'); }
    function getCurrentShift() { const h = new Date().getHours(); if (h>=8 && h<16) return "Morning"; if (h>=16) return "Evening"; return "Night"; }

    // --- LOGGING UTILS ---
    function parseLogDate(dateStr) {
        if(!dateStr) return new Date(0);
        try {
            const [d, t] = dateStr.split(' ');
            const [day, month, year] = d.split('/');
            const [hr, min] = t.split(':');
            return new Date(`20${year}-${month}-${day}T${hr}:${min}:00`);
        } catch(e) { return new Date(0); }
    }

    function formatLogsToHtml(logsStr, patientId, limitToLast3 = false, allowEdit = false) {
        if (!logsStr) return allowEdit ? '' : '<div style="font-size:12px; color:#888; font-style:italic; padding-left:5px;">No logs</div>';
        
        let entries = logsStr.split('‚Ä¢').filter(e => e.trim().length > 0).reverse();
        
        if (limitToLast3) {
            entries = entries.slice(0, 3);
            allowEdit = false;
        }

        let html = '';
        entries.forEach(e => {
            const lines = e.trim().split('\n');
            const datePart = lines[0].trim();
            const body = lines.slice(1).join('\n').trim();
            
            if(body) {
                if (allowEdit) {
                    html += `
                    <li class="history-item editable-item">
                        <div class="history-date">${datePart}</div>
                        <div class="history-text" contenteditable="false" onblur="saveLogsFromDom('${patientId}', this)">${body}</div>
                        <span class="log-delete-btn" onclick="deleteLogItem(this, '${patientId}')" title="Delete Log">√ó</span>
                    </li>`;
                } else {
                    html += `
                    <li class="history-item">
                        <div class="history-date">${datePart}</div>
                        <div class="history-text">${body}</div>
                    </li>`;
                }
            }
        });
        
        if (limitToLast3 && html === '') return '<div style="font-size:12px; color:#888; font-style:italic; padding-left:5px;">No recent logs</div>';
        
        const listId = limitToLast3 ? `recent-list-${patientId}` : `full-list-${patientId}`;
        return `<ul class="history-list" id="${listId}">${html}</ul>`;
    }

    function toggleEditHistory(id, context) {
        const patientId = context === 'modal' ? currentPatientId : id;
        const listId = context === 'modal' ? 'history-list' : `full-list-${patientId}`;
        const listEl = document.getElementById(listId);
        
        if(!listEl) return;

        listEl.classList.toggle('editing-mode');
        const isEditing = listEl.classList.contains('editing-mode');

        const textItems = listEl.querySelectorAll('.history-text');
        textItems.forEach(el => el.contenteditable = isEditing); 
        textItems.forEach(el => el.setAttribute('contenteditable', isEditing)); 

        const linkId = context === 'modal' ? 'modal-edit-link' : `card-edit-link-${patientId}`;
        const linkEl = document.getElementById(linkId);
        if(linkEl) {
            linkEl.innerText = isEditing ? 'Done' : 'Edit';
            linkEl.style.color = isEditing ? '#28a745' : 'var(--primary)';
        }
    }

    function saveLogsFromDom(patientId, element) {
        const listContainer = element.closest('ul');
        if (!listContainer) return;

        const items = listContainer.querySelectorAll('li.history-item');
        let logEntries = [];
        items.forEach(li => {
            const dateText = li.querySelector('.history-date').innerText.trim();
            const bodyText = li.querySelector('.history-text').innerText.trim();
            if (dateText && bodyText) {
                logEntries.push(`‚Ä¢ ${dateText}\n ${bodyText}\n\n`);
            }
        });
        const reconstructedLogs = logEntries.reverse().join('');
        db.collection('patients').doc(patientId).update({
            logs: reconstructedLogs
        }).catch(e => console.error("Error saving logs", e));
    }

    function deleteLogItem(btn, patientId) {
        if(!confirm("Delete this log entry?")) return;
        const li = btn.closest('li');
        const ul = li.closest('ul');
        li.remove();
        
        const items = ul.querySelectorAll('li.history-item');
        let logEntries = [];
        items.forEach(li => {
            const dateText = li.querySelector('.history-date').innerText.trim();
            const bodyText = li.querySelector('.history-text').innerText.trim();
            if (dateText && bodyText) {
                logEntries.push(`‚Ä¢ ${dateText}\n ${bodyText}\n\n`);
            }
        });
        const reconstructedLogs = logEntries.reverse().join('');
        db.collection('patients').doc(patientId).update({ logs: reconstructedLogs });
    }

    function checkLogInput(id) {
        const el = document.getElementById(`new-plan-${id}`);
        const btn = document.getElementById(`btn-log-${id}`);
        const txt = el.innerText.trim();
        if(txt.length > 0) { btn.disabled = false; } 
        else { btn.disabled = true; }
    }

    // --- DISCHARGE CENTER LOGIC ---
    let currentDcPatientId = null;

    function launchDischargeSystem() {
        document.getElementById('discharge-system').style.display = 'flex';
        loadDcPatients();
        // Default to Pediatric
        document.getElementById('dc-template-type').value = 'pediatric';
        updateDcTemplate(); 
        document.querySelectorAll('#dc-form-container textarea').forEach(el => el.value = '');
        document.getElementById('dc-history-list').innerHTML = '<div style="text-align:center;color:#888;margin-top:20px;">Select a patient to view history</div>';
    }

    function closeDischargeSystem() {
        document.getElementById('discharge-system').style.display = 'none';
        currentDcPatientId = null;
    }

    function loadDcPatients() {
        const select = document.getElementById('dc-patient-select');
        select.innerHTML = '<option value="">-- Select Patient --</option>';
        
        const wards = ["NICU", "ICU", "PW", "GW", "SW", "PVT", "ER"];
        const grouped = {};
        
        Object.values(localPatients).forEach(p => {
            if(p.ward === 'Discharge') return;
            if(!grouped[p.ward]) grouped[p.ward] = [];
            grouped[p.ward].push(p);
        });

        wards.forEach(w => {
            if(grouped[w] && grouped[w].length > 0) {
                const group = document.createElement('optgroup');
                group.label = w;
                grouped[w].sort((a,b) => (parseInt(a.bed)||0) - (parseInt(b.bed)||0));
                grouped[w].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.docId;
                    opt.innerText = `Bed ${p.bed}: ${p.name}`;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            }
        });
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function formatDateDDMMYYYY(iso) {
        if(!iso) return '';
        try {
            const d = new Date(iso);
            if(isNaN(d.getTime())) return iso;
            return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
        } catch(e) { return iso; }
    }

    // NEW: Handle Template Switching
    function updateDcTemplate() {
        const type = document.getElementById('dc-template-type').value;
        
        // Rows
        const rowHistory = document.getElementById('row-history');
        const rowBirthHxSplit = document.getElementById('row-birth-hx-split');
        const rowExam = document.getElementById('row-exam');
        const rowMaternalHx = document.getElementById('row-maternal-hx');
        const tBody = document.getElementById('dc-table-body');
        
        // Labels
        const lblWeight = document.getElementById('lbl-weight');
        const lblExam = document.getElementById('lbl-exam');
        const lblHistory = document.getElementById('lbl-history');
        const lblSplit = document.getElementById('lbl-split-row');

        // Reset visibility
        rowHistory.style.display = 'none';
        rowBirthHxSplit.style.display = 'none';
        rowMaternalHx.style.display = 'none';

        if (type === 'pediatric') {
            lblWeight.innerText = "WEIGHT:";
            lblExam.innerText = "EXAMINATION:";
            lblHistory.innerText = "HISTORY:";
            
            // Standard order: History -> Exam
            if(tBody.contains(rowHistory)) tBody.insertBefore(rowHistory, rowExam);
            rowHistory.style.display = 'table-row';
            rowExam.style.display = 'table-row';
        } 
        else if (type === 'neonate') {
            // Template 2: Diagnosis -> Birth History (History Box) -> Findings (Split Box) -> Maternal
            lblWeight.innerText = "BIRTH WEIGHT:";
            lblHistory.innerText = "BIRTH HISTORY:"; 
            lblSplit.innerText = "FINDINGS AT BIRTH:"; 
            
            // Re-purpose History row for "Birth History" title
            if(tBody.contains(rowHistory)) tBody.insertBefore(rowHistory, rowExam);
            rowHistory.style.display = 'table-row';

            // Show Split Row as "Findings"
            if (rowHistory.nextSibling) {
                tBody.insertBefore(rowBirthHxSplit, rowHistory.nextSibling);
            } else {
                tBody.appendChild(rowBirthHxSplit);
            }
            rowBirthHxSplit.style.display = 'table-row';
            
            // Hide standard Exam Row (replaced by Findings Split)
            rowExam.style.display = 'none';
            
            rowMaternalHx.style.display = 'table-row';
        } 
        else if (type === 'neonate_hx') {
            // Template 3: Diagnosis -> History -> Exam -> Birth Hx (Split)
            lblWeight.innerText = "WEIGHT:";
            lblExam.innerText = "EXAMINATION:";
            lblHistory.innerText = "HISTORY:";
            lblSplit.innerText = "BIRTH HISTORY:";
            
            rowHistory.style.display = 'table-row';
            rowExam.style.display = 'table-row';

            // Show Split Row as "Birth Hx" AFTER Exam
            if (rowExam.nextSibling) {
                tBody.insertBefore(rowBirthHxSplit, rowExam.nextSibling);
            } else {
                tBody.appendChild(rowBirthHxSplit);
            }
            rowBirthHxSplit.style.display = 'table-row';
            
            rowMaternalHx.style.display = 'table-row';
        }
        
        if(currentDcPatientId) selectDcPatient(currentDcPatientId);
    }

    function selectDcPatient(id, forceReset = false) {
        if(!id) return;
        currentDcPatientId = id;
        const p = localPatients[id];
        const data = forceReset ? {} : (p.dischargeData || {});
        const type = document.getElementById('dc-template-type').value;
        
        let mrnOnly = p.id || ''; 
        let nidOnly = '';
        if(p.id && p.id.includes(',')) {
            const parts = p.id.split(',');
            mrnOnly = parts[0].trim();
            nidOnly = parts.length > 1 ? parts[1].trim() : '';
        }
        const nameWithNid = nidOnly ? `${p.name} (${nidOnly})` : p.name;
        
        // --- Calculate Completed DOL ---
        let ageDisplay = p.age;
        if ((type === 'neonate' || type === 'neonate_hx') && p.isAutoAge && p.dob && p.dot) {
            ageDisplay = calculateCompletedDOL(p.dob, p.dot);
        }

        // --- ADMISSION DATA MAPPING ---
        let admHist = "";
        if(p.admissionData) {
            const hopiRaw = (p.admissionData.hopi || '').trim();
            const past = (p.admissionData.pasthx || '').trim();
            const personal = (p.admissionData.personalhx || '').trim();
            const family = (p.admissionData.fhx || '').trim();
            admHist = `${hopiRaw}\n\nPast Hx: ${past}\n\nPersonal Hx: ${personal}\n\nFamily Hx: ${family}`;
        } else {
            admHist = (p.hopi || '').trim();
        }

        const admGeneralExamOnly = p.admissionData?.ge || p.general_exam || "";
        
        const examParts = [
            { l: 'G/E', v: p.general_exam },
            { l: 'CVS', v: p.cvs },
            { l: 'RS', v: p.rs },
            { l: 'Abd', v: p.abdomen },
            { l: 'CNS', v: p.cns }
        ];
        const admExamFull = examParts
            .filter(part => (part.v || '').trim() !== '')
            .map(part => `${part.l}: ${part.v.trim()}`)
            .join('\n');
        
        const admissionCourse = `In ER:\n${(p.treatment_history||'').trim()}\n\nAfter Admission:`;

        const map = {
            'dc-name': data.name || nameWithNid,
            'dc-age': data.age || ageDisplay,
            'dc-sex': data.sex || p.sex,
            'dc-weight': data.weight || p.weight,
            'dc-mrn': data.mrn || mrnOnly,
            'dc-ward': data.ward || p.ward,
            'dc-bed': data.bed || p.bed,
            'dc-folder': data.folder || '',
            'dc-doa': data.doa || formatDateDDMMYYYY(p.doa),
            'dc-dod': data.dod || formatDateDDMMYYYY(getLocalISODate()),
            'dc-diagnosis': data.diagnosis || p.diagnosis,
            'dc-address': data.address || '',
            'dc-ix': data.ix || "ALL ENCLOSED",
            'dc-review': data.review || "Follow up in P-OPD after 3 days"
        };

        // --- CONDITIONAL MAPPING ---
        if (type === 'neonate') {
             // Template 2
             map['dc-history'] = data.history || DEFAULTS.neo_birth_hx_col1; // Re-purposed for Birth Hx
             map['dc-birth-hx-col1'] = data.birth_hx_1 || DEFAULTS.neo_findings; // Split Left -> Findings
             map['dc-birth-hx-col2'] = data.birth_hx_2 || DEFAULTS.neo_birth_hx_col2; // Split Right -> Measurements
             map['dc-course'] = data.course || DEFAULTS.neo_course;
             map['dc-review'] = data.review || DEFAULTS.neo_review;
        } 
        else if (type === 'neonate_hx') {
             // Template 3
             map['dc-history'] = data.history || admHist; // HOPI
             
             // Exam: From Admission G/E if avail, else Default
             const hasAdmGE = (admGeneralExamOnly && admGeneralExamOnly.trim().length > 0);
             map['dc-exam'] = data.exam || (hasAdmGE ? admExamFull : DEFAULTS.neohx_exam);
             
             map['dc-birth-hx-col1'] = data.birth_hx_1 || DEFAULTS.neohx_birth_hx_col1;
             map['dc-birth-hx-col2'] = data.birth_hx_2 || DEFAULTS.neohx_birth_hx_col2;
             map['dc-course'] = data.course || ''; // Blank
        } 
        else {
             // Standard Pediatric
             map['dc-history'] = data.history || admHist;
             map['dc-exam'] = data.exam || admExamFull;
             map['dc-course'] = data.course || admissionCourse;
        }

        map['dc-maternal-hx'] = data.maternal_hx || DEFAULTS.neo_maternal;

        if (type === 'neonate') {
            map['dc-cond'] = data.cond || DEFAULTS.neo_cond;
            map['dc-rx'] = data.rx || DEFAULTS.neo_rx;
        } else if (type === 'neonate_hx') {
            map['dc-cond'] = data.cond || DEFAULTS.neo_cond;
            map['dc-rx'] = data.rx || DEFAULTS.neohx_rx;
        } else {
            map['dc-cond'] = data.cond || DEFAULTS.ped_cond;
            map['dc-rx'] = data.rx || DEFAULTS.ped_rx;
        }

        for (const [elId, val] of Object.entries(map)) {
            const el = document.getElementById(elId);
            if(el) {
                el.value = val;
                if(el.tagName === 'TEXTAREA') autoResize(el);
            }
        }

        renderDcHistory(p.logs);
    }

    function renderDcHistory(logsStr) {
        const container = document.getElementById('dc-history-list');
        if(!logsStr) { container.innerHTML = "No history."; return; }

        let entries = logsStr.split('‚Ä¢').filter(e => e.trim().length > 0);
        let html = "";
        entries.forEach(e => {
            const lines = e.trim().split('\n');
            const datePart = lines[0].trim();
            const body = lines.slice(1).join('\n').trim();
            if(body) {
                html += `
                <div class="dc-history-item">
                    <div class="dc-history-date">${datePart}</div>
                    <div class="dc-history-text">${body}</div>
                </div>`;
            }
        });
        container.innerHTML = html;
    }
    
    function resetDcForm() {
        if(!currentDcPatientId) return;
        if(!confirm("WARNING: This will wipe all manual edits in the Discharge Summary and revert to the latest patient card data. Continue?")) return;
        selectDcPatient(currentDcPatientId, true);
        document.querySelector('#dc-form-container').dispatchEvent(new Event('input'));
    }

    document.querySelector('#dc-form-container').addEventListener('input', function(e) {
        if(e.target.tagName === 'TEXTAREA') autoResize(e.target);
        if(!currentDcPatientId) return;
        
        const data = {};
        document.querySelectorAll('#dc-form-container textarea').forEach(el => {
            const key = el.id.replace('dc-', '').replace(/-/g, '_'); 
            data[key] = el.value;
        });

        db.collection('patients').doc(currentDcPatientId).update({ dischargeData: data });
    });

    async function generateDcDocx() {
        if(!currentDcPatientId) { alert("Select a patient."); return; }
        
        const type = document.getElementById('dc-template-type').value;
        let url = DOCX_URL_PED;
        if(type === 'neonate') url = DOCX_URL_NEO;
        if(type === 'neonate_hx') url = DOCX_URL_NEO_HX;

        try {
            const response = await fetch(url);
            if(!response.ok) throw new Error("Template fetch failed");
            const content = await response.arrayBuffer();
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
            
            let rawName = document.getElementById('dc-name').value;
            let nid = "";
            const match = rawName.match(/^(.*)\s*\((.*)\)$/);
            if (match) {
               rawName = match[1].trim(); 
               nid = match[2].trim();
            }

            const data = {
                name: rawName,
                nid: nid, 
                age: document.getElementById('dc-age').value,
                sex: document.getElementById('dc-sex').value,
                weight: document.getElementById('dc-weight').value,
                mrn: document.getElementById('dc-mrn').value,
                address: document.getElementById('dc-address').value,
                ward: document.getElementById('dc-ward').value,
                bed: document.getElementById('dc-bed').value,
                folder: document.getElementById('dc-folder').value,
                doa: document.getElementById('dc-doa').value,
                dod: document.getElementById('dc-dod').value,
                diagnosis: document.getElementById('dc-diagnosis').value,
                
                // MAPPINGS
                history: document.getElementById('dc-history').value, 
                exam: document.getElementById('dc-exam').value,
                maternal_hx: document.getElementById('dc-maternal-hx').value,
                birth_hx_1: document.getElementById('dc-birth-hx-col1').value,
                birth_hx_2: document.getElementById('dc-birth-hx-col2').value,
                
                investigations: document.getElementById('dc-ix').value,
                course: document.getElementById('dc-course').value,
                condition: document.getElementById('dc-cond').value,
                rx: document.getElementById('dc-rx').value,
                review: document.getElementById('dc-review').value,
                
                adm_cons: "",
                dis_cons: "DR. ALAA ADEL AHMED SAYED AHMED SOBEIH ELAMAWEY",
                prep_by: ""
            };

            doc.render(data);
            const out = doc.getZip().generate({ type:"blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            
            // Updated Filename: [Hospital No] [Name].docx
            saveAs(out, `${data.mrn} ${rawName.split('(')[0].trim()}.docx`);
        } catch(e) {
            console.error(e); alert("Error: " + e.message);
        }
    }

    // --- JS MOBILE DETECTION & INITIALIZATION ---
    function checkMobile() {
       const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
       if(isMobile) {
           document.body.classList.add('is-mobile');
           document.getElementById('admSidebar').classList.remove('show');
       }
    }
    window.onload = function() {
        checkMobile();
        loadPatients();
        document.getElementById("handoverDate").innerText = getLocalISODate();
        fetch(ANCHORS_URL).then(r=>r.json()).then(d=> anchors = d.anchorsByPage || d);
    }

    // --- MAIN LOGIC ---
    let currentPatientId=null, localPatients={}, chartInstance=null;
    document.getElementById("doa").value = getLocalISODate();

    // --- HANDOVER SUMMARY ---
    function recalcSummary() {
      const d={
        adM:+document.getElementById('adM').value||0, adE:+document.getElementById('adE').value||0, adN:+document.getElementById('adN').value||0,
        disM:+document.getElementById('disM').value||0, disE:+document.getElementById('disE').value||0, disN:+document.getElementById('disN').value||0
      };
      document.getElementById('totalAd').innerText=d.adM+d.adE+d.adN; document.getElementById('totalDis').innerText=d.disM+d.disE+d.disN;
      db.collection('summaries').doc('current').set(d);
    }
    db.collection('summaries').doc('current').get().then(doc=>{ if(doc.exists){ const d=doc.data(); ['adM','adE','adN','disM','disE','disN'].forEach(k=>document.getElementById(k).value=d[k]||0); recalcSummary(); } });

    // --- PATIENT LOADING ---
    function loadPatients() {
      const container=document.getElementById('wardsContainer'), wards=["PW","GW","SW","PVT","ICU","NICU","ER","Discharge"], wardGrids={};
      container.innerHTML='';
      wards.forEach(w=>{
         const sec=document.createElement('div'), h=document.createElement('h2'), g=document.createElement('div');
         h.className='ward-header'; if(w==='Discharge'){ h.classList.add('discharge-header'); h.onclick=()=>toggleDischarge(w); }
         h.style.background=`var(--${w})`; h.id=`header-${w}`; h.innerText=`${w} (0)`;
         g.className='card-grid'; g.id=`ward-${w}`; if(w!=='Discharge') g.classList.add('expanded');
         sec.appendChild(h); sec.appendChild(g); container.appendChild(sec); wardGrids[w]=g;
      });

      db.collection('patients').onSnapshot(snap=>{
        const wardCounts={}, patientsByWard={}; wards.forEach(w=>{ wardCounts[w]=0; patientsByWard[w]=[]; });
        let totalActive=0; localPatients={}; const currentIds=new Set();
        
        snap.forEach(doc=>{
           const p=doc.data(); p.docId=doc.id; currentIds.add(p.docId); localPatients[doc.id]=p;
           if(wards.includes(p.ward)){ patientsByWard[p.ward].push(p); wardCounts[p.ward]++; if(p.ward!=='Discharge') totalActive++; }
        });
        document.getElementById('totalCount').innerText=totalActive;
        const bdText=["PW","GW","SW","PVT","ICU","NICU","ER"].map(w=>`${w} (${wardCounts[w]||0})`).join(', ');
        if(document.getElementById('wardBreakdown')) document.getElementById('wardBreakdown').innerText=bdText;
        document.querySelectorAll('.patient-card').forEach(c=>{ if(!currentIds.has(c.getAttribute('data-id'))) c.remove(); });
        wards.forEach(w=>{
           if(w==='Discharge') patientsByWard[w].sort((a,b)=>(b.dischargeTimestamp||b.timestamp||0)-(a.dischargeTimestamp||a.timestamp||0));
           else patientsByWard[w].sort((a,b)=>(parseInt(a.bed)||0)-(parseInt(b.bed)||0));
           patientsByWard[w].forEach(p=>{
              let c=document.getElementById(`card-${p.docId}`);
              if(!c) c=createCard(p); else updateCardDOM(c,p);
              wardGrids[w].appendChild(c);
           });
           document.getElementById(`header-${w}`).innerText=`${w} (${wardCounts[w]})`;
        });
        if(currentPatientId&&localPatients[currentPatientId]) refreshModalIfOpen();
      });
    }

    // --- CARD RENDERING ---
    function createCard(p) {
        const id=p.docId, c=document.createElement('div'); c.className='patient-card'; c.id=`card-${id}`; c.setAttribute('data-id',id);
        const days=calculateDaysAdmitted(p.doa), age=p.isAutoAge&&p.dob&&p.dot?calculateNeonatalAge(p.dob,p.dot).display:p.age;
        const disTag=p.ward==='Discharge'?`<span class="discharge-badge discharge-active card-ctrl">Discharged ${formatTimestamp(p.dischargeTimestamp||p.timestamp||Date.now())}</span>`:'';
        
        const fullHistoryHtml = formatLogsToHtml(p.logs || '', id, false, true);
        const recentHistoryHtml = formatLogsToHtml(p.logs || '', id, true, false);

        c.innerHTML = `
             <button class="expand-btn card-ctrl" onclick="openModal('${id}')">‚õ∂</button>
             <button class="delete-btn card-ctrl" onclick="deletePatient('${id}')">√ó</button>
             <span class="new-badge${p.isNew?' new-active':''} card-ctrl">NEW</span>${disTag}
             
             <p><strong>Name:</strong> <span data-field="name" contenteditable class="editable" onblur="updateField('${id}','name',this.innerText)">${p.name}</span></p>
             <p><strong>ID:</strong> <span data-field="id" contenteditable class="editable" onblur="updateField('${id}','id',this.innerText)">${p.id||''}</span></p>
             <p><strong>DOA:</strong> <span data-field="doa" contenteditable class="editable" onblur="updateField('${id}','doa',this.innerText)">${p.doa||''}</span> <span>(${days})</span></p>
             <p><strong>Shift:</strong> <span data-field="shift" contenteditable class="editable" onblur="updateField('${id}','shift',this.innerText)">${p.shift||''}</span></p>
             <p><strong>Bed:</strong> <span data-field="bed" contenteditable class="editable" onblur="updateField('${id}','bed',this.innerText)">${p.bed||''}</span></p>
             <p><strong onclick="toggleAgeMode('${id}')">Age:</strong> <span data-field="age" id="age-disp-${id}" contenteditable="${!p.isAutoAge}" onblur="updateField('${id}','age',this.innerText)">${age}</span></p>
             
             <div class="age-toggle" id="age-toggle-${id}">
                <label><input type="radio" name="ageMode-${id}" value="manual" ${!p.isAutoAge?'checked':''} onchange="toggleAutoInputs('${id}')"> Man</label>
                <label><input type="radio" name="ageMode-${id}" value="auto" ${p.isAutoAge?'checked':''} onchange="toggleAutoInputs('${id}')"> Auto</label>
                <div class="auto-age-inputs" id="auto-age-${id}" style="display:${p.isAutoAge?'flex':'none'}">
                   <input type="date" id="dob-${id}" value="${p.dob||''}" onblur="saveAgeMode('${id}')"><input type="time" id="dot-${id}" value="${p.dot||''}" onblur="saveAgeMode('${id}')">
                </div>
             </div>
             
             <p class="inline-fields"><strong>Sex:</strong> <span data-field="sex" contenteditable class="editable" onblur="updateField('${id}','sex',this.innerText)">${p.sex||''}</span></p>
             <p><strong>Weight:</strong> <span data-field="weight" contenteditable class="editable" onblur="updateField('${id}','weight',this.innerText)">${p.weight||''}</span></p>
             <p><strong>Diagnosis:</strong> <span data-field="diagnosis" contenteditable class="editable" onblur="updateField('${id}','diagnosis',this.innerText)">${p.diagnosis||''}</span></p>
             <p><strong>Medications:</strong></p><p><span data-field="medications" contenteditable class="editable" onblur="updateField('${id}','medications',this.innerText)">${p.medications||''}</span></p>
             <p><strong>Issues:</strong> <span data-field="issues" contenteditable class="editable" onblur="updateField('${id}','issues',this.innerText)">${p.issues||''}</span></p>
             
             <p><strong class="hopi-toggle" id="hopi-toggle-btn-${id}" onclick="toggleHopi('${id}')">HOPI:</strong></p>
             <div class="hopi-content" id="hopi-content-${id}">
                <span data-field="hopi" contenteditable class="editable" onblur="updateField('${id}','hopi',this.innerText)">${p.hopi||''}</span>
             </div>
             
             <p style="display:flex; justify-content:space-between; align-items:center;">
                <strong class="hopi-toggle" id="plan-toggle-btn-${id}" onclick="togglePlanHist('${id}')">Plan History:</strong>
                <span class="edit-history-link" id="card-edit-link-${id}" style="display:none;" onclick="toggleEditHistory('${id}', 'card')">Edit</span>
             </p>
             <div class="hopi-content plan-history" id="plan-hist-${id}">
                ${fullHistoryHtml}
             </div>

             <div class="recent-logs-container" id="recent-logs-${id}">
                ${recentHistoryHtml}
             </div>

             <p><strong class="current-plan-label">Current plan:</strong></p>
             <p><span contenteditable class="editable" id="new-plan-${id}" oninput="checkLogInput('${id}')"></span></p>
             
             <button class="log-btn" id="btn-log-${id}" disabled onclick="logPlan('${id}')">Log</button>
             
             <p><strong>Ward:</strong><select onchange="changeWard('${id}',this.value)">${["PW","GW","SW","PVT","ICU","NICU","ER","Discharge"].map(w=>`<option value="${w}" ${w===p.ward?'selected':''}>${w}</option>`).join('')}</select></p>
             <div class="new-checkbox"><label><input type="checkbox" ${p.isNew?'checked':''} onchange="toggleNew('${id}')"> New</label></div>
        `;
        return c;
    }

    function updateCardDOM(c, p) {
        ['name','id','doa','shift','bed','age','sex','weight','diagnosis','medications','issues','hopi'].forEach(f=>{
            const el=c.querySelector(`[data-field="${f}"]`);
            if(el&&document.activeElement!==el) {
                let v=p[f]||''; if(f==='age'&&p.isAutoAge&&p.dob&&p.dot) v=calculateNeonatalAge(p.dob,p.dot).display;
                if(f==='doa') { el.innerText=v; if(el.nextElementSibling)el.nextElementSibling.innerText=`(${calculateDaysAdmitted(v)})`; }
                else if(el.innerText!==v) el.innerText=v;
            }
        });
        const w=c.querySelector('select'); if(w&&document.activeElement!==w) w.value=p.ward;
        const nc=c.querySelector('input[type="checkbox"]'); if(nc) nc.checked=p.isNew;
        const nb=c.querySelector('.new-badge'); if(nb){ if(p.isNew&&!nb.classList.contains('new-active'))nb.classList.add('new-active'); if(!p.isNew)nb.classList.remove('new-active'); }
        
        const histContainer = c.querySelector(`#plan-hist-${p.docId}`);
        const isEditingHistory = histContainer && histContainer.classList.contains('editing-mode');

        if(!isEditingHistory && histContainer) {
            histContainer.innerHTML = formatLogsToHtml(p.logs || '', p.docId, false, true);
        }
        
        const recentContainer = c.querySelector(`#recent-logs-${p.docId}`);
        if(recentContainer) recentContainer.innerHTML = formatLogsToHtml(p.logs || '', p.docId, true, false);
    }

    // --- CARD ACTIONS ---
    function updateField(id,f,v) { db.collection('patients').doc(id).update({[f]:v}); }
    
    function toggleHopi(id) { 
        document.getElementById(`hopi-content-${id}`).classList.toggle('expanded');
        document.getElementById(`hopi-toggle-btn-${id}`).classList.toggle('expanded');
    }
    
    function togglePlanHist(id) { 
        const isExpanded = document.getElementById(`plan-hist-${id}`).classList.toggle('expanded');
        document.getElementById(`plan-toggle-btn-${id}`).classList.toggle('expanded');
        
        const editLink = document.getElementById(`card-edit-link-${id}`);
        if(editLink) editLink.style.display = isExpanded ? 'block' : 'none';
        
        if(!isExpanded) {
            const listEl = document.getElementById(`full-list-${id}`);
            if(listEl && listEl.classList.contains('editing-mode')) {
                toggleEditHistory(id, 'card');
            }
        }
    }
    
    function toggleAgeMode(id) { const e=document.getElementById(`age-toggle-${id}`); e.style.display=e.style.display==='block'?'none':'block'; }
    function toggleAutoInputs(id) { const a=document.querySelector(`#age-toggle-${id} input[value='auto']`).checked; document.getElementById(`auto-age-${id}`).style.display=a?'flex':'none'; document.getElementById(`age-disp-${id}`).contentEditable=!a; saveAgeMode(id); }
    function saveAgeMode(id) { const a=document.querySelector(`#age-toggle-${id} input[value='auto']`).checked, dob=document.getElementById(`dob-${id}`).value, dot=document.getElementById(`dot-${id}`).value, u={isAutoAge:a,dob,dot}; if(a&&dob&&dot) u.age=calculateNeonatalAge(dob,dot).display; db.collection('patients').doc(id).update(u); }
    function changeWard(id,w) { const u={ward:w}; if(w==='Discharge') u.dischargeTimestamp=Date.now(); db.collection('patients').doc(id).update(u); }
    function toggleNew(id) { db.collection('patients').doc(id).get().then(d=>db.collection('patients').doc(id).update({isNew:!d.data().isNew})); }
    function toggleDischarge(w) { document.getElementById(`ward-${w}`).classList.toggle('expanded'); document.getElementById(`header-${w}`).classList.toggle('expanded'); }
    function deletePatient(id) {
       if(confirm("Discharge? OK to discharge, Cancel to DELETE PERMANENTLY.")) changeWard(id,'Discharge');
       else if(confirm("WARNING: Permanently delete record AND X-RAYS?")) {
         db.collection('patients').doc(id).get().then(d=>{
             if(d.exists) { const i=d.data().images||[], ps=i.map(x=>(x.url&&x.url.includes('firebasestorage'))?storage.refFromURL(x.url).delete().catch(e=>console.warn(e)):Promise.resolve());
             Promise.all(ps).finally(()=>db.collection('patients').doc(id).delete()); }
             else db.collection('patients').doc(id).delete();
         });
       }
    }
    
    function logPlan(id) {
        const inputEl = document.getElementById(`new-plan-${id}`);
        const content = inputEl.innerText.trim();
        if(!content) return;
        const p = localPatients[id];
        const ts = formatTimestamp(Date.now());
        const days = calculateDaysAdmitted(p.doa);
        const newEntry = `‚Ä¢ ${ts} (${days})\n ${content}\n\n`;
        const updatedLogs = (p.logs || '') + newEntry;

        db.collection('patients').doc(id).update({
            logs: updatedLogs,
            plan: content, // Update plan for printing compatibility
            lastLoggedPlan: content
        }).then(() => {
            inputEl.innerText = '';
            checkLogInput(id);
        });
    }

    // --- QUICK ADD FORM ---
    function toggleForm() { 
        const f=document.getElementById('formSection'); 
        f.style.display=f.style.display==='block'?'none':'block'; 
        if(f.style.display === 'block') {
            document.getElementById('doa').value = getLocalISODate();
            document.getElementById('shift').value = getCurrentShift();
        }
    }
    function toggleAutoInputsForm() { 
        const el = document.getElementById('form-radio-auto');
        const a = el ? el.checked : false;
        document.getElementById('form-auto-age-inputs').style.display=a?'flex':'none'; 
    }
    function addPatient() {
       const autoRadio = document.getElementById('form-radio-auto');
       const a = autoRadio ? autoRadio.checked : false;
       const dob=document.getElementById('dob').value, dot=document.getElementById('dot').value;
       let age=document.getElementById('age').value; if(a&&dob&&dot) age=calculateNeonatalAge(dob,dot).display;
       db.collection('patients').add({
         name:document.getElementById('name').value, id:document.getElementById('id').value, doa:document.getElementById('doa').value,
         age, dob:dob||'', dot:dot||'', isAutoAge:a, shift:document.getElementById('shift').value, bed:document.getElementById('bed').value,
         sex:document.getElementById('sex').value, weight:document.getElementById('weight').value, diagnosis:document.getElementById('diagnosis').value,
         medications:document.getElementById('medications').value, issues:document.getElementById('issues').value, hopi:document.getElementById('hopi').value,
         ward:document.getElementById('ward').value, plan:document.getElementById('plan').value, isNew:document.getElementById('isNew').checked,
         timestamp:Date.now(), logs:'', lastLoggedPlan:'', labs:{dates:[],tests:{}}, images:[]
       }).then(()=>document.getElementById('formSection').style.display='none');
    }
    function toggleDarkMode() { const h=document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark'); }

    // --- DETAIL MODAL ---
    function openModal(id) {
       currentPatientId=id; const p=localPatients[id]; if(!p)return;
       document.getElementById('detailModal').classList.add('active'); document.getElementById('modalTitle').innerText=`${p.name} - Details`;
       ['name','id','ward','bed','age','sex','weight','diagnosis','medications','issues','hopi'].forEach(f=>{ const e=document.getElementById(`det-${f}`); if(e)e.innerText=p[f]||''; });
       
       const hosp = document.getElementById('det-hosp');
       const nid = document.getElementById('det-nid');
       if(p.id && p.id.includes(',')) {
           const parts = p.id.split(',');
           if(hosp) hosp.innerText = parts[0].trim();
           if(nid) nid.innerText = parts.length > 1 ? parts[1].trim() : '';
       } else {
           if(hosp) hosp.innerText = p.id || '';
           if(nid) nid.innerText = '';
       }

       renderLabMatrix(); renderImages(); renderHistory(); switchTab('details');
    }
    function refreshModalIfOpen() {
       const p=localPatients[currentPatientId]; if(!p)return;
       ['name','id','ward','bed','age','sex','weight','diagnosis','medications','issues','hopi'].forEach(f=>{ const e=document.getElementById(`det-${f}`); if(e&&document.activeElement!==e)e.innerText=p[f]||''; });
       if(document.getElementById('tab-labs').classList.contains('active')) renderLabMatrix();
       if(document.getElementById('tab-imaging').classList.contains('active')) renderImages();
       if(document.getElementById('tab-history').classList.contains('active')) renderHistory();
    }
    function closeModal() { document.getElementById('detailModal').classList.remove('active'); currentPatientId=null; }
    window.onclick = function(e) { if(e.target==document.getElementById('detailModal'))closeModal(); if(e.target==document.getElementById('admissionModal'))closeAdmissionModal(); if(e.target==document.getElementById('lightbox'))closeLightbox(); }
    function switchTab(id) {
       document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
       const btn=Array.from(document.querySelectorAll('.tab-btn')).find(b=>b.getAttribute('onclick').includes(id)); if(btn)btn.classList.add('active');
       document.getElementById(`tab-${id}`).classList.add('active'); if(id==='labs') renderLabMatrix();
    }
    function updateFromDetail(f,v) { if(currentPatientId) db.collection('patients').doc(currentPatientId).update({[f]:v}); }
    
    function updateIdFromDetail() {
        if(!currentPatientId) return;
        const h = document.getElementById('det-hosp').innerText.trim();
        const n = document.getElementById('det-nid').innerText.trim();
        const combined = (h && n) ? `${h}, ${n}` : (h || n || "");
        db.collection('patients').doc(currentPatientId).update({id: combined});
    }

    // --- PRINTING ---
    function printReport(t,wl) {
       const d=document.getElementById('handoverDate').innerText, txt=`HANDOVER REPORT - ${t} - ${d}\n\n`;
       wl.forEach(w=>{
         const l=Object.values(localPatients).filter(p=>p.ward===w);
         if(l.length>0){ 
             txt+=`--- ${w} (${l.length}) ---\n`;
             l.sort((a,b)=>(parseInt(a.bed)||0)-(parseInt(b.bed)||0));
             l.forEach(p=>{ txt+=`BED ${p.bed}: ${p.name} (${p.age}/${p.sex})\n   Dx: ${p.diagnosis}\n   Plan: ${p.plan}\n\n`; });
         }
       });
       const w=window.open('','_blank'); w.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${txt}</pre>`); w.document.close();
    }
    function printAll(){ printReport('ALL',["PW","GW","SW","PVT","ICU","NICU","ER"]); }
    function printNICU(){ printReport('NICU',["NICU"]); }
    function printWard(){ printReport('WARD',["PW","GW","SW","PVT","ICU"]); }
    function printNew(){
       const d=document.getElementById('handoverDate').innerText, txt=`NEW ADMISSIONS - ${d}\n\n`;
       Object.values(localPatients).filter(p=>p.isNew).forEach(p=>{ txt+=`${p.ward} Bed ${p.bed}: ${p.name}\n   ${p.diagnosis}\n   ${p.plan}\n\n`; });
       const w=window.open('','_blank'); w.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${txt}</pre>`); w.document.close();
    }

    // --- LABS & IMAGING ---
    function renderLabMatrix() {
       const p=localPatients[currentPatientId], labs=p.labs||{dates:[],tests:{}}, t=document.getElementById('labMatrix'); t.innerHTML='';
       const thead=document.createElement('thead'), tr=document.createElement('tr');
       let h=`<th></th>`; labs.dates.forEach((d,i)=>h+=`<th><input type="text" value="${d}" onblur="upLabDate(${i},this.value)"></th>`);
       h+=`<th><button class="btn-sm" onclick="addLabCol()">Add Col</button></th>`; tr.innerHTML=h; thead.appendChild(tr); t.appendChild(thead);
       const tbody=document.createElement('tbody');
       Object.keys(labs.tests).forEach(k=>{
           const r=document.createElement('tr'); let c=`<td><input type="text" value="${k}" style="font-weight:bold;" onblur="renTest('${k}',this.value)"></td>`;
           labs.tests[k].forEach((v,i)=>{ c+=`<td><input type="text" value="${v}" onblur="upLabVal('${k}',${i},this.value)"></td>`; });
           c+=`<td></td>`; r.innerHTML=c; tbody.appendChild(r);
       });
       const addRow=document.createElement('tr'); addRow.innerHTML=`<td><button class="btn-sm" onclick="addLabRow()">Add Row</button></td><td colspan="${labs.dates.length+1}"></td>`; tbody.appendChild(addRow); t.appendChild(tbody);
       renderChart(labs);
    }
    function upLabVal(k,i,v){ const p=localPatients[currentPatientId], l=p.labs; l.tests[k][i]=v; db.collection('patients').doc(currentPatientId).update({labs:l}); }
    function upLabDate(i,v){ const p=localPatients[currentPatientId], l=p.labs; l.dates[i]=v; db.collection('patients').doc(currentPatientId).update({labs:l}); }
    function renTest(o,n){ if(o===n)return; const p=localPatients[currentPatientId], l=p.labs, nt={}; Object.keys(l.tests).forEach(k=>{ if(k===o)nt[n]=l.tests[k]; else nt[k]=l.tests[k]; }); l.tests=nt; db.collection('patients').doc(currentPatientId).update({labs:l}); }
    function addLabCol(){ const p=localPatients[currentPatientId], l=p.labs||{dates:[],tests:{}}, t=new Date(); l.dates.push(`${t.getDate()}/${t.getMonth()+1}`); Object.keys(l.tests).forEach(k=>l.tests[k].push("-")); db.collection('patients').doc(currentPatientId).update({labs:l}); }
    function addLabRow(){ const p=localPatients[currentPatientId], l=p.labs||{dates:[],tests:{}}; let n="New Test", c=1; while(l.tests[n]){c++;n=`New Test ${c}`;} l.tests[n]=new Array(l.dates.length).fill("-"); db.collection('patients').doc(currentPatientId).update({labs:l}); }
    function renderChart(l){
       const ctx=document.getElementById('labsChart').getContext('2d'); if(chartInstance)chartInstance.destroy();
       const clr=['#e63946','#2a9d8f','#457b9d','#f4a261']; let ci=0;
       const ds=Object.keys(l.tests).map(k=>{ const d=l.tests[k].map(v=>parseFloat(v)||null); if(d.every(v=>v===null))return null; return {label:k,data:d,borderColor:clr[ci++%4],tension:0.3,spanGaps:true}; }).filter(d=>d);
       chartInstance=new Chart(ctx,{type:'line',data:{labels:l.dates,datasets:ds},options:{responsive:true,maintainAspectRatio:false}});
    }

    function renderImages(){
       const p=localPatients[currentPatientId], g=document.getElementById('img-grid'); g.innerHTML='';
       (p.images||[]).forEach((img,i)=>{
          const d=document.createElement('div'); d.className='img-card';
          d.innerHTML=`<img src="${img.url}" onclick="openLightbox('${img.url}')"><div class="img-caption">${img.caption}</div><button class="img-delete" onclick="delImg(${i})">√ó</button>`;
          g.appendChild(d);
       });
    }
    function addImage(){ 
        const fi=document.getElementById('img-file'), f=fi.files[0], cap=document.getElementById('img-cap').value, btn=document.getElementById('upload-btn');
        if(!f){alert("Select file");return;} btn.disabled=true; btn.innerText="Starting...";
        const ref=storage.ref().child('images/'+currentPatientId+'/'+Date.now()+'_'+f.name);
        const task=ref.put(f);
        task.on('state_changed', s=>{ btn.innerText=`${Math.round((s.bytesTransferred/s.totalBytes)*100)}%`; }, e=>{alert(e.message); btn.disabled=false;}, ()=>{
            task.snapshot.ref.getDownloadURL().then(u=>{
                const p=localPatients[currentPatientId], i=p.images||[]; i.push({url:u,caption:cap||'Image'});
                return db.collection('patients').doc(currentPatientId).update({images:i});
            }).then(()=>{ fi.value=''; document.getElementById('img-cap').value=''; btn.disabled=false; btn.innerText="Upload"; });
        });
    }
    function delImg(i){
        if(!confirm("Delete from storage?"))return;
        const p=localPatients[currentPatientId], img=p.images[i];
        let prom=Promise.resolve();
        if(img.url&&img.url.includes('firebasestorage')) prom=storage.refFromURL(img.url).delete().catch(e=>console.warn(e));
        prom.finally(()=>{ const n=p.images.filter((_,x)=>x!==i); db.collection('patients').doc(currentPatientId).update({images:n}); });
    }
    function openLightbox(u){ document.getElementById('lightbox').style.display='flex'; document.getElementById('lightbox-img').src=u; }
    function closeLightbox(){ document.getElementById('lightbox').style.display='none'; }
    function renderHistory(){
       const p=localPatients[currentPatientId];
       document.getElementById('history-list').innerHTML = formatLogsToHtml(p.logs || '', currentPatientId, false, true);
    }

    const MAP_FORM_PDF = {
       'f-name': 'name', 'f-hosp-no': 'hid', 'f-age': 'age', 'f-sex': 'sex', 'f-ward': 'ward', 'f-bed': 'bed', 'f-doa': 'doa',
       'f-finaldx': 'dx', 'f-plan': 'management', 'f-complaints': 'complains', 
       'f-hopi': 'hopi', 'f-past': 'pasthx', 'f-family': 'fhx', 'f-treatment': 'txhx',
       'f-obs': 'obs', 'f-personal': 'personalhx', 'f-ge': 'ge',
       'f-cvs': 'cvs', 'f-rs': 'rs', 'f-abd': 'pa', 'f-pelvis': 'pelvis', 'f-cns': 'cns', 'f-le': 'le'
    };
    const MAP_PDF_DB = {
       'name':'name', 'hid':'id', 'age':'age', 'sex':'sex', 'ward':'ward', 'bed':'bed', 'doa':'doa',
       'management':'plan', 'complains':'complaint',
       'hopi':'hopi', 'pasthx':'past_history', 'fhx':'family_history', 'txhx':'treatment_history',
       'obs':'obs_history', 'personalhx':'personal_history', 'ge':'general_exam',
       'cvs':'cvs', 'rs':'rs', 'pa':'abdomen', 'pelvis':'pelvis', 'cns':'cns', 'le':'local_exam', 'dx':'diagnosis' 
    };

    const ALLOWED_EDIT_PDF = [
        'dx', 'management', 'complains', 'hopi', 'pasthx', 'fhx',
        'txhx', 'obs', 'personalhx', 'ge', 'cvs', 'rs', 'pa',
        'pelvis', 'cns', 'le'
    ];

    const FIELD_MAX_LINES = {
        'f-hopi': 9, 'f-complaints': 3, 'f-past': 6, 'f-personal': 6, 'f-family': 6, 'f-treatment': 6,
        'f-obs': 6, 'f-ge': 5, 'f-cvs': 5, 'f-rs': 5, 'f-abd': 5, 'f-pelvis': 5, 'f-cns': 5, 'f-le': 5, 'f-plan': 8
    };

    let pdfDoc = null;
    let anchors = {};
    let pdfValues = {};
    let currentMode = 'form';
    let pdfFontSize = 13;
    let pdfLineHeight = 1.3;

    function launchAdmissionSystem() {
       document.getElementById('admission-system').style.display='flex';
       document.querySelectorAll('#admission-system input, #admission-system textarea').forEach(e => e.value = '');
       document.getElementById('f-doa').value = getLocalISODate();
       document.getElementById('f-shift').value = getCurrentShift();
       pdfValues = {}; 
       setMode('form');
       if(!pdfDoc) loadPdfEngine();
       if(Object.keys(anchors).length === 0) fetch(ANCHORS_URL).then(r=>r.json()).then(d=> anchors = d.anchorsByPage || d);
       loadTemplates();
       document.getElementById('admSidebar').classList.remove('show');
    }
    function closeAdmissionSystem() { document.getElementById('admission-system').style.display='none'; }
    
    function setMode(mode) {
       currentMode = mode;
       document.getElementById('btn-mode-form').className = `mode-card ${mode==='form'?'active':''}`;
       document.getElementById('btn-mode-pdf').className = `mode-card ${mode==='pdf'?'active':''}`;
       document.getElementById('view-form').style.display = mode==='form'?'block':'none';
       document.getElementById('view-pdf').style.display = mode==='pdf'?'flex':'none';
       document.getElementById('pdf-controls').style.display = mode==='pdf'?'flex':'none';
       
       if(document.body.classList.contains('is-mobile')) {
           toggleAdmSidebar(); 
       }

       if(mode==='pdf' && document.getElementById('pdf-stage').innerHTML === '') {
           if(pdfDoc) renderPdfVisual(); 
       }
    }

    function toggleAdmSidebar() {
        document.getElementById('admSidebar').classList.toggle('show');
    }

    function toggleAdmAutoInputs() { 
       const el = document.getElementById('adm-radio-auto');
       const a = el ? el.checked : false;
       document.getElementById('adm-auto-age-inputs').style.display = a ? 'flex' : 'none'; 
    }

    async function loadPdfEngine() {
       try {
         const pdfBytes = await fetch(PDF_URL).then(r=>r.arrayBuffer());
         pdfDoc = await pdfjsLib.getDocument(pdfBytes).promise;
         if(currentMode==='pdf') renderPdfVisual();
         document.getElementById('pdf-loading').style.display='none';
       } catch(e) { console.error("PDF Load Error", e); }
    }

    function updateVisualField(pdfKey, value) {
       pdfValues[pdfKey] = value;
    }
    
    function syncDx(val, fromBottom) {
       if (fromBottom) {
           document.getElementById('f-adm-dx').value = val;
       } else {
           document.getElementById('f-finaldx').value = val;
       }
       pdfValues['dx'] = val;
    }

    function checkOverflow(fieldId) {
        if (fieldId !== 'f-hopi') return;

        const pdfKey = MAP_FORM_PDF[fieldId];
        if(!pdfKey) return;
        
        let targetAnchor = null;
        Object.values(anchors).forEach(pageAnchors => {
            const found = pageAnchors.find(a => a.name === pdfKey);
            if(found) targetAnchor = found;
        });
        
        if(!targetAnchor) return;

        const maxLines = FIELD_MAX_LINES[fieldId] || 9;
        const text = document.getElementById(fieldId).value;
        const warnEl = document.getElementById('warn-' + fieldId);
        
        const canvas = document.createElement('canvas'); 
        const ctx = canvas.getContext('2d');
        const fontSize = 9; 
        ctx.font = `${fontSize}px Helvetica`; 
        
        const pageWidth = 595; 
        const boxW = targetAnchor.w * pageWidth; 
        
        const words = text.split(' '); 
        let lineCount = 1; 
        let currentLineW = 0;
        
        for(const word of words) {
           if(word.includes('\n')) {
               const parts = word.split('\n');
               const firstW = ctx.measureText(parts[0] + ' ').width;
               if (currentLineW + firstW > boxW) { lineCount++; }
               
               for(let k=1; k<parts.length; k++) {
                   lineCount++;
                   const partW = ctx.measureText(parts[k] + ' ').width;
                   if(partW > boxW) {
                        lineCount += Math.floor(partW / boxW);
                        currentLineW = partW % boxW;
                   } else {
                        currentLineW = partW;
                   }
               }
               continue;
           }

           const wordW = ctx.measureText(word + ' ').width;
           if (currentLineW + wordW > boxW) { 
               lineCount++; 
               currentLineW = wordW; 
           } else { 
               currentLineW += wordW; 
           }
        }
        
        if(lineCount > maxLines) {
            if(warnEl) {
                warnEl.style.display = 'block';
                warnEl.innerText = `‚ö†Ô∏è Text limit exceeded: ${lineCount}/${maxLines} lines`;
            }
        } else {
            if(warnEl) warnEl.style.display = 'none';
        }
    }

    async function renderPdfVisual() {
       const stage = document.getElementById('pdf-stage'); stage.innerHTML = ''; 
       const container = document.getElementById('view-pdf');
       const containerW = container.clientWidth || window.innerWidth;
       const p1 = await pdfDoc.getPage(1);
       const v1 = p1.getViewport({ scale: 1 });
       const margin = 20;
       
       const availableWidth = Math.min(containerW, 850);
       const scaleFit = (availableWidth - margin) / v1.width; 

       for(let i=1; i<=pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: scaleFit }); 
          const wrapper = document.createElement('div');
          wrapper.className = 'pdf-page'; 
          
          wrapper.style.width = viewport.width + 'px'; 
          wrapper.style.height = viewport.height + 'px';
          
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          canvas.className = 'pdf-canvas';
          await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
          wrapper.appendChild(canvas);
          if(anchors[i]) {
             anchors[i].forEach(a => {
                const box = document.createElement('div');
                box.className = 'pdf-box'; 
                
                if(ALLOWED_EDIT_PDF.includes(a.name)) {
                    box.contentEditable = true;
                } else {
                    box.contentEditable = false;
                    box.style.backgroundColor = 'rgba(200, 200, 200, 0.15)';
                    box.title = "Edit in Sidebar";
                }

                box.style.left = (a.x * 100) + '%'; 
                box.style.top = (a.y * 100) + '%'; 
                
                box.style.width = (a.w * 100) + '%'; box.style.height = (a.h * 100) + '%';
                box.style.fontSize = (pdfFontSize * scaleFit) + 'px'; box.style.lineHeight = pdfLineHeight;
                box.innerText = pdfValues[a.name] || '';
                if(box.contentEditable === "true") {
                    box.oninput = (e) => { pdfValues[a.name] = e.target.innerText; };
                }
                wrapper.appendChild(box);
             });
          }
          stage.appendChild(wrapper);
       }
    }
    
    function changePdfFont(val) { pdfFontSize = parseInt(val); renderPdfVisual(); }
    function changePdfLineHeight(val) { pdfLineHeight = parseFloat(val); renderPdfVisual(); }

    function syncFormToPdf() {
       Object.keys(MAP_FORM_PDF).forEach(fid => {
           const el = document.getElementById(fid);
           if(el) { pdfValues[MAP_FORM_PDF[fid]] = el.value || ''; }
       });
    }
    
    function syncPdfToForm() {
       Object.keys(MAP_FORM_PDF).forEach(fid => {
           const pdfKey = MAP_FORM_PDF[fid];
           if (pdfValues[pdfKey] !== undefined) {
               const el = document.getElementById(fid);
               if(el) el.value = pdfValues[pdfKey];
           }
       });
    }

    function openAdmissionForPatient() {
        if(!currentPatientId || !localPatients[currentPatientId]) return;
        const p = localPatients[currentPatientId];
        launchAdmissionSystem(); 
        if(p.admissionData) {
            pdfValues = { ...p.admissionData };
            Object.keys(MAP_FORM_PDF).forEach(fid => {
                const pdfKey = MAP_FORM_PDF[fid];
                if(pdfValues[pdfKey]) { const el = document.getElementById(fid); if(el) el.value = pdfValues[pdfKey]; }
            });
            if(p.id && p.id.includes(',')) {
                const parts = p.id.split(',');
                if(parts.length >= 2) {
                    document.getElementById('f-hosp-no').value = parts[0].trim();
                    document.getElementById('f-nid-no').value = parts[1].trim();
                }
            } else {
                document.getElementById('f-hosp-no').value = p.id || '';
            }
            if(p.diagnosis) {
                document.getElementById('f-adm-dx').value = p.diagnosis;
                document.getElementById('f-finaldx').value = p.diagnosis;
            }
        } else {
            document.getElementById('f-name').value = p.name || '';
            document.getElementById('f-hosp-no').value = p.id || '';
            document.getElementById('f-doa').value = p.doa || '';
            document.getElementById('f-shift').value = p.shift || 'Morning';
            document.getElementById('f-ward').value = p.ward || 'PW';
            document.getElementById('f-bed').value = p.bed || '';
            document.getElementById('f-age').value = p.age || '';
            document.getElementById('f-sex').value = p.sex || 'Male';
            document.getElementById('f-weight').value = p.weight || '';
            document.getElementById('f-finaldx').value = p.diagnosis || '';
            document.getElementById('f-adm-dx').value = p.diagnosis || '';
            document.getElementById('f-plan').value = p.plan || '';
        }
        syncFormToPdf(); closeModal(); 
    }

    function calculateOptimalFontSize(minSize, maxSize) {
       if(Object.keys(anchors).length === 0) return maxSize;
       const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
       const checkFit = (size) => {
         ctx.font = `${size}px Helvetica`; const lineHeight = size * pdfLineHeight;
         for(const pageNum in anchors) {
             for(const a of anchors[pageNum]) {
                const text = String(pdfValues[a.name] || '').trim(); if(!text) continue;
                const pageWidth = 595; const pageHeight = 842;
                const boxW = a.w * pageWidth; const boxH = a.h * pageHeight;
                const words = text.split(' '); let lineCount = 1; let currentLineW = 0;
                for(const word of words) {
                   const wordW = ctx.measureText(word + ' ').width;
                   if (currentLineW + wordW > boxW) { lineCount++; currentLineW = wordW; } else { currentLineW += wordW; }
                }
                const totalH = lineCount * lineHeight; if(totalH > boxH) return false;
             }
         }
         return true;
       };
       for (let s = maxSize; s >= minSize; s--) { if (checkFit(s)) return s; }
       return minSize; 
    }

    async function saveAndAdd() {
       const printWin = window.open('', '_blank');
       if (printWin) {
           printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h2>Saving & Generating PDF...</h2></body></html>');
       } else {
           alert("Please allow popups to print.");
           return;
       }

       if (currentMode === 'pdf') { syncPdfToForm(); } else { syncFormToPdf(); }
       
       const p = { timestamp: Date.now(), isNew: true, logs: '', lastLoggedPlan: '', labs: {dates:[], tests:{}}, images: [] };
       
       const rawName = document.getElementById('f-name').value || "Unknown";
       const hospNo = document.getElementById('f-hosp-no').value || "";
       const nidNo = document.getElementById('f-nid-no').value || "";
       const combinedId = (hospNo && nidNo) ? `${hospNo}, ${nidNo}` : (hospNo || nidNo || "");

       const rawAge = document.getElementById('f-age').value || "?";
       const rawSex = document.getElementById('f-sex').value || "Male";
       const rawWard = document.getElementById('f-ward').value || "PW";
       const rawBed = document.getElementById('f-bed').value || "";
       
       p.name = rawName;
       p.id = combinedId;
       p.bed = rawBed;
       p.ward = rawWard;
       p.sex = rawSex;
       p.isNew = true; 

       let isAuto = false;
       const autoRadio = document.getElementById('adm-radio-auto');
       if(autoRadio) isAuto = autoRadio.checked;
       const dob = document.getElementById('f-dob').value;
       const dot = document.getElementById('f-dot').value;
       if (isAuto && dob && dot) {
          p.age = calculateNeonatalAge(dob, dot).display; 
          p.dob = dob; p.dot = dot; p.isAutoAge = true; 
       } else { 
          p.age = rawAge; 
       }

       pdfValues['age'] = `${p.age} / ${p.sex}`;
       pdfValues['hid'] = hospNo;
       pdfValues['ward'] = p.ward;
       pdfValues['bed'] = p.bed;
       pdfValues['name'] = p.name;
       pdfValues['nid'] = formatTimestamp(Date.now());
       
       p.doa = document.getElementById('f-doa').value || getLocalISODate();
       p.shift = document.getElementById('f-shift').value || 'Morning';
       p.weight = document.getElementById('f-weight').value || '';
       p.admissionData = { ...pdfValues };
       
       Object.keys(MAP_PDF_DB).forEach(pk => { 
           if(!p[MAP_PDF_DB[pk]] && pdfValues[pk]) { p[MAP_PDF_DB[pk]] = pdfValues[pk]; }
       });
       
       let aggregatedHopi = "";
       const addLine = (label, val) => { if(val && val.trim()) aggregatedHopi += `${label}:\n${val.trim()}\n\n`; };
       addLine("C/O", pdfValues['complains']); addLine("HOPI", pdfValues['hopi']); addLine("Past Hx", pdfValues['pasthx']);
       addLine("Personal Hx", pdfValues['personalhx']); addLine("Family Hx", pdfValues['fhx']); addLine("Tx Hx", pdfValues['txhx']);
       addLine("Obs/Gyn", pdfValues['obs']); addLine("G/E", pdfValues['ge']); addLine("CVS", pdfValues['cvs']);
       addLine("RS", pdfValues['rs']); addLine("Abd", pdfValues['pa']); addLine("Pelvis", pdfValues['pelvis']);
       addLine("CNS", pdfValues['cns']); addLine("Local", pdfValues['le']);
       
       p.hopi = aggregatedHopi; 
       p.diagnosis = pdfValues['dx'] || ""; 
       p.plan = pdfValues['management'] || "";
       const note = `ADMISSION GENERATED:\n${aggregatedHopi}\nDx: ${p.diagnosis}`;
       p.logs = `‚Ä¢ ${formatTimestamp(Date.now())}\n ${note}\n\n`;

       const cleanP = JSON.parse(JSON.stringify(p));

       try {
           await db.collection('patients').add(cleanP);
       } catch (dbError) {
           alert("CRITICAL ERROR: Could not save patient to database.\n" + dbError.message);
           if(printWin) printWin.close();
           return; 
       }

       try {
           await generatePdfBlob(currentMode === 'form', printWin);
       } catch (pdfError) {
           console.error(pdfError);
           if (printWin) {
               printWin.document.body.innerHTML = "<h2 style='color:red'>PDF Generation Failed</h2><p>The patient was saved to the dashboard, but the PDF could not be created.</p>";
           }
           alert("Patient saved successfully, but PDF generation failed.");
       }

       closeAdmissionSystem();
       pdfValues={}; 
       document.querySelectorAll('#view-form input, #view-form textarea').forEach(e=>e.value=''); 
       document.getElementById('f-complaints').value=''; 
    }
    
    async function printOnly() {
       const printWin = window.open('', '_blank');
       if(printWin) { printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;"><h2>Generating PDF... Please wait.</h2></body></html>'); } 
       else { alert("Please allow popups to print."); }
       
       if(currentMode==='form') syncFormToPdf();
       
       const hospNo = document.getElementById('f-hosp-no').value || "";
       const rawWard = document.getElementById('f-ward').value || "";
       const rawBed = document.getElementById('f-bed').value || "";
       const rawAge = document.getElementById('f-age').value || "?";
       const rawSex = document.getElementById('f-sex').value || "Male";
       
       pdfValues['hid'] = hospNo;
       pdfValues['ward'] = rawWard;
       pdfValues['bed'] = rawBed;
       pdfValues['age'] = `${rawAge} / ${rawSex}`;
       pdfValues['nid'] = formatTimestamp(Date.now());

       await generatePdfBlob(currentMode === 'form', printWin);
    }

    async function printRequestOnly() {
        if(currentMode === 'form') syncFormToPdf(); else syncPdfToForm();

        const printWin = window.open('', '_blank');
        if(!printWin) { alert("Please allow popups."); return; }
        printWin.document.write('<html><body style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><h2>Filling Admission Request...</h2></body></html>');

        try {
            const bytes = await fetch(REQUEST_URL).then(r => r.arrayBuffer());
            const pdf = await PDFLib.PDFDocument.load(bytes);
            const form = pdf.getForm();
            const fieldMap = {
                'Text21': pdfValues['name'] || document.getElementById('f-name').value,        
                'Text20': document.getElementById('f-hosp-no').value,                        
                'Text23': document.getElementById('f-nid-no').value,                          
                'Text22': pdfValues['ward'] || document.getElementById('f-ward').value,      
                'Text24': pdfValues['bed'] || document.getElementById('f-bed').value,        
                'Text27': pdfValues['doa'] || document.getElementById('f-doa').value,        
                'Text29': document.getElementById('f-adm-dx').value                          
            };
            Object.keys(fieldMap).forEach(fieldName => {
                try {
                    const field = form.getTextField(fieldName);
                    if (field) {
                        const val = fieldMap[fieldName] || '';
                        field.setText(String(val));
                    }
                } catch (err) {
                    console.warn(`Field '${fieldName}' not found in PDF. Ignoring.`);
                }
            });

            const pdfOut = await pdf.save();
            const blob = new Blob([pdfOut], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            printWin.location.href = url;

        } catch (e) {
            console.error(e);
            printWin.document.body.innerHTML = "Error: " + e.message;
        }
    }

    async function generatePdfBlob(autoFit, targetWindow) {
       try {
           const bytes = await fetch(PDF_URL).then(r=>r.arrayBuffer());
           const pdf = await PDFLib.PDFDocument.load(bytes);
           const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
           const pages = pdf.getPages();
           
           let useFontSize = pdfFontSize; 
           if(autoFit) { 
               useFontSize = calculateOptimalFontSize(9, 14); 
           }
           
           Object.keys(anchors).forEach(pNum => {
              if(!pages[pNum-1]) return; const page = pages[pNum-1]; const { width, height } = page.getSize();
              anchors[pNum].forEach(a => {
                 const rawVal = pdfValues[a.name]; 
                 let text = (rawVal === null || rawVal === undefined) ? '' : String(rawVal).trim();
                 text = text.replace(/[\u2010-\u2015]/g, "-").replace(/[^\x00-\x7F]/g, "");
                 
                 if(!text) return; 
                 let fs = autoFit ? useFontSize : pdfFontSize;
                 page.drawText(text, { x: a.x * width + 2, y: height - (a.y * height) - fs, size: fs, font: font, maxWidth: (a.w * width) - 4, lineHeight: fs * pdfLineHeight });
              });
           });
           const pdfOut = await pdf.save();
           const blob = new Blob([pdfOut], { type: 'application/pdf' });
           const url = URL.createObjectURL(blob);
           if (targetWindow && !targetWindow.closed) { targetWindow.location.href = url; } 
           else { window.open(url, '_blank'); }
       } catch (e) { 
           throw e; 
       }
    }

    function saveTemplate() {
       const name = prompt("Template Name:");
       if(name) { db.collection('admissions').add({ type:'template', name, values: {...pdfValues} }).then(loadTemplates); }
    }
    function loadTemplates() {
       db.collection('admissions').where('type','==','template').onSnapshot(snap => {
          const list = document.getElementById('template-list'); list.innerHTML='';
          snap.forEach(doc => {
             const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #eee'; d.style.cursor='pointer';
             d.innerHTML = `<span>${doc.data().name}</span> <span style="float:right;color:red;">√ó</span>`;
             d.onclick = (e) => { if(e.target.innerText==='√ó') { e.stopPropagation(); db.collection('admissions').doc(doc.id).delete(); return; } pdfValues = { ...doc.data().values }; setMode('pdf'); renderPdfVisual(); };
             list.appendChild(d);
          });
       });
    }
  </script>
</body>
</html>
